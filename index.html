<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeneGan Plus — Gestión Ganadera</title>
      <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzE2YTM0YSIvPgo8ZWxsaXBzZSBjeD0iMTYiIGN5PSIyMCIgcng9IjEwIiByeT0iOCIgZmlsbD0iI0Y1REVCMiIvPgo8ZWxsaXBzZSBjeD0iMTYiIGN5PSIxMiIgcng9IjYiIHJ5PSI1IiBmaWxsPSIjRjVERUIyIi8+CjxlbGxpcHNlIGN4PSIxMSIgY3k9IjkiIHJ4PSIxLjUiIHJ5PSIyLjUiIGZpbGw9IiM4QjQ1MTMiIHRyYW5zZm9ybT0icm90YXRlKC0yMCAxMSA5KSIvPgo8ZWxsaXBzZSBjeD0iMjEiIGN5PSI5IiByeD0iMS41IiByeT0iMi41IiBmaWxsPSIjOEI0NTEzIiB0cmFuc2Zvcm09InJvdGF0ZSgyMCAyMSA5KSIvPgo8Y2lyY2xlIGN4PSIxNCIgY3k9IjExIiByPSIxLjIiIGZpbGw9IiMwMDAwMDAiLz4KPGNpcmNsZSBjeD0iMTgiIGN5PSIxMSIgcj0iMS4yIiBmaWxsPSIjMDAwMDAwIi8+CjxjaXJjbGUgY3g9IjE0LjMiIGN5PSIxMC43IiByPSIwLjQiIGZpbGw9IndoaXRlIi8+CjxjaXJjbGUgY3g9IjE4LjMiIGN5PSIxMC43IiByPSIwLjQiIGZpbGw9IndoaXRlIi8+CjxlbGxpcHNlIGN4PSIxNiIgY3k9IjE0IiByeD0iMS44IiByeT0iMS4yIiBmaWxsPSIjRkY2QjZCIi8+CjxlbGxpcHNlIGN4PSIxNS41IiBjeT0iMTMuOCIgcng9IjAuMyIgcnk9IjAuNCIgZmlsbD0iI0U3NDNDQyIvPgo8ZWxsaXBzZSBjeD0iMTYuNSIgY3k9IjEzLjgiIHJ4PSIwLjMiIHJ5PSIwLjQiIGZpbGw9IiNFNzQzQ0MiLz4KPHBhdGggZD0iTTE0IDE1LjUgUTE2IDE2LjUgMTggMTUuNSIgc3Ryb2tlPSIjOEI0NTEzIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiLz4KPHBhdGggZD0iTTEyIDcgUTEwIDUgOCA3IiBzdHJva2U9IiM4QjQ1MTMiIHN0cm9rZS13aWR0aD0iMS41IiBmaWxsPSJub25lIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHBhdGggZD0iTTIwIDcgUTIyIDUgMjQgNyIgc3Ryb2tlPSIjOEI0NTEzIiBzdHJva2Utd2lkdGg9IjEuNSIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CjxlbGxpcHNlIGN4PSIxMyIgY3k9IjE4IiByeD0iMiIgcnk9IjEuNSIgZmlsbD0iIzAwMDAwMCIgb3BhY2l0eT0iMC43Ii8+CjxlbGxpcHNlIGN4PSIxOSIgY3k9IjE4IiByeD0iMiIgcnk9IjEuNSIgZmlsbD0iIzAwMDAwMCIgb3BhY2l0eT0iMC43Ii8+CjxlbGxpcHNlIGN4PSIxNiIgY3k9IjIyIiByeD0iMS41IiByeT0iMiIgZmlsbD0iIzAwMDAwMCIgb3BhY2l0eT0iMC43Ii8+CjxlbGxpcHNlIGN4PSIxMSIgY3k9IjI0IiByeD0iMSIgcnk9IjEuNSIgZmlsbD0iIzAwMDAwMCIgb3BhY2l0eT0iMC43Ii8+CjxlbGxpcHNlIGN4PSIyMSIgY3k9IjI0IiByeD0iMSIgcnk9IjEuNSIgZmlsbD0iIzAwMDAwMCIgb3BhY2l0eT0iMC43Ii8+CjxyZWN0IHg9IjEyIiB5PSIyNiIgd2lkdGg9IjEuNSIgaGVpZ2h0PSI0IiBmaWxsPSIjOEI0NTEzIi8+CjxyZWN0IHg9IjE4LjUiIHk9IjI2IiB3aWR0aD0iMS41IiBoZWlnaHQ9IjQiIGZpbGw9IiM4QjQ1MTMiLz4KPHJlY3QgeD0iMTQiIHk9IjI2IiB3aWR0aD0iMS41IiBoZWlnaHQ9IjQiIGZpbGw9IiM4QjQ1MTMiLz4KPHJlY3QgeD0iMjAuNSIgeT0iMjYiIHdpZHRoPSIxLjUiIGhlaWdodD0iNCIgZmlsbD0iIzhCNDUxMyIvPgo8L3N2Zz4K" type="image/svg+xml">
  <meta name="theme-color" content="#16a34a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="GeneGan Plus" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMxNmEzNGEiLz4KPGVsbGlwc2UgY3g9Ijk2IiBjeT0iMTIwIiByeD0iNjAiIHJ5PSI0OCIgZmlsbD0iI0Y1REVCMiIvPgo8ZWxsaXBzZSBjeD0iOTYiIGN5PSI3MiIgcng9IjM2IiByeT0iMzAiIGZpbGw9IiNGNURFQjIiLz4KPGVsbGlwc2UgY3g9IjY2IiBjeT0iNTQiIHJ4PSI5IiByeT0iMTUiIGZpbGw9IiM4QjQ1MTMiIHRyYW5zZm9ybT0icm90YXRlKC0yMCA2NiA1NCkiLz4KPGVsbGlwc2UgY3g9IjEyNiIgY3k9IjU0IiByeD0iOSIgcnk9IjE1IiBmaWxsPSIjOEI0NTEzIiB0cmFuc2Zvcm09InJvdGF0ZSgyMCAxMjYgNTQpIi8+CjxjaXJjbGUgY3g9Ijg0IiBjeT0iNjYiIHI9IjcuMiIgZmlsbD0iIzAwMDAwMCIvPgo8Y2lyY2xlIGN4PSIxMDgiIGN5PSI2NiIgcj0iNy4yIiBmaWxsPSIjMDAwMDAwIi8+CjxjaXJjbGUgY3g9Ijg1LjgiIGN5PSI2NC4yIiByPSIyLjQiIGZpbGw9IndoaXRlIi8+CjxjaXJjbGUgY3g9IjEwOS44IiBjeT0iNjQuMiIgcj0iMi40IiBmaWxsPSJ3aGl0ZSIvPgo8ZWxsaXBzZSBjeD0iOTYiIGN5PSI4NCIgcng9IjEwLjgiIHJ5PSI3LjIiIGZpbGw9IiNGRjZCNkIiLz4KPGVsbGlwc2UgY3g9IjkzIiBjeT0iODIuOCIgcng9IjEuOCIgcnk9IjIuNCIgZmlsbD0iI0U3NDNDQyIvPgo8ZWxsaXBzZSBjeD0iOTkiIGN5PSI4Mi44IiByeD0iMS44IiByeT0iMi40IiBmaWxsPSIjRTc0M0NDIi8+CjxwYXRoIGQ9Ijg0IDkzIFE5NiA5OSAxMDggOTMiIHN0cm9rZT0iIzhCNDUxMyIgc3Ryb2tlLXdpZHRoPSI2IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9IjcyIDQyIFE2MCAzMCA0OCA0MiIgc3Ryb2tlPSIjOEI0NTEzIiBzdHJva2Utd2lkdGg9IjkiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8cGF0aCBkPSIxMjAgNDIgUTEzMiAzMCAxNDQgNDIiIHN0cm9rZT0iIzhCNDUxMyIgc3Ryb2tlLXdpZHRoPSI5IiBmaWxsPSJub25lIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPGVsbGlwc2UgY3g9Ijc4IiBjeT0iMTA4IiByeD0iMTIiIHJ5PSI5IiBmaWxsPSIjMDAwMDAwIiBvcGFjaXR5PSIwLjciLz4KPGVsbGlwc2UgY3g9IjExNCIgY3k9IjEwOCIgcng9IjEyIiByeT0iOSIgZmlsbD0iIzAwMDAwMCIgb3BhY2l0eT0iMC43Ii8+CjxlbGxpcHNlIGN4PSI5NiIgY3k9IjEzMiIgcng9IjkiIHJ5PSIxMiIgZmlsbD0iIzAwMDAwMCIgb3BhY2l0eT0iMC43Ii8+CjxlbGxpcHNlIGN4PSI2NiIgY3k9IjE0NCIgcng9IjYiIHJ5PSI5IiBmaWxsPSIjMDAwMDAwIiBvcGFjaXR5PSIwLjciLz4KPGVsbGlwc2UgY3g9IjEyNiIgY3k9IjE0NCIgcng9IjYiIHJ5PSI5IiBmaWxsPSIjMDAwMDAwIiBvcGFjaXR5PSIwLjciLz4KPHJlY3QgeD0iNzIiIHk9IjE1NiIgd2lkdGg9IjkiIGhlaWdodD0iMjQiIGZpbGw9IiM4QjQ1MTMiLz4KPHJlY3QgeD0iMTExIiB5PSIxNTYiIHdpZHRoPSI5IiBoZWlnaHQ9IjI0IiBmaWxsPSIjOEI0NTEzIi8+CjxyZWN0IHg9Ijg0IiB5PSIxNTYiIHdpZHRoPSI5IiBoZWlnaHQ9IjI0IiBmaWxsPSIjOEI0NTEzIi8+CjxyZWN0IHg9IjEyMyIgeT0iMTU2IiB3aWR0aD0iOSIgaGVpZ2h0PSIyNCIgZmlsbD0iIzhCNDUxMyIvPgo8L3N2Zz4K" />
  <!-- Librerías para funcionalidades avanzadas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Mapa gratuito usando OpenStreetMap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- ECharts para gráficos y estadísticas -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    /* =====================
       Estilos base (look & feel GeneGan)
       ===================== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green-700: #166534;
      --green-600: #16a34a;
      --green-500: #22c55e;
      --amber-500: #f59e0b;
      --amber-600: #d97706;
      --blue-600: #2563eb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --text: #0f172a;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #fef3c7 100%);
      color: var(--text);
      min-height: 100vh;
    }

    /* Pantalla de bienvenida */
    .welcome-screen {
      position: fixed; inset: 0; z-index: 1000;
      background: linear-gradient(135deg, var(--green-600), var(--amber-600), var(--green-600));
      display: flex; align-items: center; justify-content: center;
      animation: slideIn 0.8s ease-out;
    }
    .welcome-content { text-align: center; color: white; max-width: 640px; padding: 40px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.3); background: rgba(255,255,255,.1); }
    .welcome-logo { width: 120px; height: 120px; margin: 0 auto 24px; border-radius: 50%; display: grid; place-items: center; font-size: 60px; background: rgba(255,255,255,.2); animation: pulse 2s infinite; }
    .start-btn { cursor: pointer; margin-top: 16px; padding: 14px 28px; border-radius: 999px; border: 0; color: #fff; font-weight: 700; letter-spacing: .5px; background: linear-gradient(45deg, var(--green-600), var(--green-500)); box-shadow: 0 10px 30px rgba(22,163,74,.35); transition: .3s; }
    .start-btn:hover { transform: translateY(-3px); }

    /* Header */
    header { background: #fff; border-bottom: 4px solid var(--green-600); box-shadow: 0 4px 10px rgba(0,0,0,.06); }
    .header-content { max-width: 1200px; margin: 0 auto; padding: 16px; display: flex; gap: 16px; align-items: center; justify-content: space-between; }
    .logo { width: 56px; height: 56px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; border: 3px solid #86efac; background: linear-gradient(135deg, #dcfce7, #bbf7d0); position: relative; overflow: hidden; }
    .farm-name { font-size: 22px; font-weight: 800; color: var(--green-700); border: none; outline: none; background: transparent; }
    .farm-subtitle { color: var(--green-600); font-weight: 600; font-size: 12px; }

    /* Nav */
    nav { position: sticky; top: 0; z-index: 50; background: linear-gradient(135deg, #15803d, #166534); color: #fff; box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .nav-content { max-width: 1200px; margin: 0 auto; display: flex; gap: 8px; padding: 0 8px; overflow-x: auto; }
    .nav-button { appearance: none; border: none; background: transparent; color: #fff; padding: 14px 16px; font-weight: 700; cursor: pointer; border-bottom: 4px solid transparent; display: flex; gap: 8px; align-items: center; white-space: nowrap; }
    .nav-button:hover { background: rgba(255,255,255,.08); }
    .nav-button.active { background: linear-gradient(135deg, #14532d, #166534); border-bottom-color: #fbbf24; }

    /* Layout */
    main { max-width: 1200px; margin: 0 auto; padding: 24px 12px; }
    .tab { display: none; }
    .tab.active { display: block; animation: fadeIn .4s ease; }

    /* Cards y formularios */
    .card { background: #fff; border-radius: 16px; padding: 24px; margin: 16px 0; border-left: 6px solid var(--green-600); box-shadow: 0 10px 30px rgba(0,0,0,.06); position: relative; overflow: hidden; }
    .card h2 { display: flex; align-items: center; gap: 10px; color: var(--green-700); margin-bottom: 16px; }
    .grid { display: grid; gap: 16px; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    label { font-weight: 700; color: #065f46; font-size: 13px; }
    input[type="text"], input[type="number"], input[type="date"], select, textarea { width: 100%; padding: 12px 14px; border-radius: 12px; border: 2px solid #86efac; outline: none; background: #fff; transition: .2s; }
    textarea { min-height: 80px; }
    input:focus, select:focus, textarea:focus { border-color: var(--green-600); box-shadow: 0 0 0 4px rgba(22,163,74,.12); transform: translateY(-2px); }

    .btn { cursor: pointer; appearance: none; border: none; padding: 12px 18px; border-radius: 14px; font-weight: 800; letter-spacing: .3px; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 10px 24px rgba(0,0,0,.08); transition: .25s; }
    .btn-primary { background: linear-gradient(135deg, var(--green-600), var(--green-500)); color: #fff; }
    .btn-amber { background: linear-gradient(135deg, var(--amber-600), var(--amber-500)); color: #fff; }
    .btn-blue { background: linear-gradient(135deg, #1d4ed8, var(--blue-600)); color: #fff; }
    .btn-red { background: linear-gradient(135deg, #dc2626, #ef4444); color: #fff; }
    .btn-green { background: linear-gradient(135deg, #059669, #10b981); color: #fff; }
    .btn-ghost { background: #fff; border: 2px solid var(--gray-300); }
    .btn:hover { transform: translateY(-3px); }

    .table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
    .table th, .table td { padding: 10px 12px; border-bottom: 1px solid var(--gray-200); text-align: left; }
    .table th { background: #ecfeff; color: #075985; font-size: 13px; text-transform: uppercase; letter-spacing: .3px; }

    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .pill-green { background: #dcfce7; color: #166534; }
    .pill-amber { background: #fef3c7; color: #92400e; }

    .photo { width: 52px; height: 52px; object-fit: cover; border-radius: 10px; border: 2px solid #bbf7d0; }
    .hidden { display: none !important; }

    /* Modales */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; width: min(680px, 92vw); max-height: 88vh; overflow: auto; padding: 24px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.2); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }

    /* Sistema de notificaciones */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      max-width: 400px;
    }
    
    .notification {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      border-left: 4px solid #16a34a;
      transform: translateX(100%);
      animation: slideInNotification 0.3s ease forwards;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .notification.success { border-left-color: #16a34a; }
    .notification.warning { border-left-color: #f59e0b; }
    .notification.error { border-left-color: #dc2626; }
    .notification.info { border-left-color: #2563eb; }
    
    .notification-icon {
      font-size: 20px;
      margin-top: 2px;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 700;
      margin-bottom: 4px;
      color: #1f2937;
    }
    
    .notification-message {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.4;
    }
    
    .notification-close {
      background: none;
      border: none;
      font-size: 18px;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    @keyframes slideInNotification {
      to { transform: translateX(0); }
    }
    
    @keyframes slideOutNotification {
      to { transform: translateX(100%); }
    }

    /* Animaciones */
    @keyframes slideIn { from { opacity: 0; transform: translateY(-30px);} to { opacity: 1; transform: translateY(0);} }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    @keyframes pulse { 0%,100%{ transform: scale(1);} 50%{ transform: scale(1.05);} }

    /* Responsive */
    @media (max-width: 720px){ .grid-3{ grid-template-columns: 1fr; } .grid-2{ grid-template-columns: 1fr; } }

    /* Estilos para nuevas funcionalidades */
    .dropdown-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .dropdown-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 2px solid #86efac;
      outline: none;
      background: #fff;
      transition: .2s;
      cursor: pointer;
    }
    
    .dropdown-input:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }
    
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #86efac;
      border-top: none;
      border-radius: 0 0 12px 12px;
      max-height: 200px;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 1000;
      display: none;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      /* Mejorar scrolling */
      scrollbar-width: thin;
      scrollbar-color: #86efac #f3f4f6;
      /* Prevenir que el scroll del documento afecte el dropdown */
      overscroll-behavior: contain;
    }
    
    /* Estilos para scrollbar en WebKit browsers */
    .dropdown-list::-webkit-scrollbar {
      width: 8px;
    }
    
    .dropdown-list::-webkit-scrollbar-track {
      background: #f3f4f6;
      border-radius: 4px;
    }
    
    .dropdown-list::-webkit-scrollbar-thumb {
      background: #86efac;
      border-radius: 4px;
    }
    
    .dropdown-list::-webkit-scrollbar-thumb:hover {
      background: #16a34a;
    }
    
    .dropdown-list.active {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 9999 !important;
    }
    
    .dropdown-item {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.2s ease;
      /* Prevenir selección de texto */
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .dropdown-item:hover {
      background: #f3f4f6;
    }
    
    .dropdown-item:last-child {
      border-bottom: none;
    }
    
    .dropdown-item.add-new {
      background: #dcfce7;
      color: #166534;
      font-weight: 600;
    }
    
    .dropdown-item.add-new:hover {
      background: #bbf7d0;
    }
    
    .map-container {
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      margin: 16px 0;
      border: 2px solid #86efac;
    }
    
    .location-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .export-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    
    .btn-export {
      background: linear-gradient(135deg, #059669, #10b981);
      color: white;
    }
    
    .btn-export:hover {
      background: linear-gradient(135deg, #047857, #059669);
    }
    
    /* Estilos mejorados para los gráficos */
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Animaciones para los contenedores de gráficos */
    #weightChart, #breedChart, #healthChart, #paddockChart, #weaningChart,
    #genderChart, #ageChart, #weightRangeChart, #locationChart, #productivityChart, #healthTypeChart, #comprehensiveChart {
      animation: fadeInUp 0.6s ease-out;
      position: relative;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Efectos de brillo en las tarjetas */
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .card:hover::before {
      left: 100%;
    }
    
    /* Mejoras en los botones */
    .btn {
      position: relative;
      overflow: hidden;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    /* Efectos especiales para las tarjetas de resumen */
    #animalsSummary, #paddocksSummary, #healthSummary {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    /* Mejoras en la tabla */
    .table tbody tr {
      transition: all 0.3s ease;
    }
    
    .table tbody tr:hover {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      transform: scale(1.02);
    }
    
    /* Efectos de sombra mejorados */
    .card {
      position: relative;
    }
    
    .card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, transparent, rgba(0,0,0,0.1), transparent);
      border-radius: 0 0 16px 16px;
    }
    
    /* Animación de carga para los gráficos */
    .chart-loading {
      position: relative;
      overflow: hidden;
    }
    
    .chart-loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }
    
    /* Mejoras en los títulos */
    h2, h3, h4 {
      position: relative;
    }
    
    h2::after, h3::after, h4::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50px;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    
    .card:hover h2::after, .card:hover h3::after, .card:hover h4::after {
      width: 100px;
    }
    
    /* Efectos de partículas para las tarjetas principales */
    .card[style*="background: linear-gradient"] {
      position: relative;
      overflow: hidden;
    }
    
    .card[style*="background: linear-gradient"]::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      animation: float 20s infinite linear;
      pointer-events: none;
    }
    
    @keyframes float {
      0% {
        transform: translate(0, 0);
      }
      100% {
        transform: translate(20px, 20px);
      }
    }
  </style>
</head>
<body>
  <!-- ============ Sistema de Notificaciones ============ -->
  <div id="notification-container" class="notification-container"></div>

  <!-- ============ Welcome ============ -->
  <div id="welcome" class="welcome-screen">
    <div class="welcome-content">
      <div class="welcome-logo">🐄</div>
      <h1 style="font-size:44px; font-weight:900; margin-bottom:6px;">GeneGan Plus</h1>
      <p class="farm-subtitle" style="color:#fff; opacity:.95; font-size:16px;">Sistema integral de animales, potreros, reproducción y salud</p>
      <button class="start-btn" onclick="closeWelcome()">Comenzar 🚀</button>
    </div>
  </div>

  <!-- ============ Header ============ -->
  <header>
    <div class="header-content">
      <div style="display:flex; align-items:center; gap:12px;">
        <div class="logo" onclick="document.getElementById('farmLogo').click()" style="display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #16a34a, #22c55e); color: white; border-radius: 50%; width: 56px; height: 56px; cursor: pointer; border: 3px solid #86efac; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Fondo verde -->
            <rect width="32" height="32" rx="4" fill="#16a34a"/>
            
            <!-- Cuerpo de la vaca -->
            <ellipse cx="16" cy="20" rx="10" ry="8" fill="#F5DEB3"/>
            
            <!-- Cabeza -->
            <ellipse cx="16" cy="12" rx="6" ry="5" fill="#F5DEB3"/>
            
            <!-- Orejas -->
            <ellipse cx="11" cy="9" rx="1.5" ry="2.5" fill="#8B4513" transform="rotate(-20 11 9)"/>
            <ellipse cx="21" cy="9" rx="1.5" ry="2.5" fill="#8B4513" transform="rotate(20 21 9)"/>
            
            <!-- Ojos con pestañas -->
            <circle cx="14" cy="11" r="1.2" fill="#000000"/>
            <circle cx="18" cy="11" r="1.2" fill="#000000"/>
            <circle cx="14.3" cy="10.7" r="0.4" fill="white"/>
            <circle cx="18.3" cy="10.7" r="0.4" fill="white"/>
            
            <!-- Nariz -->
            <ellipse cx="16" cy="14" rx="1.8" ry="1.2" fill="#FF6B6B"/>
            <ellipse cx="15.5" cy="13.8" rx="0.3" ry="0.4" fill="#E74C3C"/>
            <ellipse cx="16.5" cy="13.8" rx="0.3" ry="0.4" fill="#E74C3C"/>
            
            <!-- Boca -->
            <path d="M14 15.5 Q16 16.5 18 15.5" stroke="#8B4513" stroke-width="1" fill="none"/>
            
            <!-- Cuernos -->
            <path d="M12 7 Q10 5 8 7" stroke="#8B4513" stroke-width="1.5" fill="none" stroke-linecap="round"/>
            <path d="M20 7 Q22 5 24 7" stroke="#8B4513" stroke-width="1.5" fill="none" stroke-linecap="round"/>
            
            <!-- Manchas de Holstein -->
            <ellipse cx="13" cy="18" rx="2" ry="1.5" fill="#000000" opacity="0.7"/>
            <ellipse cx="19" cy="18" rx="2" ry="1.5" fill="#000000" opacity="0.7"/>
            <ellipse cx="16" cy="22" rx="1.5" ry="2" fill="#000000" opacity="0.7"/>
            <ellipse cx="11" cy="24" rx="1" ry="1.5" fill="#000000" opacity="0.7"/>
            <ellipse cx="21" cy="24" rx="1" ry="1.5" fill="#000000" opacity="0.7"/>
            
            <!-- Patas -->
            <rect x="12" y="26" width="1.5" height="4" fill="#8B4513"/>
            <rect x="18.5" y="26" width="1.5" height="4" fill="#8B4513"/>
            <rect x="14" y="26" width="1.5" height="4" fill="#8B4513"/>
            <rect x="20.5" y="26" width="1.5" height="4" fill="#8B4513"/>
          </svg>
          <input id="farmLogo" type="file" accept="image/*" class="hidden">
        </div>
        <div>
          <input id="farmName" class="farm-name" value="Mi Finca Ganadera"/>
          <div class="farm-subtitle">Gestión Ganadera Avanzada</div>
          <div id="connection-status" style="font-size: 11px; font-weight: 600; margin-top: 2px;">🟢 En línea</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap: wrap;">
        <button class="btn btn-ghost" onclick="exportJSON()">⬇️ Exportar JSON</button>
        <button class="btn btn-export" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> Excel
        </button>
        <button class="btn btn-export" onclick="exportToPDF()">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
        <label class="btn btn-ghost" for="importFile" style="cursor:pointer;">⬆️ Importar</label>
        <input id="importFile" type="file" accept="application/json" class="hidden"/>
        <button class="btn btn-blue" onclick="resetAll()">🔄 Reiniciar</button>
      </div>
    </div>
  </header>

  <!-- ============ Nav ============ -->
  <nav>
    <div class="nav-content">
      <button class="nav-button active" onclick="showTab('tab-dashboard', this)">📊 Panel</button>
      <button class="nav-button" onclick="showTab('tab-animals', this)">🐄 Animales</button>
      <button class="nav-button" onclick="showTab('tab-potreros', this)">🌿 Potreros</button>
      <button class="nav-button" onclick="showTab('tab-repro', this)">🔄 Reproducción</button>
      <button class="nav-button" onclick="showTab('tab-salud', this)">🩺 Salud</button>
      <button class="nav-button" onclick="showTab('tab-graficos', this)">📈 Gráficos</button>
      <button class="nav-button" onclick="showTab('tab-ventas', this)">💰 Ventas</button>
    </div>
  </nav>

  <!-- ============ Main ============ -->
  <main>
    <!-- Panel -->
    <section id="tab-dashboard" class="tab active">
      <div class="card">
        <h2>🐄 Bienvenido a GeneGan Plus</h2>
        <p style="font-size: 16px; color: #374151; line-height: 1.6; margin-bottom: 20px;">
          Sistema integral de gestión ganadera para el control completo de tu finca.
        </p>
        <div class="grid grid-2">
          <div class="card" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px solid #16a34a;">
            <h3 style="color: #166534;">🚀 Comenzar</h3>
            <ul style="line-height:1.8; margin-left:16px; color: #15803d;">
              <li>Registra tus <b>potreros</b> antes de asignarlos a un animal</li>
              <li>Carga una <b>foto</b> del animal para identificarlo fácilmente</li>
              <li>En <b>Reproducción</b> registra servicios; el sistema calcula la fecha probable de parto</li>
              <li>En <b>Salud</b> crea eventos médicos y programa recordatorios</li>
            </ul>
          </div>
          <div class="card" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b;">
            <h3 style="color: #92400e;">📈 Funcionalidades</h3>
            <ul style="line-height:1.8; margin-left:16px; color: #d97706;">
              <li><b>Gestión de Animales:</b> Registro completo con fotos y pesos</li>
              <li><b>Control de Potreros:</b> Ubicación GPS y rotación</li>
              <li><b>Reproducción:</b> Seguimiento de servicios y partos</li>
              <li><b>Salud:</b> Historial médico y alertas</li>
              <li><b>Ventas:</b> Control financiero y transacciones</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Resumen General -->
      <div class="card">
        <h2>📊 Resumen General</h2>
        <div class="grid grid-3" id="dashboard-stats">
          <!-- KPIs renderizados por JS -->
        </div>
      </div>

      <!-- Alertas Reproductivas -->
      <div class="card" id="dashboard-alerts" style="display: none;">
        <h2>🚨 Alertas Reproductivas</h2>
        <div id="dashboard-alerts-content">
          <!-- Alertas renderizadas por JS -->
        </div>
      </div>
    </section>

    <!-- Animales -->
    <section id="tab-animals" class="tab">
      <div class="card">
        <h2>🐄 Registrar / Editar Animal</h2>
        <div class="grid grid-3">
          <div>
            <label>ID único</label>
            <input id="a-id" type="text" placeholder="Ejem: 001-2025" />
          </div>
          <div>
            <label>Nombre / Apodo</label>
            <input id="a-name" type="text" placeholder="Luna" />
          </div>
          <div>
            <label>Raza</label>
            <div class="dropdown-container">
                              <input id="a-breed" class="dropdown-input" type="text" placeholder="Seleccionar o escribir nueva raza" oninput="filterBreeds(this.value)" onfocus="showBreedDropdown()" onclick="showBreedDropdown()" />
              <div id="breed-dropdown" class="dropdown-list">
                <!-- Opciones de razas se cargarán dinámicamente -->
              </div>
            </div>
          </div>
          <div>
            <label>Sexo</label>
            <select id="a-sex">
              <option value="Hembra">Hembra</option>
              <option value="Macho">Macho</option>
            </select>
          </div>
          <div>
            <label>Fecha de nacimiento</label>
            <input id="a-dob" type="date" />
          </div>
          <div>
            <label>Peso actual (kg)</label>
            <input id="a-weight" type="number" step="0.1" placeholder="350" />
          </div>
          <div>
            <label>Asignar potrero</label>
            <select id="a-paddock"></select>
          </div>
          <div>
            <label>Foto</label>
            <input id="a-photo" type="file" accept="image/*" />
          </div>
          <div>
            <label>Notas de salud / observaciones</label>
            <textarea id="a-notes" placeholder="Historial breve, vacunas, tratamientos..."></textarea>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="saveAnimal()">💾 Guardar</button>
          <button class="btn btn-ghost" onclick="clearAnimalForm()">🧹 Limpiar</button>
          <button class="btn btn-ghost" onclick="debugDropdowns()">🐛 Debug Dropdowns</button>
        </div>
      </div>

      <div class="card">
        <h2>📚 Listado de animales</h2>
        <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
          <input id="animalSearch" type="text" placeholder="Buscar por ID, nombre o raza" oninput="renderAnimals()" />
          <select id="filterPaddock" onchange="renderAnimals()"></select>
        </div>
        <table class="table" id="animalsTable">
          <thead>
            <tr>
              <th>Foto</th>
              <th>ID</th>
              <th>Nombre</th>
              <th>Raza</th>
              <th>Sexo</th>
              <th>Edad</th>
              <th>Peso</th>
              <th>Potrero</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Potreros -->
    <section id="tab-potreros" class="tab">
      <div class="card">
        <h2>🌿 Registrar / Editar Potrero</h2>
        <div class="grid grid-3">
          <div>
            <label>Nombre</label>
            <input id="p-name" type="text" placeholder="Potrero A" />
          </div>
          <div>
            <label>Extensión (ha)</label>
            <input id="p-area" type="number" step="0.01" placeholder="2.5" />
          </div>
          <div>
            <label>Altura (msnm)</label>
            <input id="p-alt" type="number" step="1" placeholder="1200" />
          </div>
          <div class="grid-2" style="grid-column: 1/-1;">
            <div>
              <label>Tipo de pasto</label>
              <input id="p-grass" type="text" placeholder="Brachiaria, Kikuyo..." />
            </div>
            <div>
              <label>Foto (opcional)</label>
              <input id="p-photo" type="file" accept="image/*" />
            </div>
          </div>
          <div class="location-inputs" style="grid-column: 1/-1;">
            <div>
              <label>Latitud</label>
              <input id="p-lat" type="number" step="0.000001" placeholder="4.5709" />
            </div>
            <div>
              <label>Longitud</label>
              <input id="p-lng" type="number" step="0.000001" placeholder="-74.2973" />
            </div>
          </div>
          <div style="grid-column: 1/-1;">
            <button class="btn btn-blue" onclick="getCurrentLocation()">
              <i class="fas fa-location-arrow"></i> Obtener ubicación actual
            </button>
          </div>
          <div id="paddock-map" class="map-container" style="grid-column: 1/-1; display: none;">
            <!-- Mapa se cargará aquí -->
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="savePaddock()">💾 Guardar</button>
          <button class="btn btn-ghost" onclick="clearPaddockForm()">🧹 Limpiar</button>
        </div>
      </div>

      <div class="card">
        <h2>📚 Potreros registrados</h2>
        <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
          <button class="btn btn-blue" onclick="showAllPaddocksMap()">
            <i class="fas fa-map"></i> Ver mapa de potreros
          </button>
        </div>
        <table class="table" id="paddocksTable">
          <thead>
            <tr>
              <th>Foto</th>
              <th>Nombre</th>
              <th>Extensión</th>
              <th>Altura</th>
              <th>Pasto</th>
              <th>Ubicación</th>
              <th>Animales</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Reproducción -->
    <section id="tab-repro" class="tab">
      <div class="card">
        <h2>🔄 Registrar servicio (monta / IA)</h2>
        <div class="grid grid-3">
          <div>
            <label>Hembra</label>
            <select id="r-female"></select>
          </div>
          <div>
            <label>Macho</label>
            <select id="r-male"></select>
          </div>
          <div>
            <label>Fecha del servicio</label>
            <input id="r-date" type="date" />
          </div>
          <div style="grid-column:1/-1;">
            <label>Observaciones</label>
            <textarea id="r-notes" placeholder="Toro usado, dosis, condición..." ></textarea>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="saveService()">💾 Guardar servicio</button>
          <button class="btn btn-ghost" onclick="clearServiceForm()">🧹 Limpiar</button>
        </div>
        <p id="dueDate" class="pill pill-amber" style="margin-top:10px; display:none;"></p>
      </div>

      <div class="card">
        <h2>🍼 Partos / Crías</h2>
        <div class="grid grid-3">
          <div>
            <label>Servicio (hembra × macho)</label>
            <select id="birth-service"></select>
          </div>
          <div>
            <label>Fecha de parto</label>
            <input id="birth-date" type="date" />
          </div>
          <div>
            <label>ID cría nuevo</label>
            <input id="birth-offspring-id" type="text" placeholder="ID de la cría" />
          </div>
          <div style="grid-column:1/-1;">
            <label>Sexo de la cría</label>
            <select id="birth-offspring-sex">
              <option value="Hembra">Hembra</option>
              <option value="Macho">Macho</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-amber" onclick="registerBirth()">➕ Registrar cría</button>
        </div>
      </div>

      <div class="card">
        <h2>📚 Historial reproductivo</h2>
        <table class="table" id="servicesTable">
          <thead>
            <tr>
              <th>Hembra</th>
              <th>Macho</th>
              <th>Fecha servicio</th>
              <th>FPP (283d)</th>
              <th>Notas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Salud -->
    <section id="tab-salud" class="tab">
      <div class="card">
        <h2>🩺 Evento de salud</h2>
        <div class="grid grid-3">
          <div>
            <label>Animal</label>
            <select id="s-animal"></select>
          </div>
          <div>
            <label>Fecha</label>
            <input id="s-date" type="date" />
          </div>
          <div>
            <label>Tipo de Evento</label>
            <select id="s-event-type" onchange="updateHealthDropdowns()">
              <option value="">Seleccionar tipo</option>
              <option value="procedimiento">Procedimiento</option>
              <option value="enfermedad">Enfermedad</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div>
            <label>Procedimiento/Enfermedad</label>
            <div class="dropdown-container">
                              <input id="s-type" class="dropdown-input" type="text" placeholder="Seleccionar o escribir nuevo" oninput="filterHealthItems(this.value)" onfocus="showHealthDropdown()" onclick="showHealthDropdown()" />
              <div id="health-dropdown" class="dropdown-list">
                <!-- Opciones se cargarán dinámicamente -->
              </div>
            </div>
          </div>
          <div style="grid-column:1/-1;">
            <label>Descripción / Medicación</label>
            <textarea id="s-notes" placeholder="Síntomas, diagnóstico, dosis..."></textarea>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="saveHealth()">💾 Guardar</button>
          <button class="btn btn-ghost" onclick="clearHealthForm()">🧹 Limpiar</button>
        </div>
      </div>

      <div class="card">
        <h2>📚 Historial de salud</h2>
        <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
          <select id="healthFilter" onchange="renderHealth()"></select>
        </div>
        <table class="table" id="healthTable">
                  <thead>
          <tr>
            <th>Animal</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Procedimiento/Enfermedad</th>
            <th>Detalle</th>
            <th>Acciones</th>
          </tr>
        </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Gráficos y Estadísticas -->
    <section id="tab-graficos" class="tab">
      <!-- Dashboard con KPIs -->
      <div class="card">
        <h2>📊 Resumen General</h2>
        <div class="grid grid-3" id="stats">
          <!-- KPIs renderizados por JS -->
        </div>
      </div>

      <div class="card" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
        <h2 style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; padding: 20px; margin: -20px -20px 20px -20px; border-radius: 12px 12px 0 0; text-align: center; font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
          📈 Dashboard de Gráficos y Estadísticas
        </h2>
        
        <div style="display:flex; gap:12px; margin-bottom:24px; flex-wrap:wrap; justify-content: center;">
          <button class="btn btn-primary" onclick="renderAllCharts()" style="background: linear-gradient(135deg, #059669, #10b981); border: none; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); transform: translateY(0); transition: all 0.3s ease;">
            🔄 Actualizar Gráficos
          </button>
          <button class="btn btn-blue" onclick="exportCharts()" style="background: linear-gradient(135deg, #1d4ed8, #3b82f6); border: none; box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3); transform: translateY(0); transition: all 0.3s ease;">
            📊 Exportar Reporte
          </button>
        </div>
        
        <div class="grid grid-2" style="gap: 24px;">
          <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #10b981, #059669, #047857);"></div>
            <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
              <span style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">📊</span>
              Evolución de Pesos
            </h3>
            <div id="weightChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5);"></div>
          </div>
          
          <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #3b82f6, #1d4ed8, #1e40af);"></div>
            <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
              <span style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">🐄</span>
              Distribución por Razas
            </h3>
            <div id="breedChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #eff6ff, #dbeafe);"></div>
          </div>
          
          <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #f59e0b, #d97706, #b45309);"></div>
            <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
              <span style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">📅</span>
              Eventos de Salud por Mes
            </h3>
            <div id="healthChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #fffbeb, #fef3c7);"></div>
          </div>
          
          <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #10b981, #059669, #047857);"></div>
            <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
              <span style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">🌿</span>
              Uso de Potreros
            </h3>
            <div id="paddockChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5);"></div>
          </div>
          
          <div class="card" style="grid-column: 1/-1; background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #8b5cf6, #7c3aed, #6d28d9);"></div>
            <h3 style="color: #1f2937; font-size: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
              <span style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 10px 16px; border-radius: 24px; font-size: 16px;">📈</span>
              Estadísticas de Destete
            </h3>
            <div id="weaningChart" style="height: 400px; border-radius: 12px; background: linear-gradient(135deg, #faf5ff, #f3e8ff);"></div>
          </div>
        </div>
        
        <!-- Nueva sección: Venta de Gráficos - Todos los Parámetros -->
        <div class="card" style="margin-top: 32px; background: linear-gradient(135deg, #ffffff, #f8fafc); border: 3px solid #2563eb; border-radius: 20px; box-shadow: 0 12px 35px rgba(37, 99, 235, 0.15); position: relative; overflow: hidden;">
          <div style="position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, #2563eb, #1d4ed8, #1e40af, #3730a3);"></div>
          
          <h2 style="color: #1e40af; font-size: 26px; margin-bottom: 8px; text-align: center; font-weight: 700; text-shadow: 0 2px 4px rgba(30, 64, 175, 0.1);">
            💰 Dashboard de Venta - Todos los Parámetros Registrados
          </h2>
          <p style="color: #64748b; margin-bottom: 24px; text-align: center; font-size: 16px; font-style: italic;">
            Visualización completa y profesional de todos los datos registrados en el sistema
          </p>
          
          <div style="display:flex; gap:12px; margin-bottom:24px; flex-wrap:wrap; justify-content: center;">
            <button class="btn btn-primary" onclick="renderSalesCharts()" style="background: linear-gradient(135deg, #059669, #10b981); border: none; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); transform: translateY(0); transition: all 0.3s ease;">
              🔄 Actualizar Venta
            </button>
            <button class="btn btn-blue" onclick="exportSalesReport()" style="background: linear-gradient(135deg, #1d4ed8, #3b82f6); border: none; box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3); transform: translateY(0); transition: all 0.3s ease;">
              📊 Exportar Venta
            </button>
          </div>
          
          <!-- Resumen de datos registrados -->
          <div class="grid grid-3" style="margin-bottom: 32px; gap: 20px;">
            <div class="card" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 3px solid #16a34a; border-radius: 16px; box-shadow: 0 8px 25px rgba(22, 163, 74, 0.15); position: relative; overflow: hidden; transition: all 0.3s ease;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #16a34a, #059669, #047857);"></div>
              <h4 style="color: #166534; font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #16a34a, #059669); color: white; padding: 6px 10px; border-radius: 16px; font-size: 12px;">🐄</span>
                Animales Registrados
              </h4>
              <div id="animalsSummary" style="font-size: 32px; font-weight: bold; color: #166534; text-align: center; text-shadow: 0 2px 4px rgba(22, 101, 52, 0.2);">0</div>
              <div style="font-size: 14px; color: #15803d; text-align: center; font-weight: 500;">Total en el sistema</div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 3px solid #f59e0b; border-radius: 16px; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.15); position: relative; overflow: hidden; transition: all 0.3s ease;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #f59e0b, #d97706, #b45309);"></div>
              <h4 style="color: #92400e; font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 6px 10px; border-radius: 16px; font-size: 12px;">🌿</span>
                Potreros Activos
              </h4>
              <div id="paddocksSummary" style="font-size: 32px; font-weight: bold; color: #92400e; text-align: center; text-shadow: 0 2px 4px rgba(146, 64, 14, 0.2);">0</div>
              <div style="font-size: 14px; color: #d97706; text-align: center; font-weight: 500;">En producción</div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 3px solid #2563eb; border-radius: 16px; box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15); position: relative; overflow: hidden; transition: all 0.3s ease;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #2563eb, #1d4ed8, #1e40af);"></div>
              <h4 style="color: #1e40af; font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 6px 10px; border-radius: 16px; font-size: 12px;">🩺</span>
                Eventos de Salud
              </h4>
              <div id="healthSummary" style="font-size: 32px; font-weight: bold; color: #1e40af; text-align: center; text-shadow: 0 2px 4px rgba(30, 64, 175, 0.2);">0</div>
              <div style="font-size: 14px; color: #1d4ed8; text-align: center; font-weight: 500;">Registrados</div>
            </div>
          </div>
          
          <!-- Gráficos de venta detallados -->
          <div class="grid grid-2" style="gap: 24px;">
            <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #ec4899, #db2777, #be185d);"></div>
              <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">📊</span>
                Distribución por Sexo
              </h3>
              <div id="genderChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #fdf2f8, #fce7f3);"></div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #06b6d4, #0891b2, #0e7490);"></div>
              <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">📅</span>
                Edad de los Animales
              </h3>
              <div id="ageChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #ecfeff, #cffafe);"></div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #f97316, #ea580c, #c2410c);"></div>
              <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #f97316, #ea580c); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">⚖️</span>
                Rango de Pesos
              </h3>
              <div id="weightRangeChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #fff7ed, #fed7aa);"></div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #84cc16, #65a30d, #4d7c0f);"></div>
              <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #84cc16, #65a30d); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">🌍</span>
                Distribución Geográfica
              </h3>
              <div id="locationChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #f7fee7, #ecfccb);"></div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #8b5cf6, #7c3aed, #6d28d9);"></div>
              <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">📈</span>
                Productividad por Potrero
              </h3>
              <div id="productivityChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #faf5ff, #f3e8ff);"></div>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #ef4444, #dc2626, #b91c1c);"></div>
              <h3 style="color: #1f2937; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px;">🩺</span>
                Tipos de Eventos de Salud
              </h3>
              <div id="healthTypeChart" style="height: 300px; border-radius: 12px; background: linear-gradient(135deg, #fef2f2, #fee2e2);"></div>
            </div>
            
            <div class="card" style="grid-column: 1/-1; background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); transition: all 0.3s ease; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #6366f1, #4f46e5, #4338ca);"></div>
              <h3 style="color: #1f2937; font-size: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 10px 16px; border-radius: 24px; font-size: 16px;">📊</span>
                Análisis Completo de Datos
              </h3>
              <div id="comprehensiveChart" style="height: 500px; border-radius: 12px; background: linear-gradient(135deg, #f8fafc, #e2e8f0);"></div>
            </div>
          </div>
          
          <!-- Tabla de resumen de peso -->
          <div class="card" style="margin-top: 32px; background: linear-gradient(135deg, #ffffff, #f8fafc); border: 2px solid #e2e8f0; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #64748b, #475569, #334155);"></div>
            <h3 style="color: #1f2937; font-size: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
              <span style="background: linear-gradient(135deg, #64748b, #475569); color: white; padding: 10px 16px; border-radius: 24px; font-size: 16px;">📋</span>
              Resumen Detallado de Peso
            </h3>
            <div id="salesTableContainer" style="border-radius: 12px; overflow: hidden;">
              <table class="table" id="salesTable" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 12px; overflow: hidden;">
                <thead>
                  <tr style="background: linear-gradient(135deg, #1e293b, #334155); color: white;">
                    <th style="padding: 16px; text-align: left; font-weight: 600;">Categoría</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600;">Total</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600;">Promedio</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600;">Mínimo</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600;">Máximo</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600;">Última Actualización</th>
                  </tr>
                </thead>
                <tbody id="salesTableBody" style="background: white;"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Ventas -->
    <section id="tab-ventas" class="tab">
      <div class="card" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 3px solid #16a34a;">
        <h2 style="color: #166534; text-align: center; margin-bottom: 20px;">
          💰 Sistema de Gestión de Ventas Ganaderas
        </h2>
        <p style="text-align: center; color: #15803d; font-size: 16px; margin-bottom: 30px;">
          Control completo de compras, ventas, precios y rentabilidad de tu ganado
        </p>
      </div>

      <!-- Registrar Venta/Compra -->
      <div class="card">
        <h2>📝 Registrar Transacción</h2>
        <div class="grid grid-3">
          <div>
            <label>Tipo de Transacción</label>
            <select id="v-type" onchange="updateTransactionFields()">
              <option value="">Seleccionar tipo</option>
              <option value="venta">Venta</option>
              <option value="compra">Compra</option>
            </select>
          </div>
          <div>
            <label>Animal</label>
            <select id="v-animal"></select>
          </div>
          <div>
            <label>Fecha de Transacción</label>
            <input id="v-date" type="date" />
          </div>
          <div>
            <label>Precio por Kg</label>
            <input id="v-price-per-kg" type="number" step="0.01" placeholder="0.00" />
          </div>
          <div>
            <label>Peso del Animal (kg)</label>
            <input id="v-weight" type="number" step="0.1" placeholder="0.0" />
          </div>
          <div>
            <label>Precio Total</label>
            <input id="v-total-price" type="number" step="0.01" placeholder="0.00" readonly />
          </div>
          <div>
            <label>Comprador/Vendedor</label>
            <input id="v-buyer-seller" type="text" placeholder="Nombre del comprador/vendedor" />
          </div>
          <div>
            <label>Documento</label>
            <input id="v-document" type="text" placeholder="CC, NIT, etc." />
          </div>
          <div>
            <label>Teléfono</label>
            <input id="v-phone" type="tel" placeholder="+57 300 123 4567" />
          </div>
          <div style="grid-column: 1/-1;">
            <label>Observaciones</label>
            <textarea id="v-notes" placeholder="Detalles adicionales, condiciones de pago, etc."></textarea>
          </div>
        </div>
        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="saveTransaction()">
            💾 Guardar Transacción
          </button>
          <button class="btn btn-ghost" onclick="clearTransactionForm()">
            🧹 Limpiar
          </button>
          <button class="btn btn-blue" onclick="calculateTotal()">
            🧮 Calcular Total
          </button>
        </div>
      </div>

      <!-- Resumen Financiero -->
      <div class="card" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b;">
        <h2 style="color: #92400e;">📊 Resumen Financiero</h2>
        <div class="grid grid-3" id="financial-summary">
          <div class="card" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 2px solid #16a34a;">
            <h3 style="color: #166534;">💰 Ventas Totales</h3>
            <div id="total-sales" style="font-size: 28px; font-weight: bold; color: #166534;">$0</div>
          </div>
          <div class="card" style="background: linear-gradient(135deg, #fee2e2, #fecaca); border: 2px solid #dc2626;">
            <h3 style="color: #dc2626;">💸 Compras Totales</h3>
            <div id="total-purchases" style="font-size: 28px; font-weight: bold; color: #dc2626;">$0</div>
          </div>
          <div class="card" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 2px solid #2563eb;">
            <h3 style="color: #1e40af;">📈 Ganancia Neta</h3>
            <div id="net-profit" style="font-size: 28px; font-weight: bold; color: #1e40af;">$0</div>
          </div>
        </div>
      </div>

      <!-- Historial de Transacciones -->
      <div class="card">
        <h2>📚 Historial de Transacciones</h2>
        <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
          <input id="transactionSearch" type="text" placeholder="Buscar por animal, comprador/vendedor..." oninput="renderTransactions()" />
          <select id="transactionTypeFilter" onchange="renderTransactions()">
            <option value="">Todos los tipos</option>
            <option value="venta">Solo Ventas</option>
            <option value="compra">Solo Compras</option>
          </select>
          <button class="btn btn-blue" onclick="exportTransactions()">
            📊 Exportar Reporte
          </button>
        </div>
        <table class="table" id="transactionsTable">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Animal</th>
              <th>Fecha</th>
              <th>Peso (kg)</th>
              <th>Precio/kg</th>
              <th>Total</th>
              <th>Comprador/Vendedor</th>
              <th>Documento</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Gráficos de Ventas -->
      <div class="card" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border: 2px solid #64748b;">
        <h2 style="color: #1e293b;">📈 Análisis de Ventas</h2>
        <div class="grid grid-2" style="gap: 24px;">
          <div class="card" style="background: white; border: 2px solid #e2e8f0;">
            <h3 style="color: #1f2937;">💰 Ventas por Mes</h3>
            <div id="salesChart" style="height: 300px; border-radius: 12px;"></div>
          </div>
          <div class="card" style="background: white; border: 2px solid #e2e8f0;">
            <h3 style="color: #1f2937;">📊 Rentabilidad por Animal</h3>
            <div id="profitChart" style="height: 300px; border-radius: 12px;"></div>
          </div>
          <div class="card" style="background: white; border: 2px solid #e2e8f0;">
            <h3 style="color: #1f2937;">🔄 Flujo de Caja</h3>
            <div id="cashFlowChart" style="height: 300px; border-radius: 12px;"></div>
          </div>
          <div class="card" style="background: white; border: 2px solid #e2e8f0;">
            <h3 style="color: #1f2937;">📅 Precios Promedio</h3>
            <div id="priceChart" style="height: 300px; border-radius: 12px;"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ============ Modal: Peso histórico ============ -->
  <div id="weightModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>⚖️ Historial de peso — <span id="wm-title"></span></h3>
        <button class="btn btn-ghost" onclick="closeModal('weightModal')">✖</button>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
        <input id="wm-date" type="date" />
        <input id="wm-kg" type="number" step="0.1" placeholder="kg" />
        <button class="btn btn-primary" onclick="addWeighRecord()">➕ Agregar</button>
      </div>
      <table class="table">
        <thead>
          <tr><th>Fecha</th><th>Peso (kg)</th><th>Acciones</th></tr>
        </thead>
        <tbody id="wm-body"></tbody>
      </table>
    </div>
  </div>

  <!-- ============ Modal: Mapa de potreros ============ -->
  <div id="mapModal" class="modal">
    <div class="modal-content" style="width: 90vw; max-width: 800px;">
      <div class="modal-header">
        <h3>🗺️ Mapa de Potreros</h3>
        <button class="btn btn-ghost" onclick="closeModal('mapModal')">✖</button>
      </div>
      <div id="mapModal-container" style="height: 500px; border-radius: 12px; overflow: hidden;">
        <!-- Mapa se cargará aquí -->
      </div>
    </div>
  </div>

  <script>
    /* =====================================
       Estado y utilidades (LocalStorage)
       ===================================== */
    const KEY = 'genegan_plus_store_v1';
    const GESTATION_DAYS = 283; // bovino

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    let store = {
      farmName: 'Mi Finca Ganadera',
      animals: [], // {id, name, breed, sex, dob, paddleId, notes, photo, weights:[{date, kg}], motherId, fatherId}
      paddocks: [], // {id, name, area, altitude, grass, photo, lat, lng}
      services: [], // {id, femaleId, maleId, date, notes}
      health: [],   // {id, animalId, date, type, notes}
      transactions: [], // {id, type, animalId, date, pricePerKg, weight, totalPrice, buyerSeller, document, phone, notes}
      breeds: [
        // Razas más comunes en Colombia
        'Brahman', 'Cebú', 'Gyr', 'Nelore', 'Guzerat', 'Indubrasil',
        'Angus', 'Hereford', 'Simental', 'Holstein', 'Jersey', 'Pardo Suizo',
        'Normando', 'Charolais', 'Limousin', 'Romosinuano', 'Blanco Orejinegro',
        'Hartón del Valle', 'Costeño con Cuernos', 'Sanmartinero', 'Lucerna',
        'Criollo Colombiano', 'Pardo Alpino', 'Ayrshire', 'Guernsey',
        // Híbridos adicionales
        'Simgyr', 'Nsimbrah', 'Branmus', '7 Colores', 'Gyrolando'
      ], // Razas predefinidas de Colombia
      procedures: [
        // Procedimientos veterinarios comunes
        'Vacunación Triple', 'Vacunación Antirrábica', 'Vacunación Brucelosis',
        'Desparasitación Interna', 'Desparasitación Externa', 'Vitaminización',
        'Castración', 'Descornado', 'Identificación con Arete', 'Toma de Muestra',
        'Aplicación de Implante', 'Tratamiento de Heridas', 'Sutura',
        'Cesárea', 'Parto Asistido', 'Control Reproductivo', 'Palpación Rectal',
        'Inseminación Artificial', 'Transferencia de Embriones', 'Ecografía',
        'Análisis de Sangre', 'Análisis de Leche', 'Control de Peso',
        'Aplicación de Medicamentos', 'Curación de Pezuñas', 'Limpieza Dental'
      ],
      diseases: [
        // Enfermedades más comunes en ganado colombiano
        'Fiebre Aftosa', 'Brucelosis', 'Tuberculosis', 'Leptospirosis',
        'Carbón Bacteridiano', 'Carbón Sintomático', 'Edema Maligno',
        'Gangrena Gaseosa', 'Tétanos', 'Rabia', 'Encefalitis Equina',
        'Diarrea Viral Bovina', 'Rinotraqueitis Infecciosa', 'Parainfluenza',
        'Virus Sincitial Respiratorio', 'Mastitis', 'Metritis',
        'Retención de Placenta', 'Quistes Ováricos', 'Anestro',
        'Neumonía', 'Bronquitis', 'Pleuresía', 'Pericarditis',
        'Gastritis', 'Enteritis', 'Cólico', 'Timpanismo',
        'Acidosis Ruminal', 'Alcalosis Ruminal', 'Hipocalcemia',
        'Hipomagnesemia', 'Déficit de Vitamina A', 'Déficit de Vitamina D',
        'Déficit de Vitamina E', 'Déficit de Selenio', 'Déficit de Cobre',
        'Déficit de Zinc', 'Déficit de Hierro', 'Anemia',
        'Dermatitis', 'Sarna', 'Piojos', 'Garrapatas',
        'Gusanos Gastrointestinales', 'Fasciola Hepática', 'Coccidiosis',
        'Babesiosis', 'Anaplasmosis', 'Tripanosomiasis'
      ]
    };

    function loadStore(){
      const raw = localStorage.getItem(KEY);
      if(raw){ 
        try{ 
          const savedStore = JSON.parse(raw);
          // Preservar arrays predefinidos si no existen en localStorage
          store = {
            ...store, // Mantener arrays predefinidos
            ...savedStore // Sobrescribir con datos guardados
          };
        }catch(e){console.warn('JSON inválido');} 
      }
      $('#farmName').value = store.farmName || 'Mi Finca Ganadera';
    }
    function saveStore(){ localStorage.setItem(KEY, JSON.stringify(store)); renderAll(); }

    // Helpers
    const uid = () => Math.random().toString(36).slice(2,9);
    const today = () => new Date().toISOString().slice(0,10);
    const fmt = (n, u='') => n!=null && n!=='' ? `${(+n).toLocaleString('es-CO')}${u}` : '';
    const calcAge = (dob) => {
      if(!dob) return '';
      const d1 = new Date(dob); const d2 = new Date();
      let years = d2.getFullYear() - d1.getFullYear();
      let m = d2.getMonth() - d1.getMonth();
      if(m < 0 || (m===0 && d2.getDate() < d1.getDate())) years--;
      return years < 1 ? `${Math.max(0, m + years*12)} m` : `${years} a`;
    };
    const readFileAsDataURL = (file) => new Promise((res, rej)=>{ const fr = new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });

    /* =====================================
       Sistema de Notificaciones
       ===================================== */
    function showNotification(type, title, message, duration = 5000) {
      const container = $('#notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      const icons = {
        success: '✅',
        warning: '⚠️',
        error: '❌',
        info: 'ℹ️'
      };
      
      notification.innerHTML = `
        <div class="notification-icon">${icons[type] || 'ℹ️'}</div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">×</button>
      `;
      
      container.appendChild(notification);
      
      // Auto-remover después del tiempo especificado
      if (duration > 0) {
        setTimeout(() => {
          if (notification.parentElement) {
            notification.style.animation = 'slideOutNotification 0.3s ease forwards';
            setTimeout(() => notification.remove(), 300);
          }
        }, duration);
      }
    }

    /* =====================================
       Funcionalidad de Descarga de Aplicación
       ===================================== */
    
    // Función para detectar el tipo de dispositivo
    function detectDevice() {
      const userAgent = navigator.userAgent.toLowerCase();
      const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
      const isIOS = /iphone|ipad|ipod/i.test(userAgent);
      const isAndroid = /android/i.test(userAgent);
      
      return {
        isMobile,
        isIOS,
        isAndroid,
        isDesktop: !isMobile
      };
    }
    
    // Función para mostrar el modal de descarga
    function showDownloadModal() {
      const device = detectDevice();
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.style.display = 'flex';
      
      let downloadContent = '';
      
      if (device.isIOS) {
        downloadContent = `
          <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: #1e40af; margin-bottom: 10px;">📱 Instalar en iPhone/iPad</h3>
            <p style="color: #6b7280; margin-bottom: 15px;">Para instalar GeneGan Plus en tu dispositivo iOS:</p>
            <ol style="text-align: left; color: #374151; line-height: 1.6;">
              <li>Toca el botón <strong>Compartir</strong> en Safari</li>
              <li>Selecciona <strong>"Agregar a Pantalla de Inicio"</strong></li>
              <li>Toca <strong>"Agregar"</strong> para confirmar</li>
              <li>La app aparecerá en tu pantalla de inicio</li>
            </ol>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-primary" onclick="closeDownloadModal()" style="background: linear-gradient(135deg, #16a34a, #22c55e);">
              ✅ Entendido
            </button>
            <button class="btn btn-blue" onclick="openSafariShare()" style="background: linear-gradient(135deg, #2563eb, #3b82f6);">
              🔗 Abrir Safari
            </button>
          </div>
        `;
      } else if (device.isAndroid) {
        downloadContent = `
          <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: #1e40af; margin-bottom: 10px;">📱 Instalar en Android</h3>
            <p style="color: #6b7280; margin-bottom: 15px;">Para instalar GeneGan Plus en tu dispositivo Android:</p>
            <ol style="text-align: left; color: #374151; line-height: 1.6;">
              <li>Toca el botón <strong>Menú</strong> (⋮) en Chrome</li>
              <li>Selecciona <strong>"Instalar aplicación"</strong></li>
              <li>Toca <strong>"Instalar"</strong> para confirmar</li>
              <li>La app aparecerá en tu pantalla de inicio</li>
            </ol>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-primary" onclick="closeDownloadModal()" style="background: linear-gradient(135deg, #16a34a, #22c55e);">
              ✅ Entendido
            </button>
            <button class="btn btn-blue" onclick="openChromeMenu()" style="background: linear-gradient(135deg, #2563eb, #3b82f6);">
              🔗 Abrir Chrome
            </button>
          </div>
        `;
      } else {
        downloadContent = `
          <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: #1e40af; margin-bottom: 10px;">💻 Instalar en PC</h3>
            <p style="color: #6b7280; margin-bottom: 15px;">Para instalar GeneGan Plus en tu computadora:</p>
            <ol style="text-align: left; color: #374151; line-height: 1.6;">
              <li>Presiona <strong>Ctrl+Shift+I</strong> (o F12) para abrir las herramientas de desarrollador</li>
              <li>Haz clic en el ícono <strong>"Aplicación"</strong> o <strong>"Application"</strong></li>
              <li>En la sección <strong>"Manifest"</strong>, haz clic en <strong>"Instalar"</strong></li>
              <li>Confirma la instalación</li>
              <li>La app aparecerá en tu escritorio y menú de inicio</li>
            </ol>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-primary" onclick="closeDownloadModal()" style="background: linear-gradient(135deg, #16a34a, #22c55e);">
              ✅ Entendido
            </button>
            <button class="btn btn-blue" onclick="openDevTools()" style="background: linear-gradient(135deg, #2563eb, #3b82f6);">
              🔧 Abrir Herramientas
            </button>
          </div>
        `;
      }
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div class="modal-header">
            <h2 style="color: #1e40af; margin-bottom: 5px;">📱 Descargar GeneGan Plus</h2>
            <button class="btn btn-ghost" onclick="closeDownloadModal()" style="position: absolute; top: 10px; right: 10px;">✖</button>
          </div>
          <div style="padding: 20px;">
            <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px solid #0ea5e9;">
              <h3 style="color: #0c4a6e; margin-bottom: 10px;">🚀 Instalar como Aplicación</h3>
              <p style="color: #0369a1; margin-bottom: 15px;">GeneGan Plus funciona offline y se puede instalar como una aplicación nativa en tu dispositivo.</p>
            </div>
            ${downloadContent}
            <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #16a34a;">
              <h4 style="color: #166534; margin-bottom: 8px;">✨ Beneficios de la instalación:</h4>
              <ul style="text-align: left; color: #374151; line-height: 1.4; margin: 0;">
                <li>✅ Funciona sin conexión a internet</li>
                <li>✅ Acceso rápido desde el escritorio</li>
                <li>✅ Sincronización automática de datos</li>
                <li>✅ Experiencia de aplicación nativa</li>
              </ul>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // Función para cerrar el modal de descarga
    function closeDownloadModal() {
      const modal = document.querySelector('.modal');
      if (modal) {
        modal.remove();
      }
    }
    
    // Funciones auxiliares para diferentes dispositivos
    function openSafariShare() {
      if (navigator.share) {
        navigator.share({
          title: 'GeneGan Plus',
          text: 'Instala GeneGan Plus en tu dispositivo',
          url: window.location.href
        });
      } else {
        showNotification('info', 'Instrucciones', 'Toca el botón Compartir en Safari y selecciona "Agregar a Pantalla de Inicio"');
      }
    }
    
    function openChromeMenu() {
      showNotification('info', 'Instrucciones', 'Toca el botón Menú (⋮) en Chrome y selecciona "Instalar aplicación"');
    }
    
    function openDevTools() {
      showNotification('info', 'Herramientas de Desarrollador', 'Presiona Ctrl+Shift+I (o F12) para abrir las herramientas de desarrollador');
    }
    


    function checkReproductiveAlerts() {
      const alerts = [];
      const today = new Date();
      
      // Verificar animales próximos al parto
      store.services.forEach(service => {
        if (service.date) {
          const serviceDate = new Date(service.date);
          const expectedBirth = new Date(serviceDate.getTime() + (GESTATION_DAYS * 24 * 60 * 60 * 1000));
          const daysUntilBirth = Math.ceil((expectedBirth - today) / (24 * 60 * 60 * 1000));
          
          if (daysUntilBirth >= -7 && daysUntilBirth <= 30) {
            const animal = store.animals.find(a => a.id === service.femaleId);
            let status, priority, icon;
            
            if (daysUntilBirth < 0) {
              status = 'RETRASADO';
              priority = 'error';
              icon = '🚨';
            } else if (daysUntilBirth <= 3) {
              status = 'INMINENTE';
              priority = 'error';
              icon = '⚠️';
            } else if (daysUntilBirth <= 7) {
              status = 'MUY PRÓXIMO';
              priority = 'warning';
              icon = '🔔';
            } else {
              status = 'PRÓXIMO';
              priority = 'info';
              icon = '📅';
            }
            
            alerts.push({
              type: 'reproductive',
              title: `${icon} Parto ${status}`,
              message: `Vaca ${animal?.name || service.femaleId} - Fecha esperada: ${expectedBirth.toLocaleDateString('es-CO')} (${Math.abs(daysUntilBirth)} días ${daysUntilBirth < 0 ? 'de retraso' : 'restantes'})`,
              priority: priority,
              daysUntilBirth: daysUntilBirth
            });
          }
        }
      });
      
      // Verificar vacunas próximas a vencer
      store.health.forEach(health => {
        if (health.type && health.type.toLowerCase().includes('vacunación') && health.date) {
          const healthDate = new Date(health.date);
          const daysSinceHealth = Math.ceil((today - healthDate) / (24 * 60 * 60 * 1000));
          
          if (daysSinceHealth >= 330 && daysSinceHealth <= 365) { // 11-12 meses
            const animal = store.animals.find(a => a.id === health.animalId);
            alerts.push({
              type: 'health',
              title: 'Vacuna próxima a vencer',
              message: `Animal ${animal?.name || health.animalId} - ${health.type} (${daysSinceHealth} días)`,
              priority: 'warning'
            });
          }
        }
      });
      
      return alerts;
    }

    /* =====================================
       Inicialización
       ===================================== */
    loadStore();
        document.addEventListener('DOMContentLoaded', () => {
      // Inicializar sistema de dropdowns
      console.log('Inicializando sistema de dropdowns...');
      
      // Verificar que el DropdownManager esté funcionando
      if (typeof dropdownManager !== 'undefined') {
        console.log('DropdownManager inicializado correctamente');
        
        // Agregar event listeners adicionales para mayor robustez
        document.addEventListener('mousedown', (e) => {
          if (!e.target.closest('.dropdown-container') && !e.target.closest('.dropdown-list')) {
            dropdownManager.hideAll();
          }
        });
        
        document.addEventListener('touchstart', (e) => {
          if (!e.target.closest('.dropdown-container') && !e.target.closest('.dropdown-list')) {
            dropdownManager.hideAll();
          }
        });
      } else {
        console.error('DropdownManager no está disponible');
      }
      
      // Registrar Service Worker para funcionalidad offline
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('Service Worker registrado:', registration);
          })
          .catch((error) => {
            console.log('Error al registrar Service Worker:', error);
          });
      }

      // Detectar estado de conexión
      function updateOnlineStatus() {
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
          if (navigator.onLine) {
            statusElement.textContent = '🟢 En línea';
            statusElement.style.color = '#16a34a';
          } else {
            statusElement.textContent = '🔴 Sin conexión';
            statusElement.style.color = '#dc2626';
          }
        }
      }

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus();
      
      // listeners
      $('#farmName').addEventListener('input', () => { store.farmName = $('#farmName').value; saveStore(); });
      $('#importFile').addEventListener('change', importJSON);
      
      // Event listeners para fotos
      $('#a-photo').addEventListener('change', handleAnimalPhoto);
      $('#p-photo').addEventListener('change', handlePaddockPhoto);
      $('#farmLogo').addEventListener('change', handleFarmLogo);
      
      // Event listeners para ventas
      $('#v-price-per-kg').addEventListener('input', calculateTotal);
      $('#v-weight').addEventListener('input', calculateTotal);
      
      // selects iniciales
      renderAll();
      
      // Forzar creación de datos de prueba y renderizado de alertas
      setTimeout(() => {
        createTestData();
        renderStats();
        console.log('🔔 Forzando renderizado de alertas...');
        
        // Verificar alertas
        const alerts = checkReproductiveAlerts();
        console.log('📊 Alertas encontradas:', alerts.length);
        alerts.forEach(alert => {
          console.log(`  - ${alert.title}: ${alert.message}`);
        });
        
        // Forzar renderizado adicional
        setTimeout(() => {
          renderStats();
        }, 500);
      }, 1000);
      
      // Verificar que Leaflet esté cargado
      if (typeof L !== 'undefined') {
        console.log('Leaflet cargado correctamente');
      } else {
        console.error('Leaflet no está cargado');
      }
      
      // Cargar logo de la granja desde localStorage
      const farmLogo = localStorage.getItem('farm_logo');
      if (farmLogo) {
        const logoElement = document.querySelector('.logo');
        if (logoElement) {
          logoElement.innerHTML = `<img src="${farmLogo}" style="max-width: 50px; max-height: 50px; border-radius: 8px;" />`;
        }
      }
      
      // Mostrar modal de descarga después de 2 segundos (solo si no se ha mostrado antes)
      setTimeout(() => {
        const hasShownDownloadModal = localStorage.getItem('genegan_download_modal_shown');
        if (!hasShownDownloadModal) {
          showDownloadModal();
          localStorage.setItem('genegan_download_modal_shown', 'true');
        }
      }, 2000);
    });

    function closeWelcome(){ $('#welcome').style.display='none'; }

    function showTab(id, btn){
      // Ocultar todas las pestañas
      $$('.tab').forEach(t=>{
        t.classList.remove('active');
        t.style.display = 'none';
      });
      
      // Mostrar la pestaña seleccionada
      const selectedTab = $(`#${id}`);
      selectedTab.classList.add('active');
      selectedTab.style.display = 'block';
      
      if(btn){
        $$('.nav-button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      }
      
      // Renderizar contenido específico de la pestaña
      if (id === 'tab-dashboard') {
        renderStats();
        // Forzar renderizado de alertas en el panel principal
        setTimeout(() => {
          renderStats();
          console.log('🔔 Forzando alertas en dashboard...');
          
          // Verificar alertas
          const alerts = checkReproductiveAlerts();
          console.log('📊 Alertas en dashboard:', alerts.length);
          
          // Forzar visualización del contenedor de alertas
          const dashboardAlerts = document.getElementById('dashboard-alerts');
          if (dashboardAlerts && alerts.length > 0) {
            dashboardAlerts.style.display = 'block';
            dashboardAlerts.style.visibility = 'visible';
            console.log('✅ Contenedor de alertas forzado a ser visible');
          }
        }, 100);
      } else if (id === 'tab-animals') {
        renderAnimals();
        renderPaddockSelects();
      } else if (id === 'tab-potreros') {
        renderPaddocks();
      } else if (id === 'tab-repro') {
        renderServices();
        renderAnimalSelects();
      } else if (id === 'tab-salud') {
        renderHealth();
        renderHealthSelects();
      } else if (id === 'tab-graficos') {
        // Renderizar gráficos cuando se muestre la pestaña
        console.log('=== ACTIVANDO PESTAÑA DE GRÁFICOS ===');
        
        // Forzar que la pestaña sea visible y activa
        const graficosTab = document.getElementById('tab-graficos');
        if (graficosTab) {
          graficosTab.style.display = 'block';
          graficosTab.style.visibility = 'visible';
          graficosTab.classList.add('active');
          console.log('✅ Pestaña de gráficos activada');
        } else {
          console.error('❌ No se encontró la pestaña de gráficos');
        }
        
        // Forzar que todos los contenedores de gráficos sean visibles
        const chartContainers = ['weightChart', 'breedChart', 'healthChart', 'paddockChart', 'weaningChart'];
        chartContainers.forEach(id => {
          const container = document.getElementById(id);
          if (container) {
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.height = '300px';
            container.style.width = '100%';
            container.style.minHeight = '300px';
            container.style.border = '1px solid #ccc';
            console.log(`✅ Contenedor ${id} forzado a ser visible`);
          } else {
            console.error(`❌ No se encontró el contenedor ${id}`);
          }
        });
        
        // Ocultar gráficos de ventas en la pestaña de gráficos generales
        const ventasChartContainers = ['salesChart', 'profitChart', 'cashFlowChart', 'priceChart'];
        ventasChartContainers.forEach(id => {
          const container = document.getElementById(id);
          if (container) {
            container.style.display = 'none';
            console.log(`✅ Gráfico de ventas ${id} oculto en gráficos generales`);
          }
        });
        
        // Mostrar solo gráficos generales
        const generalChartContainers = ['genderChart', 'ageChart', 'weightRangeChart', 'locationChart', 'productivityChart', 'healthTypeChart', 'comprehensiveChart'];
        generalChartContainers.forEach(id => {
          const container = document.getElementById(id);
          if (container) {
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.height = '300px';
            container.style.width = '100%';
            container.style.minHeight = '300px';
            console.log(`✅ Contenedor de gráficos generales ${id} visible`);
          } else {
            console.error(`❌ No se encontró el contenedor de gráficos ${id}`);
          }
        });
        
        // Renderizar gráficos una sola vez sin notificaciones
        setTimeout(() => {
          console.log('🔄 Renderizando gráficos...');
          renderAllCharts();
        }, 500);
      } else if (id === 'tab-ventas') {
        // Renderizar ventas cuando se muestre la pestaña
        console.log('=== ACTIVANDO PESTAÑA DE VENTAS ===');
        
        // Forzar que la pestaña sea visible y activa
        const ventasTab = document.getElementById('tab-ventas');
        if (ventasTab) {
          ventasTab.style.display = 'block';
          ventasTab.style.visibility = 'visible';
          ventasTab.classList.add('active');
          console.log('✅ Pestaña de ventas activada');
        } else {
          console.error('❌ No se encontró la pestaña de ventas');
        }
        
        // Ocultar gráficos generales en la pestaña de ventas
        const generalChartContainers = ['genderChart', 'ageChart', 'weightRangeChart', 'locationChart', 'productivityChart', 'healthTypeChart', 'comprehensiveChart'];
        generalChartContainers.forEach(id => {
          const container = document.getElementById(id);
          if (container) {
            container.style.display = 'none';
            console.log(`✅ Gráfico general ${id} oculto en ventas`);
          }
        });
        
        // Mostrar solo gráficos de ventas
        const ventasChartContainers = ['salesChart', 'profitChart', 'cashFlowChart', 'priceChart'];
        ventasChartContainers.forEach(id => {
          const container = document.getElementById(id);
          if (container) {
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.height = '300px';
            container.style.width = '100%';
            container.style.minHeight = '300px';
            console.log(`✅ Contenedor de ventas ${id} visible`);
          } else {
            console.error(`❌ No se encontró el contenedor de ventas ${id}`);
          }
        });
        
        // Renderizar gráficos de ventas específicos
        setTimeout(() => {
          console.log('🔄 Renderizando gráficos de ventas específicos...');
          renderSalesCharts();
        }, 500);
      }
    }

    function renderAll(){
      renderPaddockSelects();
      renderAnimals();
      renderPaddocks();
      renderReproSelects();
      renderServices();
      renderHealthSelects();
      renderHealth();
      renderStats();
      renderBreedDropdown();
      renderSalesAnimalSelect();
      renderTransactions();
      updateFinancialSummary();
      
      // Forzar renderizado de alertas en el panel principal
      setTimeout(() => {
        renderStats();
      }, 100);
      
      // Verificar si hay datos para gráficos y crear datos de prueba si es necesario
      if (store.animals.length === 0 && store.paddocks.length === 0) {
        console.log('📝 No hay datos en el sistema, creando datos de prueba automáticamente...');
        createTestData();
        showNotification('info', 'Datos de Prueba', 'Se han creado datos de prueba automáticamente para mostrar los gráficos');
      }
      
      // Forzar renderizado de alertas después de crear datos de prueba
      setTimeout(() => {
        renderStats();
        // Forzar renderizado adicional para asegurar que aparezcan las alertas
        setTimeout(() => {
          renderStats();
        }, 200);
      }, 500);
      
      // Actualizar resúmenes de venta de gráficos
      updateSalesSummaries();
    }

    /* =====================================
       Panel / KPIs
       ===================================== */
    function renderStats(){
      const stats = $('#stats');
      const dashboardStats = $('#dashboard-stats');
      const totalAnimals = store.animals.length;
      const totalPaddocks = store.paddocks.length;
      const females = store.animals.filter(a=>a.sex==='Hembra').length;
      const males = store.animals.filter(a=>a.sex==='Macho').length;
      const pregnant = store.services.filter(s=>{
        // embarazada si existe servicio y no se registró parto asociado (aprox.)
        const birthDone = store.animals.some(a=>a.motherId===s.femaleId && new Date(a.dob) > new Date(s.date));
        return !birthDone;}).length;

      // Obtener alertas
      const alerts = checkReproductiveAlerts();
      const criticalAlerts = alerts.filter(a => a.priority === 'error').length;
      const warningAlerts = alerts.filter(a => a.priority === 'warning').length;

      // Renderizar stats para el tab de gráficos
      if (stats) {
        stats.innerHTML = `
          <div class="card" style="border-left-color:#1d4ed8"><h3>🐄 Animales</h3><p style="font-size:28px; font-weight:900;">${totalAnimals}</p></div>
          <div class="card" style="border-left-color:#f59e0b"><h3>🌿 Potreros</h3><p style="font-size:28px; font-weight:900;">${totalPaddocks}</p></div>
          <div class="card" style="border-left-color:#16a34a"><h3>👩‍🌾 Hembras</h3><p style="font-size:28px; font-weight:900;">${females}</p></div>
          <div class="card" style="border-left-color:#16a34a"><h3>👨‍🌾 Machos</h3><p style="font-size:28px; font-weight:900;">${males}</p></div>
          <div class="card" style="border-left-color:#ef4444"><h3>🤰 Servicios activos</h3><p style="font-size:28px; font-weight:900;">${pregnant}</p></div>
          ${criticalAlerts > 0 ? `<div class="card" style="border-left-color:#dc2626; background: linear-gradient(135deg, #fef2f2, #fee2e2);"><h3>🚨 Alertas críticas</h3><p style="font-size:28px; font-weight:900; color:#dc2626;">${criticalAlerts}</p></div>` : ''}
          ${warningAlerts > 0 ? `<div class="card" style="border-left-color:#f59e0b; background: linear-gradient(135deg, #fffbeb, #fef3c7);"><h3>⚠️ Alertas</h3><p style="font-size:28px; font-weight:900; color:#d97706;">${warningAlerts}</p></div>` : ''}
        `;
      }

      // Renderizar stats para el panel principal
      if (dashboardStats) {
        dashboardStats.innerHTML = `
          <div class="card" style="border-left-color:#1d4ed8"><h3>🐄 Animales</h3><p style="font-size:28px; font-weight:900;">${totalAnimals}</p></div>
          <div class="card" style="border-left-color:#f59e0b"><h3>🌿 Potreros</h3><p style="font-size:28px; font-weight:900;">${totalPaddocks}</p></div>
          <div class="card" style="border-left-color:#16a34a"><h3>👩‍🌾 Hembras</h3><p style="font-size:28px; font-weight:900;">${females}</p></div>
          <div class="card" style="border-left-color:#16a34a"><h3>👨‍🌾 Machos</h3><p style="font-size:28px; font-weight:900;">${males}</p></div>
          <div class="card" style="border-left-color:#ef4444"><h3>🤰 Servicios activos</h3><p style="font-size:28px; font-weight:900;">${pregnant}</p></div>
          ${criticalAlerts > 0 ? `<div class="card" style="border-left-color:#dc2626; background: linear-gradient(135deg, #fef2f2, #fee2e2);"><h3>🚨 Alertas críticas</h3><p style="font-size:28px; font-weight:900; color:#dc2626;">${criticalAlerts}</p></div>` : ''}
          ${warningAlerts > 0 ? `<div class="card" style="border-left-color:#f59e0b; background: linear-gradient(135deg, #fffbeb, #fef3c7);"><h3>⚠️ Alertas</h3><p style="font-size:28px; font-weight:900; color:#d97706;">${warningAlerts}</p></div>` : ''}
        `;
      }

      // Mostrar alertas importantes en el dashboard de gráficos
      if (alerts.length > 0) {
        const graficosSection = document.querySelector('#tab-graficos');
        let alertsSection = graficosSection.querySelector('.alerts-section');
        
        if (!alertsSection) {
          alertsSection = document.createElement('div');
          alertsSection.className = 'card alerts-section';
          alertsSection.style.background = 'linear-gradient(135deg, #fef2f2, #fee2e2)';
          alertsSection.style.border = '3px solid #dc2626';
          alertsSection.style.marginTop = '20px';
          graficosSection.appendChild(alertsSection);
        }
        
        // Ordenar alertas por prioridad y días hasta el parto
        const sortedAlerts = alerts.sort((a, b) => {
          if (a.priority === 'error' && b.priority !== 'error') return -1;
          if (a.priority !== 'error' && b.priority === 'error') return 1;
          if (a.priority === 'warning' && b.priority === 'info') return -1;
          if (a.priority === 'info' && b.priority === 'warning') return 1;
          return (a.daysUntilBirth || 0) - (b.daysUntilBirth || 0);
        });
        
        const alertsList = sortedAlerts.slice(0, 5).map(alert => `
          <div style="padding: 16px; margin: 12px 0; border-radius: 12px; background: ${alert.priority === 'error' ? '#fef2f2' : alert.priority === 'warning' ? '#fffbeb' : '#eff6ff'}; border-left: 6px solid ${alert.priority === 'error' ? '#dc2626' : alert.priority === 'warning' ? '#f59e0b' : '#2563eb'}; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <div style="font-weight: bold; font-size: 16px; color: ${alert.priority === 'error' ? '#dc2626' : alert.priority === 'warning' ? '#d97706' : '#2563eb'}; margin-bottom: 8px;">${alert.title}</div>
            <div style="font-size: 14px; color: #6b7280;">${alert.message}</div>
          </div>
        `).join('');
        
        alertsSection.innerHTML = `
          <h2 style="color: #dc2626; text-align: center; margin-bottom: 20px;">🚨 Alertas Reproductivas (${alerts.length})</h2>
          ${alertsList}
          ${alerts.length > 5 ? `<div style="text-align: center; margin-top: 16px;"><small style="color: #6b7280; font-weight: bold;">Y ${alerts.length - 5} alertas más...</small></div>` : ''}
        `;
      } else {
        // Remover sección de alertas si no hay ninguna
        const alertsSection = document.querySelector('.alerts-section');
        if (alertsSection) {
          alertsSection.remove();
        }
      }

      // Mostrar alertas en el panel principal
      const dashboardAlerts = document.getElementById('dashboard-alerts');
      const dashboardAlertsContent = document.getElementById('dashboard-alerts-content');
      
      if (alerts.length > 0 && dashboardAlerts && dashboardAlertsContent) {
        // Ordenar alertas por prioridad
        const sortedAlerts = alerts.sort((a, b) => {
          if (a.priority === 'error' && b.priority !== 'error') return -1;
          if (a.priority !== 'error' && b.priority === 'error') return 1;
          if (a.priority === 'warning' && b.priority === 'info') return -1;
          if (a.priority === 'info' && b.priority === 'warning') return 1;
          return (a.daysUntilBirth || 0) - (b.daysUntilBirth || 0);
        });
        
        const alertsList = sortedAlerts.slice(0, 3).map(alert => `
          <div style="padding: 12px; margin: 8px 0; border-radius: 8px; background: ${alert.priority === 'error' ? '#fef2f2' : alert.priority === 'warning' ? '#fffbeb' : '#eff6ff'}; border-left: 4px solid ${alert.priority === 'error' ? '#dc2626' : alert.priority === 'warning' ? '#f59e0b' : '#2563eb'};">
            <div style="font-weight: bold; color: ${alert.priority === 'error' ? '#dc2626' : alert.priority === 'warning' ? '#d97706' : '#2563eb'}; font-size: 14px;">${alert.title}</div>
            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${alert.message}</div>
          </div>
        `).join('');
        
        dashboardAlertsContent.innerHTML = alertsList;
        dashboardAlerts.style.display = 'block';
        
        // Cambiar el color del borde según la prioridad más alta
        const highestPriority = sortedAlerts[0].priority;
        if (highestPriority === 'error') {
          dashboardAlerts.style.border = '3px solid #dc2626';
          dashboardAlerts.style.background = 'linear-gradient(135deg, #fef2f2, #fee2e2)';
        } else if (highestPriority === 'warning') {
          dashboardAlerts.style.border = '3px solid #f59e0b';
          dashboardAlerts.style.background = 'linear-gradient(135deg, #fffbeb, #fef3c7)';
        } else {
          dashboardAlerts.style.border = '3px solid #2563eb';
          dashboardAlerts.style.background = 'linear-gradient(135deg, #eff6ff, #dbeafe)';
        }
      } else if (dashboardAlerts) {
        dashboardAlerts.style.display = 'none';
      }
    }

    /* =====================================
       Listas desplegables
       ===================================== */
    
    // Funciones para razas
    function renderBreedDropdown() {
      const dropdown = $('#breed-dropdown');
      const breeds = [...new Set([...store.breeds, ...store.animals.map(a => a.breed).filter(b => b)])];
      console.log('Razas disponibles:', breeds);
      dropdown.innerHTML = breeds.map(breed => 
        `<div class="dropdown-item" onclick="selectBreed('${breed}')">${breed}</div>`
      ).join('') + '<div class="dropdown-item add-new" onclick="addNewBreed()">+ Agregar nueva raza</div>';
    }
    
    function showBreedDropdown() {
      console.log('Mostrando dropdown de razas');
      const dropdown = $('#breed-dropdown');
      if (dropdown) {
        // Asegurar que el dropdown tenga contenido actualizado
        renderBreedDropdown();
        dropdownManager.show(dropdown);
        
        // Forzar el foco en el input para mantener el dropdown abierto
        setTimeout(() => {
          $('#a-breed').focus();
        }, 50);
      }
    }
    
    function filterBreeds(query) {
      const dropdown = $('#breed-dropdown');
      const items = dropdown.querySelectorAll('.dropdown-item');
      const breeds = [...new Set([...store.breeds, ...store.animals.map(a => a.breed).filter(b => b)])];
      
      items.forEach((item, index) => {
        if (index < breeds.length) {
          const breed = breeds[index];
          if (breed.toLowerCase().includes(query.toLowerCase())) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        }
      });
    }
    
    function selectBreed(breed) {
      console.log('Seleccionando raza:', breed);
      $('#a-breed').value = breed;
      // Ocultar dropdown inmediatamente después de seleccionar
      dropdownManager.hideAll();
    }
    
    function addNewBreed() {
      const newBreed = prompt('Ingresa el nombre de la nueva raza:');
      if (newBreed && newBreed.trim()) {
        if (!store.breeds.includes(newBreed.trim())) {
          store.breeds.push(newBreed.trim());
          saveStore();
        }
        $('#a-breed').value = newBreed.trim();
      }
      // Ocultar dropdown inmediatamente después de agregar
      dropdownManager.hideAll();
    }
    
    // Función para probar el nuevo sistema de dropdowns
    function testNewDropdownSystem() {
      console.log('=== TESTING NEW DROPDOWN SYSTEM ===');
      console.log('DropdownManager instance:', dropdownManager);
      console.log('Active dropdown:', dropdownManager.activeDropdown);
      
      // Probar mostrar dropdown de razas
      const breedDropdown = $('#breed-dropdown');
      if (breedDropdown) {
        console.log('Mostrando dropdown de razas con nuevo sistema...');
        dropdownManager.show(breedDropdown);
        
        // Ocultar después de 3 segundos
        setTimeout(() => {
          console.log('Ocultando dropdown de razas...');
          dropdownManager.hideAll();
        }, 3000);
      }
      
      showNotification('info', 'Test Nuevo Sistema', 'Dropdown de razas mostrado por 3 segundos. Revisa la consola.');
    }

    // Función de prueba para debugging
    function testDropdowns() {
      console.log('=== TESTING DROPDOWNS ===');
      console.log('Store breeds:', store.breeds);
      console.log('Store procedures:', store.procedures);
      console.log('Store diseases:', store.diseases);
      
      const breedDropdown = $('#breed-dropdown');
      const healthDropdown = $('#health-dropdown');
      
      console.log('Breed dropdown element:', breedDropdown);
      console.log('Health dropdown element:', healthDropdown);
      console.log('DropdownManager:', dropdownManager);
      
      // Forzar renderizado de dropdowns
      renderBreedDropdown();
      updateHealthDropdowns();
      
      // Mostrar dropdowns usando el nuevo sistema
      dropdownManager.show(breedDropdown);
      $('#s-event-type').value = 'procedimiento';
      dropdownManager.show(healthDropdown);
      
      showNotification('info', 'Test de Dropdowns', 'Revisa la consola para ver el estado de los dropdowns. Los dropdowns deberían ocultarse al hacer clic fuera o cambiar de campo.');
    }

    // Función de debug para dropdowns
    function debugDropdowns() {
      console.log('=== DEBUG DROPDOWNS ===');
      
      const breedInput = $('#a-breed');
      const breedDropdown = $('#breed-dropdown');
      const healthInput = $('#s-type');
      const healthDropdown = $('#health-dropdown');
      
      console.log('Breed Input:', breedInput);
      console.log('Breed Dropdown:', breedDropdown);
      console.log('Health Input:', healthInput);
      console.log('Health Dropdown:', healthDropdown);
      
      console.log('Breed Input Events:', breedInput.onclick, breedInput.onfocus);
      console.log('Health Input Events:', healthInput.onclick, healthInput.onfocus);
      
      console.log('Breed Dropdown Classes:', breedDropdown.className);
      console.log('Health Dropdown Classes:', healthDropdown.className);
      
      console.log('Breed Dropdown Style:', {
        display: breedDropdown.style.display,
        visibility: breedDropdown.style.visibility,
        opacity: breedDropdown.style.opacity,
        zIndex: breedDropdown.style.zIndex
      });
      
      console.log('Health Dropdown Style:', {
        display: healthDropdown.style.display,
        visibility: healthDropdown.style.visibility,
        opacity: healthDropdown.style.opacity,
        zIndex: healthDropdown.style.zIndex
      });
      
      showNotification('info', 'Debug Dropdowns', 'Información de debug enviada a la consola');
    }
    
    // Funciones para salud (procedimientos y enfermedades)
    function updateHealthDropdowns() {
      const eventType = $('#s-event-type').value;
      const dropdown = $('#health-dropdown');
      console.log('Actualizando dropdown de salud, tipo:', eventType);
      
      if (eventType === 'procedimiento') {
        const procedures = [...new Set([...store.procedures, ...store.health.filter(h => h.eventType === 'procedimiento').map(h => h.type).filter(t => t)])];
        console.log('Procedimientos disponibles:', procedures);
        dropdown.innerHTML = procedures.map(proc => 
          `<div class="dropdown-item" onclick="selectHealthItem('${proc}')">${proc}</div>`
        ).join('') + '<div class="dropdown-item add-new" onclick="addNewProcedure()">+ Agregar nuevo procedimiento</div>';
      } else if (eventType === 'enfermedad') {
        const diseases = [...new Set([...store.diseases, ...store.health.filter(h => h.eventType === 'enfermedad').map(h => h.type).filter(t => t)])];
        console.log('Enfermedades disponibles:', diseases);
        dropdown.innerHTML = diseases.map(disease => 
          `<div class="dropdown-item" onclick="selectHealthItem('${disease}')">${disease}</div>`
        ).join('') + '<div class="dropdown-item add-new" onclick="addNewDisease()">+ Agregar nueva enfermedad</div>';
      } else {
        dropdown.innerHTML = '<div class="dropdown-item" onclick="selectHealthItem(\'Otro\')">Otro</div>';
      }
    }
    
    function showHealthDropdown() {
      const eventType = $('#s-event-type').value;
      if (eventType) {
        const dropdown = $('#health-dropdown');
        if (dropdown) {
          // Asegurar que el dropdown tenga contenido actualizado
          updateHealthDropdowns();
          dropdownManager.show(dropdown);
          
          // Forzar el foco en el input para mantener el dropdown abierto
          setTimeout(() => {
            $('#s-type').focus();
          }, 50);
        }
      } else {
        showNotification('warning', 'Selección requerida', 'Primero selecciona el tipo de evento');
        $('#s-event-type').focus();
      }
    }
    
    function filterHealthItems(query) {
      const dropdown = $('#health-dropdown');
      const items = dropdown.querySelectorAll('.dropdown-item');
      const eventType = $('#s-event-type').value;
      
      let itemsList = [];
      if (eventType === 'procedimiento') {
        itemsList = [...new Set([...store.procedures, ...store.health.filter(h => h.eventType === 'procedimiento').map(h => h.type).filter(t => t)])];
      } else if (eventType === 'enfermedad') {
        itemsList = [...new Set([...store.diseases, ...store.health.filter(h => h.eventType === 'enfermedad').map(h => h.type).filter(t => t)])];
      }
      
      items.forEach((item, index) => {
        if (index < itemsList.length) {
          const itemText = itemsList[index];
          if (itemText.toLowerCase().includes(query.toLowerCase())) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        }
      });
    }
    
    function selectHealthItem(item) {
      console.log('Seleccionando item de salud:', item);
      $('#s-type').value = item;
      // Ocultar dropdown inmediatamente después de seleccionar
      dropdownManager.hideAll();
    }
    
    function addNewProcedure() {
      const newProc = prompt('Ingresa el nuevo procedimiento:');
      if (newProc && newProc.trim()) {
        if (!store.procedures.includes(newProc.trim())) {
          store.procedures.push(newProc.trim());
          saveStore();
        }
        $('#s-type').value = newProc.trim();
      }
      // Ocultar dropdown inmediatamente después de agregar
      dropdownManager.hideAll();
    }
    
    function addNewDisease() {
      const newDisease = prompt('Ingresa la nueva enfermedad:');
      if (newDisease && newDisease.trim()) {
        if (!store.diseases.includes(newDisease.trim())) {
          store.diseases.push(newDisease.trim());
          saveStore();
        }
        $('#s-type').value = newDisease.trim();
      }
      // Ocultar dropdown inmediatamente después de agregar
      dropdownManager.hideAll();
    }
    
    // Función mejorada para ocultar todos los dropdowns
    function hideAllDropdowns() {
      console.log('Ocultando todos los dropdowns');
      $$('.dropdown-list').forEach(dropdown => {
        dropdown.classList.remove('active');
        dropdown.style.display = 'none';
        dropdown.style.visibility = 'hidden';
        dropdown.style.opacity = '0';
      });
    }

    // Sistema simplificado de manejo de dropdowns - VERSIÓN FINAL
    class DropdownManager {
      constructor() {
        this.activeDropdown = null;
        this.isInitialized = false;
        this.init();
      }

      init() {
        if (this.isInitialized) return;
        
        console.log('=== INICIALIZANDO DROPDOWN MANAGER SIMPLIFICADO ===');
        
        // Event listener global para clicks fuera de dropdowns
        document.addEventListener('click', (e) => {
          this.handleGlobalClick(e);
        }, true);

        // Event listener para tecla Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            this.hideAll();
          }
        });

        // Event listener para cambio de pestaña
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            this.hideAll();
          }
        });

        // Event listener para focusout con delay más largo
        document.addEventListener('focusout', (e) => {
          if (e.target.classList.contains('dropdown-input')) {
            setTimeout(() => {
              this.handleFocusOut(e);
            }, 300); // Delay más largo para evitar cierre prematuro
          }
        });

        // Event listener para resize
        window.addEventListener('resize', () => {
          this.hideAll();
        });

        this.isInitialized = true;
        console.log('DropdownManager simplificado inicializado');
      }

      handleGlobalClick(e) {
        // Si el click no es en un dropdown o su contenedor, ocultar todos
        if (!e.target.closest('.dropdown-container') && !e.target.closest('.dropdown-list')) {
          console.log('Click fuera de dropdown detectado, ocultando...');
          this.hideAll();
        }
      }

      handleFocusOut(e) {
        const dropdown = e.target.nextElementSibling;
        if (dropdown && dropdown.classList.contains('dropdown-list')) {
          const activeElement = document.activeElement;
          // Si el nuevo elemento enfocado no está dentro del dropdown, ocultarlo
          if (!dropdown.contains(activeElement)) {
            console.log('Focus fuera de dropdown detectado, ocultando...');
            this.hideAll();
          }
        }
      }

      show(dropdownElement) {
        // Ocultar todos los dropdowns primero
        this.hideAll();
        
        // Mostrar el dropdown específico
        if (dropdownElement) {
          dropdownElement.classList.add('active');
          dropdownElement.style.display = 'block';
          dropdownElement.style.visibility = 'visible';
          dropdownElement.style.opacity = '1';
          dropdownElement.style.zIndex = '9999';
          dropdownElement.style.pointerEvents = 'auto';
          this.activeDropdown = dropdownElement;
          
          // Asegurar que el dropdown sea scrolleable
          dropdownElement.style.overflowY = 'auto';
          dropdownElement.style.overflowX = 'hidden';
          
          console.log('Dropdown mostrado:', dropdownElement.id);
        }
      }

      hideAll() {
        console.log('=== OCULTANDO TODOS LOS DROPDOWNS ===');
        const dropdowns = document.querySelectorAll('.dropdown-list');
        console.log('Dropdowns encontrados:', dropdowns.length);
        
        dropdowns.forEach((dropdown, index) => {
          console.log(`Ocultando dropdown ${index + 1}:`, dropdown.id);
          dropdown.classList.remove('active');
          dropdown.style.display = 'none';
          dropdown.style.visibility = 'hidden';
          dropdown.style.opacity = '0';
          dropdown.style.zIndex = '-1';
          dropdown.style.pointerEvents = 'none';
        });
        
        this.activeDropdown = null;
        console.log('Todos los dropdowns ocultados');
      }

      hide(dropdownElement) {
        if (dropdownElement) {
          dropdownElement.classList.remove('active');
          dropdownElement.style.display = 'none';
          dropdownElement.style.visibility = 'hidden';
          dropdownElement.style.opacity = '0';
          dropdownElement.style.zIndex = '-1';
          dropdownElement.style.pointerEvents = 'none';
          if (this.activeDropdown === dropdownElement) {
            this.activeDropdown = null;
          }
        }
      }
    }

    // Instanciar el manager de dropdowns
    const dropdownManager = new DropdownManager();

    // Prevenir que el scroll del dropdown se propague al documento
    document.addEventListener('DOMContentLoaded', () => {
      document.addEventListener('wheel', (e) => {
        const dropdown = e.target.closest('.dropdown-list');
        if (dropdown) {
          e.stopPropagation();
        }
      }, { passive: false });
    });

    // Cerrar dropdowns al hacer clic fuera (mantener para compatibilidad)
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.dropdown-container')) {
        hideAllDropdowns();
      }
    });

    // Cerrar dropdowns al perder el foco (mantener para compatibilidad)
    document.addEventListener('focusout', function(e) {
      if (e.target.classList.contains('dropdown-input')) {
        setTimeout(() => {
          const dropdown = e.target.nextElementSibling;
          if (dropdown && dropdown.classList.contains('dropdown-list')) {
            const activeElement = document.activeElement;
            if (!dropdown.contains(activeElement)) {
              dropdown.classList.remove('active');
              dropdown.style.display = 'none';
            }
          }
        }, 100);
      }
    });

    // Cerrar dropdowns al presionar Escape (mantener para compatibilidad)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideAllDropdowns();
      }
    });

    // Cerrar dropdowns al cambiar de pestaña (mantener para compatibilidad)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        hideAllDropdowns();
      }
    });

    /* =====================================
       Animales
       ===================================== */
    let weightModalAnimalId = null;

    // Funciones para manejo de fotos
    function handleAnimalPhoto(event) {
      const file = event.target.files[0];
      if (file) {
        // Validar tipo de archivo
        if (!file.type.startsWith('image/')) {
          showNotification('error', 'Error', 'Por favor selecciona un archivo de imagen válido');
          event.target.value = '';
          return;
        }
        
        // Validar tamaño (máximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
          showNotification('error', 'Error', 'La imagen es demasiado grande. Máximo 5MB');
          event.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // Mostrar preview de la foto
            const preview = document.createElement('img');
            preview.src = e.target.result;
            preview.style.maxWidth = '100px';
            preview.style.maxHeight = '100px';
            preview.style.marginTop = '10px';
            preview.style.borderRadius = '8px';
            preview.style.border = '2px solid #16a34a';
            
            // Remover preview anterior si existe
            const existingPreview = event.target.parentNode.querySelector('.photo-preview');
            if (existingPreview) {
              existingPreview.remove();
            }
            
            preview.className = 'photo-preview';
            event.target.parentNode.appendChild(preview);
            
            showNotification('success', 'Éxito', 'Foto cargada correctamente');
          } catch (error) {
            console.error('Error al procesar la imagen:', error);
            showNotification('error', 'Error', 'Error al procesar la imagen');
          }
        };
        reader.onerror = function() {
          showNotification('error', 'Error', 'Error al leer el archivo');
        };
        reader.readAsDataURL(file);
      }
    }

    function handlePaddockPhoto(event) {
      const file = event.target.files[0];
      if (file) {
        // Validar tipo de archivo
        if (!file.type.startsWith('image/')) {
          showNotification('error', 'Error', 'Por favor selecciona un archivo de imagen válido');
          event.target.value = '';
          return;
        }
        
        // Validar tamaño (máximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
          showNotification('error', 'Error', 'La imagen es demasiado grande. Máximo 5MB');
          event.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // Mostrar preview de la foto
            const preview = document.createElement('img');
            preview.src = e.target.result;
            preview.style.maxWidth = '100px';
            preview.style.maxHeight = '100px';
            preview.style.marginTop = '10px';
            preview.style.borderRadius = '8px';
            preview.style.border = '2px solid #16a34a';
            
            // Remover preview anterior si existe
            const existingPreview = event.target.parentNode.querySelector('.photo-preview');
            if (existingPreview) {
              existingPreview.remove();
            }
            
            preview.className = 'photo-preview';
            event.target.parentNode.appendChild(preview);
            
            showNotification('success', 'Éxito', 'Foto del potrero cargada correctamente');
          } catch (error) {
            console.error('Error al procesar la imagen:', error);
            showNotification('error', 'Error', 'Error al procesar la imagen');
          }
        };
        reader.onerror = function() {
          showNotification('error', 'Error', 'Error al leer el archivo');
        };
        reader.readAsDataURL(file);
      }
    }

    function handleFarmLogo(event) {
      const file = event.target.files[0];
      if (file) {
        // Validar tipo de archivo
        if (!file.type.startsWith('image/')) {
          showNotification('error', 'Error', 'Por favor selecciona un archivo de imagen válido');
          event.target.value = '';
          return;
        }
        
        // Validar tamaño (máximo 2MB para logo)
        if (file.size > 2 * 1024 * 1024) {
          showNotification('error', 'Error', 'El logo es demasiado grande. Máximo 2MB');
          event.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // Actualizar el logo de la granja
            const logoElement = document.querySelector('.logo');
            if (logoElement) {
              logoElement.innerHTML = `<img src="${e.target.result}" style="max-width: 50px; max-height: 50px; border-radius: 8px; border: 2px solid #86efac;" />`;
            }
            // Guardar en localStorage
            localStorage.setItem('farm_logo', e.target.result);
            showNotification('success', 'Éxito', 'Logo de la granja actualizado correctamente');
          } catch (error) {
            console.error('Error al procesar el logo:', error);
            showNotification('error', 'Error', 'Error al procesar el logo');
          }
        };
        reader.onerror = function() {
          showNotification('error', 'Error', 'Error al leer el archivo');
        };
        reader.readAsDataURL(file);
      }
    }

    function clearAnimalForm(){
      ['a-id','a-name','a-breed','a-dob','a-weight','a-notes'].forEach(id=>{ $(`#${id}`).value=''; });
      $('#a-sex').value='Hembra';
      $('#a-paddock').value='';
      $('#a-photo').value='';
      // Remover preview de foto
      const previews = document.querySelectorAll('.photo-preview');
      previews.forEach(preview => preview.remove());
      dropdownManager.hideAll();
    }

    async function saveAnimal(){
      const id = $('#a-id').value.trim();
      if(!id){ 
        showNotification('error', 'Error', 'El ID del animal es obligatorio');
        return; 
      }
      
      const existing = store.animals.find(a=>a.id===id);
      let photo = existing?.photo || '';
      const f = $('#a-photo').files?.[0];
      if(f){ photo = await readFileAsDataURL(f); }

      const a = {
        id,
        name: $('#a-name').value.trim(),
        breed: $('#a-breed').value.trim(),
        sex: $('#a-sex').value,
        dob: $('#a-dob').value || '',
        paddockId: $('#a-paddock').value || '',
        notes: $('#a-notes').value.trim(),
        photo: photo || '',
        weights: existing?.weights || [],
        motherId: existing?.motherId || '',
        fatherId: existing?.fatherId || ''
      };
      
      const w = parseFloat($('#a-weight').value);
      if(!isNaN(w)){
        // agregar como registro de peso de hoy si es nuevo o cambió
        if(!existing || (existing && (!existing.weights?.length || existing.weights[existing.weights.length-1].kg!==w))){
          a.weights = [...(a.weights||[]), {date: today(), kg: w}];
        }
      }



      if(existing){
        Object.assign(existing, a);
        showNotification('success', 'Animal actualizado', `El animal ${a.id} ha sido actualizado exitosamente`);
      } else {
        store.animals.push(a);
        showNotification('success', 'Animal registrado', `El animal ${a.id} ha sido registrado exitosamente`);
      }
      
      saveStore();
      clearAnimalForm();
      
      // Verificar alertas reproductivas
      const alerts = checkReproductiveAlerts();
      alerts.forEach(alert => {
        showNotification(alert.priority, alert.title, alert.message, 8000);
      });
    }

    function renderAnimals(){
      const tbody = $('#animalsTable tbody');
      const q = ($('#animalSearch').value||'').toLowerCase();
      const paddockFilter = $('#filterPaddock').value||'';
      const rows = store.animals
        .filter(a=>!paddockFilter || a.paddockId===paddockFilter)
        .filter(a=>{
          const hay = (a.id+' '+(a.name||'')+' '+(a.breed||'')).toLowerCase();
          return hay.includes(q);
        })
        .sort((a,b)=>a.id.localeCompare(b.id))
        .map(a=>{
          const age = calcAge(a.dob);
          const lastW = a.weights?.length ? a.weights[a.weights.length-1].kg : '';
          const padd = store.paddocks.find(p=>p.id===a.paddockId)?.name || '';
          return `<tr>
            <td>${a.photo?`<img class="photo" src="${a.photo}"/>`:''}</td>
            <td>${a.id}</td>
            <td>${a.name||''}</td>
            <td>${a.breed||''}</td>
            <td>${a.sex||''}</td>
            <td>${age}</td>
            <td>${fmt(lastW,' kg')}</td>
            <td>${padd}</td>
            <td>
              <button class="btn btn-ghost" onclick="editAnimal('${a.id}')">✏️</button>
              <button class="btn btn-ghost" onclick="openWeights('${a.id}')">⚖️</button>
              <button class="btn btn-ghost" onclick="delAnimal('${a.id}')">🗑️</button>
            </td>
          </tr>`;
        }).join('');
      tbody.innerHTML = rows || `<tr><td colspan="9">Sin registros</td></tr>`;
    }

    function editAnimal(id){
      const a = store.animals.find(x=>x.id===id); if(!a) return;
      $('#a-id').value = a.id;
      $('#a-name').value = a.name||'';
      $('#a-breed').value = a.breed||'';
      $('#a-sex').value = a.sex||'Hembra';
      $('#a-dob').value = a.dob||'';
      $('#a-weight').value = a.weights?.length ? a.weights[a.weights.length-1].kg : '';
      $('#a-paddock').value = a.paddockId||'';
      $('#a-notes').value = a.notes||'';
      showTab('tab-animals', $$('.nav-button')[1]);
    }

    function delAnimal(id){
      if(!confirm('¿Eliminar animal y sus referencias?')) return;
      // quitar de servicios y salud también si aplica
      store.services = store.services.filter(s=>s.femaleId!==id && s.maleId!==id);
      store.health = store.health.filter(h=>h.animalId!==id);
      store.animals = store.animals.filter(a=>a.id!==id);
      saveStore();
    }

    // Pesos
    function openWeights(id){
      const a = store.animals.find(x=>x.id===id); if(!a) return;
      weightModalAnimalId = id;
      $('#wm-title').textContent = `${a.id} ${a.name?('— '+a.name):''}`;
      $('#wm-date').value = today();
      $('#wm-kg').value = '';
      renderWeightRows();
      $('#weightModal').classList.add('active');
    }
    function closeModal(id){ $(`#${id}`).classList.remove('active'); }

    /* =====================================
       Módulo de Ventas
       ===================================== */
    
    // Función para actualizar campos según tipo de transacción
    function updateTransactionFields() {
      const type = $('#v-type').value;
      const label = $('#v-buyer-seller').previousElementSibling;
      
      if (type === 'venta') {
        label.textContent = 'Comprador';
        $('#v-buyer-seller').placeholder = 'Nombre del comprador';
      } else if (type === 'compra') {
        label.textContent = 'Vendedor';
        $('#v-buyer-seller').placeholder = 'Nombre del vendedor';
      }
    }
    
    // Función para calcular el total automáticamente
    function calculateTotal() {
      const pricePerKg = parseFloat($('#v-price-per-kg').value) || 0;
      const weight = parseFloat($('#v-weight').value) || 0;
      const total = pricePerKg * weight;
      $('#v-total-price').value = total.toFixed(2);
    }
    
    // Función para limpiar formulario de transacción
    function clearTransactionForm() {
      ['v-type', 'v-animal', 'v-date', 'v-price-per-kg', 'v-weight', 'v-total-price', 'v-buyer-seller', 'v-document', 'v-phone', 'v-notes'].forEach(id => {
        $(`#${id}`).value = '';
      });
    }
    
    // Función para guardar transacción
    function saveTransaction() {
      const type = $('#v-type').value;
      const animalId = $('#v-animal').value;
      const date = $('#v-date').value;
      const pricePerKg = parseFloat($('#v-price-per-kg').value);
      const weight = parseFloat($('#v-weight').value);
      const totalPrice = parseFloat($('#v-total-price').value);
      const buyerSeller = $('#v-buyer-seller').value.trim();
      const document = $('#v-document').value.trim();
      const phone = $('#v-phone').value.trim();
      const notes = $('#v-notes').value.trim();
      
      if (!type || !animalId || !date || !pricePerKg || !weight || !totalPrice || !buyerSeller) {
        showNotification('error', 'Error', 'Completa todos los campos obligatorios');
        return;
      }
      
      const transaction = {
        id: uid(),
        type,
        animalId,
        date,
        pricePerKg,
        weight,
        totalPrice,
        buyerSeller,
        document,
        phone,
        notes,
        timestamp: new Date().toISOString()
      };
      
      store.transactions.push(transaction);
      saveStore();
      clearTransactionForm();
      renderTransactions();
      updateFinancialSummary();
      renderSalesCharts();
      
      const action = type === 'venta' ? 'vendido' : 'comprado';
      showNotification('success', 'Transacción Guardada', `Animal ${action} exitosamente por $${totalPrice.toLocaleString('es-CO')}`);
    }
    
    // Función para renderizar transacciones
    function renderTransactions() {
      const tbody = $('#transactionsTable tbody');
      const search = ($('#transactionSearch').value || '').toLowerCase();
      const typeFilter = $('#transactionTypeFilter').value;
      
      const filteredTransactions = store.transactions
        .filter(t => !typeFilter || t.type === typeFilter)
        .filter(t => {
          const animal = store.animals.find(a => a.id === t.animalId);
          const searchText = `${t.animalId} ${animal?.name || ''} ${t.buyerSeller} ${t.document}`.toLowerCase();
          return searchText.includes(search);
        })
        .sort((a, b) => new Date(b.date) - new Date(a.date));
      
      const rows = filteredTransactions.map(t => {
        const animal = store.animals.find(a => a.id === t.animalId);
        const typeIcon = t.type === 'venta' ? '💰' : '💸';
        const typeText = t.type === 'venta' ? 'Venta' : 'Compra';
        const typeColor = t.type === 'venta' ? 'pill-green' : 'pill-amber';
        
        return `<tr>
          <td><span class="pill ${typeColor}">${typeIcon} ${typeText}</span></td>
          <td>${animal ? `${t.animalId} ${animal.name ? `(${animal.name})` : ''}` : t.animalId}</td>
          <td>${t.date}</td>
          <td>${t.weight} kg</td>
          <td>$${t.pricePerKg.toLocaleString('es-CO')}</td>
          <td><strong>$${t.totalPrice.toLocaleString('es-CO')}</strong></td>
          <td>${t.buyerSeller}</td>
          <td>${t.document || '-'}</td>
          <td>
            <button class="btn btn-ghost" onclick="editTransaction('${t.id}')">✏️</button>
            <button class="btn btn-ghost" onclick="deleteTransaction('${t.id}')">🗑️</button>
          </td>
        </tr>`;
      }).join('');
      
      tbody.innerHTML = rows || `<tr><td colspan="9">Sin transacciones</td></tr>`;
    }
    
    // Función para editar transacción
    function editTransaction(id) {
      const t = store.transactions.find(x => x.id === id);
      if (!t) return;
      
      $('#v-type').value = t.type;
      $('#v-animal').value = t.animalId;
      $('#v-date').value = t.date;
      $('#v-price-per-kg').value = t.pricePerKg;
      $('#v-weight').value = t.weight;
      $('#v-total-price').value = t.totalPrice;
      $('#v-buyer-seller').value = t.buyerSeller;
      $('#v-document').value = t.document || '';
      $('#v-phone').value = t.phone || '';
      $('#v-notes').value = t.notes || '';
      
      updateTransactionFields();
      showTab('tab-ventas', $$('.nav-button')[6]);
    }
    
    // Función para eliminar transacción
    function deleteTransaction(id) {
      if (!confirm('¿Eliminar esta transacción?')) return;
      
      store.transactions = store.transactions.filter(t => t.id !== id);
      saveStore();
      renderTransactions();
      updateFinancialSummary();
      renderSalesCharts();
      
      showNotification('success', 'Transacción Eliminada', 'La transacción ha sido eliminada exitosamente');
    }
    
    // Función para actualizar resumen financiero
    function updateFinancialSummary() {
      const sales = store.transactions.filter(t => t.type === 'venta');
      const purchases = store.transactions.filter(t => t.type === 'compra');
      
      const totalSales = sales.reduce((sum, t) => sum + t.totalPrice, 0);
      const totalPurchases = purchases.reduce((sum, t) => sum + t.totalPrice, 0);
      const netProfit = totalSales - totalPurchases;
      
      $('#total-sales').textContent = `$${totalSales.toLocaleString('es-CO')}`;
      $('#total-purchases').textContent = `$${totalPurchases.toLocaleString('es-CO')}`;
      $('#net-profit').textContent = `$${netProfit.toLocaleString('es-CO')}`;
      
      // Cambiar color según ganancia/pérdida
      const profitElement = $('#net-profit');
      if (netProfit > 0) {
        profitElement.style.color = '#16a34a';
      } else if (netProfit < 0) {
        profitElement.style.color = '#dc2626';
      } else {
        profitElement.style.color = '#1e40af';
      }
    }
    
    // Función para renderizar gráficos de ventas
    function renderSalesCharts() {
      if (typeof echarts === 'undefined') return;
      
      // Gráfico de ventas por mes
      const salesChart = echarts.init(document.getElementById('salesChart'));
      const salesData = store.transactions.filter(t => t.type === 'venta');
      const monthlySales = {};
      
      salesData.forEach(t => {
        const month = t.date.substring(0, 7); // YYYY-MM
        monthlySales[month] = (monthlySales[month] || 0) + t.totalPrice;
      });
      
      const salesOption = {
        title: { text: 'Ventas Mensuales', left: 'center' },
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: Object.keys(monthlySales) },
        yAxis: { type: 'value' },
        series: [{
          data: Object.values(monthlySales),
          type: 'bar',
          itemStyle: { color: '#16a34a' }
        }]
      };
      salesChart.setOption(salesOption);
      
      // Gráfico de rentabilidad por animal
      const profitChart = echarts.init(document.getElementById('profitChart'));
      const animalProfits = {};
      
      store.transactions.forEach(t => {
        if (!animalProfits[t.animalId]) {
          animalProfits[t.animalId] = { sales: 0, purchases: 0 };
        }
        if (t.type === 'venta') {
          animalProfits[t.animalId].sales += t.totalPrice;
        } else {
          animalProfits[t.animalId].purchases += t.totalPrice;
        }
      });
      
      const profitData = Object.entries(animalProfits).map(([animalId, data]) => {
        const animal = store.animals.find(a => a.id === animalId);
        return {
          name: animal ? `${animalId} ${animal.name || ''}` : animalId,
          value: data.sales - data.purchases
        };
      });
      
      const profitOption = {
        title: { text: 'Rentabilidad por Animal', left: 'center' },
        tooltip: { trigger: 'item' },
        series: [{
          type: 'pie',
          radius: '50%',
          data: profitData,
          emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
        }]
      };
      profitChart.setOption(profitOption);
      
      // Gráfico de flujo de caja
      const cashFlowChart = echarts.init(document.getElementById('cashFlowChart'));
      const cashFlowData = store.transactions
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .map(t => ({
          date: t.date,
          value: t.type === 'venta' ? t.totalPrice : -t.totalPrice
        }));
      
      const cashFlowOption = {
        title: { text: 'Flujo de Caja', left: 'center' },
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: cashFlowData.map(d => d.date) },
        yAxis: { type: 'value' },
        series: [{
          data: cashFlowData.map(d => d.value),
          type: 'line',
          smooth: true,
          itemStyle: { color: '#2563eb' }
        }]
      };
      cashFlowChart.setOption(cashFlowOption);
      
      // Gráfico de precios promedio
      const priceChart = echarts.init(document.getElementById('priceChart'));
      const priceData = store.transactions
        .filter(t => t.type === 'venta')
        .reduce((acc, t) => {
          const month = t.date.substring(0, 7);
          if (!acc[month]) acc[month] = [];
          acc[month].push(t.pricePerKg);
          return acc;
        }, {});
      
      const avgPrices = Object.entries(priceData).map(([month, prices]) => ({
        month,
        avgPrice: prices.reduce((sum, p) => sum + p, 0) / prices.length
      }));
      
      const priceOption = {
        title: { text: 'Precio Promedio por Kg', left: 'center' },
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: avgPrices.map(d => d.month) },
        yAxis: { type: 'value' },
        series: [{
          data: avgPrices.map(d => d.avgPrice),
          type: 'line',
          smooth: true,
          itemStyle: { color: '#f59e0b' }
        }]
      };
      priceChart.setOption(priceOption);
    }
    
    // Función para exportar transacciones
    function exportTransactions() {
      const transactions = store.transactions.map(t => {
        const animal = store.animals.find(a => a.id === t.animalId);
        return {
          'Tipo': t.type === 'venta' ? 'Venta' : 'Compra',
          'Animal': animal ? `${t.animalId} ${animal.name || ''}` : t.animalId,
          'Fecha': t.date,
          'Peso (kg)': t.weight,
          'Precio/kg': t.pricePerKg,
          'Total': t.totalPrice,
          'Comprador/Vendedor': t.buyerSeller,
          'Documento': t.document || '',
          'Teléfono': t.phone || '',
          'Observaciones': t.notes || ''
        };
      });
      
      const ws = XLSX.utils.json_to_sheet(transactions);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Transacciones');
      XLSX.writeFile(wb, `transacciones_ganaderas_${new Date().toISOString().slice(0, 10)}.xlsx`);
      
      showNotification('success', 'Reporte Exportado', 'El reporte de transacciones ha sido exportado exitosamente');
    }
    
    // Función para renderizar select de animales en ventas
    function renderSalesAnimalSelect() {
      const opts = ['<option value="">Seleccionar animal</option>', ...store.animals.map(a => 
        `<option value="${a.id}">${a.id} ${a.name ? `(${a.name})` : ''} - ${a.breed || 'Sin raza'}</option>`
      )].join('');
      $('#v-animal').innerHTML = opts;
    }
    function renderWeightRows(){
      const a = store.animals.find(x=>x.id===weightModalAnimalId); if(!a) return;
      const tb = $('#wm-body');
      tb.innerHTML = (a.weights||[]).map((w,i)=>`<tr>
        <td>${w.date}</td><td>${fmt(w.kg)}</td>
        <td><button class='btn btn-ghost' onclick="rmWeighRecord(${i})">🗑️</button></td>
      </tr>`).join('') || `<tr><td colspan="3">Sin registros</td></tr>`;
    }
    function addWeighRecord(){
      const a = store.animals.find(x=>x.id===weightModalAnimalId); if(!a) return;
      const d = $('#wm-date').value || today();
      const kg = parseFloat($('#wm-kg').value);
      if(isNaN(kg)){ alert('Peso inválido'); return; }
      a.weights = [...(a.weights||[]), {date:d, kg}];
      saveStore();
      renderWeightRows();
      renderAnimals();
    }
    function rmWeighRecord(i){
      const a = store.animals.find(x=>x.id===weightModalAnimalId); if(!a) return;
      a.weights.splice(i,1);
      saveStore();
      renderWeightRows();
      renderAnimals();
    }

    function renderPaddockSelects(){
      const opts = ['<option value="">— Sin potrero —</option>', ...store.paddocks.map(p=>`<option value="${p.id}">${p.name}</option>`)].join('');
      $('#a-paddock').innerHTML = opts;
      $('#filterPaddock').innerHTML = ['<option value="">Todos los potreros</option>', ...store.paddocks.map(p=>`<option value="${p.id}">${p.name}</option>`)].join('');
    }

    /* =====================================
       Potreros
       ===================================== */
    function clearPaddockForm(){ 
      ['p-name','p-area','p-alt','p-grass','p-lat','p-lng'].forEach(id=>$('#'+id).value=''); 
      $('#p-photo').value=''; 
      // Remover preview de foto
      const previews = document.querySelectorAll('.photo-preview');
      previews.forEach(preview => preview.remove());
      $('#paddock-map').style.display='none';
    }

    async function savePaddock(){
      const name = $('#p-name').value.trim();
      if(!name){ 
        showNotification('error', 'Error', 'El nombre del potrero es obligatorio');
        return; 
      }
      
      // id = slug del nombre
      const id = name.toLowerCase().replace(/[^a-z0-9]+/g,'-');
      const existing = store.paddocks.find(p=>p.id===id);
      let photo = existing?.photo || '';
      const f = $('#p-photo').files?.[0];
      if(f){ photo = await readFileAsDataURL(f); }

      const padd = {
        id,
        name,
        area: parseFloat($('#p-area').value) || null,
        altitude: parseFloat($('#p-alt').value) || null,
        grass: $('#p-grass').value.trim(),
        photo: photo || '',
        lat: parseFloat($('#p-lat').value) || null,
        lng: parseFloat($('#p-lng').value) || null
      };
      

      
      if(existing){ 
        Object.assign(existing, padd); 
        showNotification('success', 'Potrero actualizado', `El potrero "${padd.name}" ha sido actualizado exitosamente`);
      } else { 
        store.paddocks.push(padd); 
        showNotification('success', 'Potrero registrado', `El potrero "${padd.name}" ha sido registrado exitosamente`);
      }
      
      saveStore();
      clearPaddockForm();
    }

    function renderPaddocks(){
      const tbody = $('#paddocksTable tbody');
      const rows = store.paddocks.map(p=>{
        const count = store.animals.filter(a=>a.paddockId===p.id).length;
        const location = p.lat && p.lng ? 
          `<button class="btn btn-ghost" onclick="showPaddockMap(${p.lat}, ${p.lng}, '${p.name}')" title="Ver en mapa">
            <i class="fas fa-map-marker-alt"></i> ${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}
          </button>` : 
          '<span class="pill pill-amber">Sin ubicación</span>';
        return `<tr>
          <td>${p.photo?`<img class='photo' src='${p.photo}'/>`:''}</td>
          <td>${p.name}</td>
          <td>${p.area?fmt(p.area,' ha'):''}</td>
          <td>${p.altitude?fmt(p.altitude,' msnm'):''}</td>
          <td>${p.grass||''}</td>
          <td>${location}</td>
          <td><span class='pill pill-green'>${count} animales</span></td>
          <td>
            <button class="btn btn-ghost" onclick="editPaddock('${p.id}')">✏️</button>
            <button class="btn btn-ghost" onclick="delPaddock('${p.id}')">🗑️</button>
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows || `<tr><td colspan="8">Sin registros</td></tr>`;
    }

    function editPaddock(id){
      const p = store.paddocks.find(x=>x.id===id); if(!p) return;
      $('#p-name').value = p.name;
      $('#p-area').value = p.area??'';
      $('#p-alt').value = p.altitude??'';
      $('#p-grass').value = p.grass||'';
      $('#p-lat').value = p.lat??'';
      $('#p-lng').value = p.lng??'';
      if (p.lat && p.lng) {
        showPaddockMap(p.lat, p.lng, p.name);
      }
      showTab('tab-potreros', $$('.nav-button')[2]);
    }

    function delPaddock(id){
      if(!confirm('¿Eliminar potrero? Los animales asignados quedarán sin potrero.')) return;
      store.paddocks = store.paddocks.filter(p=>p.id!==id);
      store.animals.forEach(a=>{ if(a.paddockId===id) a.paddockId=''; });
      saveStore();
    }

    /* =====================================
       Reproducción
       ===================================== */
    function renderReproSelects(){
      const fem = store.animals.filter(a=>a.sex==='Hembra');
      const mal = store.animals.filter(a=>a.sex==='Macho');
      $('#r-female').innerHTML = ['<option value="">Seleccionar</option>', ...fem.map(a=>`<option value='${a.id}'>${a.id} ${a.name?('— '+a.name):''}</option>`)].join('');
      $('#r-male').innerHTML = ['<option value="">Seleccionar</option>', ...mal.map(a=>`<option value='${a.id}'>${a.id} ${a.name?('— '+a.name):''}</option>`)].join('');
      // para partos
      const openServices = store.services; // todos listados
      $('#birth-service').innerHTML = ['<option value="">Seleccionar</option>', ...openServices.map(s=>{
        const f = store.animals.find(a=>a.id===s.femaleId);
        const m = store.animals.find(a=>a.id===s.maleId);
        return `<option value='${s.id}'>${f?.id||'?'} × ${m?.id||'?'} — ${s.date}</option>`;
      })].join('');
    }

    function clearServiceForm(){ $('#r-female').value=''; $('#r-male').value=''; $('#r-date').value=''; $('#r-notes').value=''; $('#dueDate').style.display='none'; }

    function saveService(){
      const femaleId = $('#r-female').value; const maleId = $('#r-male').value; const date = $('#r-date').value; const notes = $('#r-notes').value.trim();
      if(!femaleId || !maleId || !date){ alert('Completa hembra, macho y fecha.'); return; }
      const id = uid();
      store.services.push({ id, femaleId, maleId, date, notes });
      saveStore();
      // mostrar FPP
      const fpp = new Date(date); fpp.setDate(fpp.getDate()+GESTATION_DAYS);
      $('#dueDate').textContent = `Fecha probable de parto: ${fpp.toISOString().slice(0,10)}`;
      $('#dueDate').style.display = 'inline-block';
      clearServiceForm();
    }

    function renderServices(){
      const tbody = $('#servicesTable tbody');
      const rows = store.services.map(s=>{
        const f = store.animals.find(a=>a.id===s.femaleId); const m = store.animals.find(a=>a.id===s.maleId);
        const fppd = new Date(s.date); fppd.setDate(fppd.getDate()+GESTATION_DAYS);
        const fpp = fppd.toISOString().slice(0,10);
        return `<tr>
          <td>${f?`${f.id} ${f.name?('— '+f.name):''}`:s.femaleId}</td>
          <td>${m?`${m.id} ${m.name?('— '+m.name):''}`:s.maleId}</td>
          <td>${s.date}</td>
          <td>${fpp}</td>
          <td>${s.notes||''}</td>
          <td><button class='btn btn-ghost' onclick="delService('${s.id}')">🗑️</button></td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows || `<tr><td colspan="6">Sin registros</td></tr>`;
      renderReproSelects();
    }
    function delService(id){ if(!confirm('¿Eliminar servicio?')) return; store.services = store.services.filter(s=>s.id!==id); saveStore(); }

    function registerBirth(){
      const sId = $('#birth-service').value; const date = $('#birth-date').value; const offId = $('#birth-offspring-id').value.trim(); const sex = $('#birth-offspring-sex').value;
      if(!sId || !date || !offId){ alert('Selecciona el servicio, fecha y el ID de la cría.'); return; }
      if(store.animals.some(a=>a.id===offId)){ alert('Ya existe un animal con ese ID.'); return; }
      const s = store.services.find(x=>x.id===sId); if(!s){ alert('Servicio inválido'); return; }
      // crear animal cría
      store.animals.push({ id: offId, name: '', breed: '', sex, dob: date, paddockId: '', notes: '', photo: '', weights: [], motherId: s.femaleId, fatherId: s.maleId });
      // opcional: eliminar el servicio o mantener histórico; aquí mantenemos
      saveStore();
      // limpiar
      $('#birth-service').value=''; $('#birth-date').value=''; $('#birth-offspring-id').value='';
      alert('Cría registrada correctamente');
    }

    /* =====================================
       Salud
       ===================================== */
    function renderHealthSelects(){
      const opts = ['<option value="">Todos los animales</option>', ...store.animals.map(a=>`<option value='${a.id}'>${a.id} ${a.name?('— '+a.name):''}</option>`)].join('');
      $('#healthFilter').innerHTML = opts;
      $('#s-animal').innerHTML = ['<option value="">Seleccionar</option>', ...store.animals.map(a=>`<option value='${a.id}'>${a.id} ${a.name?('— '+a.name):''}</option>`)].join('');
      // Inicializar dropdowns de salud
      updateHealthDropdowns();
    }

    function clearHealthForm(){ 
      $('#s-animal').value=''; 
      $('#s-date').value=''; 
      $('#s-event-type').value=''; 
      $('#s-type').value=''; 
      $('#s-notes').value=''; 
      dropdownManager.hideAll();
    }

    function saveHealth(){
      const animalId = $('#s-animal').value; 
      const date = $('#s-date').value; 
      const eventType = $('#s-event-type').value;
      const type = $('#s-type').value.trim(); 
      const notes = $('#s-notes').value.trim();
      
      if(!animalId || !date || !eventType || !type){ 
        alert('Completa animal, fecha, tipo de evento y procedimiento/enfermedad.'); 
        return; 
      }
      
      store.health.push({ 
        id: uid(), 
        animalId, 
        date, 
        eventType, 
        type, 
        notes 
      });
      saveStore();
      clearHealthForm();
    }

    function renderHealth(){
      const tbody = $('#healthTable tbody');
      const filter = $('#healthFilter').value || '';
      const rows = store.health
        .filter(h=>!filter || h.animalId===filter)
        .sort((a,b)=> new Date(b.date) - new Date(a.date))
        .map(h=>{
          const a = store.animals.find(x=>x.id===h.animalId);
          const eventTypeText = h.eventType === 'procedimiento' ? 'Procedimiento' : 
                               h.eventType === 'enfermedad' ? 'Enfermedad' : 
                               h.eventType === 'otro' ? 'Otro' : h.eventType || '';
          return `<tr>
            <td>${a?`${a.id} ${a.name?('— '+a.name):''}`:h.animalId}</td>
            <td>${h.date}</td>
            <td>${eventTypeText}</td>
            <td>${h.type}</td>
            <td>${h.notes||''}</td>
            <td><button class='btn btn-ghost' onclick="delHealth('${h.id}')">🗑️</button></td>
          </tr>`;
        }).join('');
      tbody.innerHTML = rows || `<tr><td colspan="6">Sin registros</td></tr>`;
    }
    function delHealth(id){ if(!confirm('¿Eliminar evento?')) return; store.health = store.health.filter(h=>h.id!==id); saveStore(); }

    /* =====================================
       Gráficos y Estadísticas con ECharts
       ===================================== */
    
    // Función para renderizar todos los gráficos
    function renderAllCharts() {
      console.log('=== INICIANDO RENDERIZADO DE GRÁFICOS ===');
      
      // Verificar que ECharts esté disponible
      if (typeof echarts === 'undefined') {
        console.error('❌ ECharts no está disponible');
        showNotification('error', 'Error de Gráficos', 'La librería ECharts no se ha cargado correctamente');
        return;
      }
      
      console.log('✅ ECharts disponible:', typeof echarts);
      console.log('📦 Versión ECharts:', echarts.version);
      
      // Verificar que los contenedores de gráficos existan y sean visibles
      const chartContainers = ['weightChart', 'breedChart', 'healthChart', 'paddockChart', 'weaningChart'];
      let allContainersFound = true;
      
      chartContainers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
          console.log(`✅ Contenedor ${id} encontrado`);
          console.log(`  📏 Dimensiones: ${container.offsetWidth}x${container.offsetHeight}`);
          console.log(`  👁️ Visible: ${container.offsetParent !== null}`);
          console.log(`  🎨 Display: ${getComputedStyle(container).display}`);
          console.log(`  👁️ Visibility: ${getComputedStyle(container).visibility}`);
          
          // Forzar visibilidad si no está visible
          if (getComputedStyle(container).display === 'none' || getComputedStyle(container).visibility === 'hidden') {
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.height = '300px';
            container.style.width = '100%';
            container.style.minHeight = '300px';
            console.log(`🔧 Forzando visibilidad de ${id}`);
          }
        } else {
          console.error(`❌ Contenedor ${id} NO ENCONTRADO`);
          allContainersFound = false;
        }
      });
      
      if (!allContainersFound) {
        console.error('❌ No se encontraron todos los contenedores de gráficos');
        showNotification('error', 'Error de Gráficos', 'No se encontraron todos los contenedores de gráficos');
        return;
      }
      
      // Verificar que la pestaña de gráficos esté activa
      const graficosTab = document.getElementById('tab-graficos');
      console.log('📑 Pestaña gráficos activa:', graficosTab && graficosTab.classList.contains('active'));
      
      // Verificar datos disponibles
      console.log('📊 Datos disponibles:');
      console.log(`  🐄 Animales: ${store.animals.length}`);
      console.log(`  🌿 Potreros: ${store.paddocks.length}`);
      console.log(`  🩺 Eventos de salud: ${store.health.length}`);
      
      try {
        console.log('🎨 Iniciando renderizado de gráficos individuales...');
        
        // Renderizar cada gráfico con manejo de errores individual
        // Agregar clase de carga a todos los contenedores
        chartContainers.forEach(id => {
          const container = document.getElementById(id);
          if (container) {
            container.classList.add('chart-loading');
          }
        });
        
        // Renderizar cada gráfico con delay para efecto visual
        setTimeout(() => {
          try {
            console.log('📈 Renderizando gráfico de pesos...');
            renderWeightChart();
            const weightContainer = document.getElementById('weightChart');
            if (weightContainer) weightContainer.classList.remove('chart-loading');
          } catch (error) {
            console.error('❌ Error en gráfico de pesos:', error);
          }
        }, 200);
        
        setTimeout(() => {
          try {
            console.log('🐄 Renderizando gráfico de razas...');
            renderBreedChart();
            const breedContainer = document.getElementById('breedChart');
            if (breedContainer) breedContainer.classList.remove('chart-loading');
          } catch (error) {
            console.error('❌ Error en gráfico de razas:', error);
          }
        }, 400);
        
        setTimeout(() => {
          try {
            console.log('🩺 Renderizando gráfico de salud...');
            renderHealthChart();
            const healthContainer = document.getElementById('healthChart');
            if (healthContainer) healthContainer.classList.remove('chart-loading');
          } catch (error) {
            console.error('❌ Error en gráfico de salud:', error);
          }
        }, 600);
        
        setTimeout(() => {
          try {
            console.log('🌿 Renderizando gráfico de potreros...');
            renderPaddockChart();
            const paddockContainer = document.getElementById('paddockChart');
            if (paddockContainer) paddockContainer.classList.remove('chart-loading');
          } catch (error) {
            console.error('❌ Error en gráfico de potreros:', error);
          }
        }, 800);
        
        setTimeout(() => {
          try {
            console.log('📈 Renderizando gráfico de destete...');
            renderWeaningChart();
            const weaningContainer = document.getElementById('weaningChart');
            if (weaningContainer) weaningContainer.classList.remove('chart-loading');
          } catch (error) {
            console.error('❌ Error en gráfico de destete:', error);
          }
        }, 1000);
        
        console.log('✅ Todos los gráficos renderizados con estilo mejorado');
        showNotification('success', 'Gráficos Actualizados', 'Todos los gráficos han sido actualizados con estilo profesional y mejorado');
        
      } catch (error) {
        console.error('❌ Error general al renderizar gráficos:', error);
        showNotification('error', 'Error de Gráficos', 'Hubo un error al renderizar los gráficos: ' + error.message);
      }
    }

    // Gráfico de evolución de pesos
    function renderWeightChart() {
      console.log('Renderizando gráfico de pesos...');
      const chartDom = document.getElementById('weightChart');
      if (!chartDom) {
        console.error('No se encontró el elemento weightChart');
        return;
      }
      
      console.log('Elemento weightChart encontrado:', chartDom);
      
      try {
        const myChart = echarts.init(chartDom);
        console.log('Gráfico de pesos inicializado:', myChart);
      
      // Preparar datos de pesos
      const weightData = [];
      const animals = store.animals.filter(a => a.weights && a.weights.length > 0);
      
      animals.forEach(animal => {
        animal.weights.forEach(weight => {
          weightData.push({
            name: animal.name || animal.id,
            date: weight.date,
            value: weight.kg
          });
        });
      });

      // Agrupar por fecha y calcular promedio
      const dateGroups = {};
      weightData.forEach(item => {
        if (!dateGroups[item.date]) {
          dateGroups[item.date] = [];
        }
        dateGroups[item.date].push(item.value);
      });

      const dates = Object.keys(dateGroups).sort();
      const avgWeights = dates.map(date => {
        const weights = dateGroups[date];
        return weights.reduce((sum, w) => sum + w, 0) / weights.length;
      });

      const option = {
        title: {
          text: 'Evolución Promedio de Pesos',
          left: 'center',
          textStyle: { color: '#1f2937', fontSize: 16, fontWeight: 'bold' },
          subtext: `${animals.length} animales con registros de peso`,
          subtextStyle: { color: '#6b7280', fontSize: 12 }
        },
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(255,255,255,0.95)',
          borderColor: '#10b981',
          borderWidth: 2,
          textStyle: { color: '#1f2937' },
          formatter: function(params) {
            return `<div style="padding: 8px;">
              <strong>${params[0].name}</strong><br/>
              Peso promedio: <span style="color: #10b981; font-weight: bold;">${params[0].value.toFixed(1)} kg</span>
            </div>`;
          }
        },
        grid: {
          left: '10%',
          right: '10%',
          top: '25%',
          bottom: '15%'
        },
        xAxis: {
          type: 'category',
          data: dates,
          axisLabel: { 
            rotate: 45, 
            color: '#6b7280', 
            fontSize: 12 
          },
          axisLine: { lineStyle: { color: '#d1d5db' } }
        },
        yAxis: {
          type: 'value',
          name: 'Peso (kg)',
          nameLocation: 'middle',
          nameGap: 30,
          nameTextStyle: { color: '#6b7280', fontSize: 12 },
          axisLine: { lineStyle: { color: '#d1d5db' } },
          axisLabel: { color: '#6b7280', fontSize: 12 },
          splitLine: { lineStyle: { color: '#f3f4f6', type: 'dashed' } }
        },
        series: [{
          data: avgWeights,
          type: 'line',
          smooth: true,
          symbol: 'circle',
          symbolSize: 8,
          lineStyle: { 
            color: '#10b981', 
            width: 4,
            shadowColor: 'rgba(16, 185, 129, 0.3)',
            shadowBlur: 10
          },
          itemStyle: { 
            color: '#10b981',
            borderColor: '#ffffff',
            borderWidth: 2,
            shadowColor: 'rgba(16, 185, 129, 0.5)',
            shadowBlur: 8
          },
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: 'rgba(16, 185, 129, 0.4)' },
              { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
            ])
          }
        }]
      };

      myChart.setOption(option);
      } catch (error) {
        console.error('Error al renderizar gráfico de pesos:', error);
        showNotification('error', 'Error de Gráfico', 'Error al renderizar gráfico de pesos: ' + error.message);
      }
    }

    // Gráfico de distribución por razas
    function renderBreedChart() {
      const chartDom = document.getElementById('breedChart');
      if (!chartDom) return;
      
      const myChart = echarts.init(chartDom);
      
      // Contar animales por raza
      const breedCount = {};
      store.animals.forEach(animal => {
        const breed = animal.breed || 'Sin raza';
        breedCount[breed] = (breedCount[breed] || 0) + 1;
      });

      const data = Object.entries(breedCount).map(([breed, count]) => ({
        name: breed,
        value: count
      }));

      const option = {
        title: {
          text: 'Distribución por Razas',
          left: 'center',
          textStyle: { color: '#1f2937', fontSize: 16, fontWeight: 'bold' },
          subtext: `${store.animals.length} animales total`,
          subtextStyle: { color: '#6b7280', fontSize: 12 }
        },
        tooltip: {
          trigger: 'item',
          backgroundColor: 'rgba(255,255,255,0.95)',
          borderColor: '#3b82f6',
          borderWidth: 2,
          textStyle: { color: '#1f2937' },
          formatter: function(params) {
            const percentage = ((params.value / store.animals.length) * 100).toFixed(1);
            return `<div style="padding: 8px;">
              <strong>${params.name}</strong><br/>
              Animales: <span style="color: #3b82f6; font-weight: bold;">${params.value}</span><br/>
              Porcentaje: <span style="color: #3b82f6; font-weight: bold;">${percentage}%</span>
            </div>`;
          }
        },
        legend: {
          orient: 'vertical',
          left: 'left',
          top: 'middle',
          textStyle: { color: '#6b7280', fontSize: 12 }
        },
        series: [{
          name: 'Animales',
          type: 'pie',
          radius: ['40%', '70%'],
          center: ['60%', '50%'],
          avoidLabelOverlap: false,
          itemStyle: {
            borderRadius: 10,
            borderColor: '#ffffff',
            borderWidth: 3,
            shadowColor: 'rgba(0,0,0,0.2)',
            shadowBlur: 10
          },
          label: {
            show: false,
            position: 'center'
          },
          emphasis: {
            label: {
              show: true,
              fontSize: '18',
              fontWeight: 'bold'
            }
          },
          labelLine: {
            show: false
          },
          data: data
        }]
      };

      myChart.setOption(option);
    }

    // Gráfico de eventos de salud por mes
    function renderHealthChart() {
      const chartDom = document.getElementById('healthChart');
      if (!chartDom) return;
      
      const myChart = echarts.init(chartDom);
      
      // Agrupar eventos de salud por mes
      const monthlyHealth = {};
      store.health.forEach(event => {
        const month = event.date.substring(0, 7); // YYYY-MM
        if (!monthlyHealth[month]) {
          monthlyHealth[month] = { procedimientos: 0, enfermedades: 0 };
        }
        if (event.eventType === 'procedimiento') {
          monthlyHealth[month].procedimientos++;
        } else if (event.eventType === 'enfermedad') {
          monthlyHealth[month].enfermedades++;
        }
      });

      const months = Object.keys(monthlyHealth).sort();
      const procedimientos = months.map(month => monthlyHealth[month].procedimientos);
      const enfermedades = months.map(month => monthlyHealth[month].enfermedades);

      const option = {
        title: {
          text: 'Eventos de Salud por Mes',
          left: 'center',
          textStyle: { fontSize: 14, fontWeight: 'bold' }
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' }
        },
        legend: {
          data: ['Procedimientos', 'Enfermedades'],
          top: 30
        },
        xAxis: {
          type: 'category',
          data: months,
          axisLabel: { rotate: 45 }
        },
        yAxis: {
          type: 'value',
          name: 'Cantidad'
        },
        series: [
          {
            name: 'Procedimientos',
            type: 'bar',
            data: procedimientos,
            itemStyle: { color: '#16a34a' }
          },
          {
            name: 'Enfermedades',
            type: 'bar',
            data: enfermedades,
            itemStyle: { color: '#dc2626' }
          }
        ]
      };

      myChart.setOption(option);
    }

    // Gráfico de uso de potreros
    function renderPaddockChart() {
      const chartDom = document.getElementById('paddockChart');
      if (!chartDom) return;
      
      const myChart = echarts.init(chartDom);
      
      // Contar animales por potrero
      const paddockUsage = {};
      store.animals.forEach(animal => {
        if (animal.paddockId) {
          const paddock = store.paddocks.find(p => p.id === animal.paddockId);
          const paddockName = paddock ? paddock.name : animal.paddockId;
          paddockUsage[paddockName] = (paddockUsage[paddockName] || 0) + 1;
        }
      });

      const data = Object.entries(paddockUsage).map(([paddock, count]) => ({
        name: paddock,
        value: count
      }));

      const option = {
        title: {
          text: 'Uso de Potreros',
          left: 'center',
          textStyle: { fontSize: 14, fontWeight: 'bold' }
        },
        tooltip: {
          trigger: 'item',
          formatter: '{b}: {c} animales'
        },
        series: [{
          name: 'Animales',
          type: 'pie',
          radius: '50%',
          data: data,
          emphasis: {
            itemStyle: {
              shadowBlur: 10,
              shadowOffsetX: 0,
              shadowColor: 'rgba(0, 0, 0, 0.5)'
            }
          }
        }]
      };

      myChart.setOption(option);
    }

    // Gráfico de estadísticas de destete
    function renderWeaningChart() {
      const chartDom = document.getElementById('weaningChart');
      if (!chartDom) return;
      
      const myChart = echarts.init(chartDom);
      
      // Calcular estadísticas de destete
      const weaningStats = calculateWeaningStats();
      
      const option = {
        title: {
          text: 'Estadísticas de Destete y Crecimiento',
          left: 'center',
          textStyle: { fontSize: 16, fontWeight: 'bold' }
        },
        tooltip: {
          trigger: 'axis'
        },
        legend: {
          data: ['Peso al Nacer', 'Peso al Destete', 'Ganancia Diaria'],
          top: 30
        },
        xAxis: {
          type: 'category',
          data: weaningStats.animals,
          axisLabel: { rotate: 45 }
        },
        yAxis: [
          {
            type: 'value',
            name: 'Peso (kg)',
            position: 'left'
          },
          {
            type: 'value',
            name: 'Ganancia (kg/día)',
            position: 'right'
          }
        ],
        series: [
          {
            name: 'Peso al Nacer',
            type: 'bar',
            data: weaningStats.birthWeights,
            itemStyle: { color: '#3b82f6' }
          },
          {
            name: 'Peso al Destete',
            type: 'bar',
            data: weaningStats.weaningWeights,
            itemStyle: { color: '#16a34a' }
          },
          {
            name: 'Ganancia Diaria',
            type: 'line',
            yAxisIndex: 1,
            data: weaningStats.dailyGains,
            itemStyle: { color: '#f59e0b' },
            lineStyle: { width: 3 }
          }
        ]
      };

      myChart.setOption(option);
    }

    // Función para calcular estadísticas de destete
    function calculateWeaningStats() {
      const animals = store.animals.filter(a => a.dob && a.weights && a.weights.length > 0);
      const weaningAge = 240; // días (8 meses)
      
      const stats = {
        animals: [],
        birthWeights: [],
        weaningWeights: [],
        dailyGains: []
      };

      animals.forEach(animal => {
        const birthWeight = animal.weights[0]?.kg || 0;
        const weaningWeight = animal.weights[animal.weights.length - 1]?.kg || 0;
        
        if (birthWeight > 0 && weaningWeight > 0) {
          const ageInDays = Math.floor((new Date() - new Date(animal.dob)) / (1000 * 60 * 60 * 24));
          const dailyGain = ageInDays > 0 ? (weaningWeight - birthWeight) / ageInDays : 0;
          
          stats.animals.push(animal.name || animal.id);
          stats.birthWeights.push(birthWeight);
          stats.weaningWeights.push(weaningWeight);
          stats.dailyGains.push(dailyGain);
        }
      });

      return stats;
    }

    // Función para exportar reporte de gráficos
    function exportCharts() {
      const reportData = {
        fecha: new Date().toLocaleDateString('es-ES'),
        totalAnimales: store.animals.length,
        totalPotreros: store.paddocks.length,
        totalEventosSalud: store.health.length,
        estadisticas: calculateWeaningStats()
      };

      // Crear PDF con reporte
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.text('Reporte de Estadísticas Ganaderas', 20, 20);
      
      doc.setFontSize(12);
      doc.text(`Fecha: ${reportData.fecha}`, 20, 40);
      doc.text(`Total Animales: ${reportData.totalAnimales}`, 20, 50);
      doc.text(`Total Potreros: ${reportData.totalPotreros}`, 20, 60);
      doc.text(`Total Eventos de Salud: ${reportData.totalEventosSalud}`, 20, 70);
      
      doc.save('reporte-estadisticas-ganaderas.pdf');
      showNotification('success', 'Reporte Exportado', 'El reporte se ha descargado como PDF');
    }

    /* =====================================
       Venta de Gráficos - Todos los Parámetros
       ===================================== */
    
    // Función principal para renderizar todos los gráficos de venta
    function renderSalesCharts() {
      console.log('=== INICIANDO RENDERIZADO DE VENTA DE GRÁFICOS ===');
      
      if (typeof echarts === 'undefined') {
        console.error('❌ ECharts no está disponible');
        showNotification('error', 'Error de Gráficos', 'La librería ECharts no se ha cargado correctamente');
        return;
      }
      
      // Actualizar resúmenes
      updateSalesSummaries();
      
      // Renderizar todos los gráficos de venta
      try {
        renderGenderChart();
        renderAgeChart();
        renderWeightRangeChart();
        renderLocationChart();
        renderProductivityChart();
        renderHealthTypeChart();
        renderComprehensiveChart();
        updateSalesTable();
        
        showNotification('success', 'Venta de Gráficos Actualizada', 'Todos los gráficos de venta han sido actualizados');
      } catch (error) {
        console.error('❌ Error al renderizar gráficos de venta:', error);
        showNotification('error', 'Error de Venta', 'Hubo un error al renderizar los gráficos de venta: ' + error.message);
      }
    }
    
    // Actualizar resúmenes de datos
    function updateSalesSummaries() {
      const animalsCount = store.animals.length;
      const paddocksCount = store.paddocks.length;
      const healthCount = store.health.length;
      
      const animalsSummary = document.getElementById('animalsSummary');
      const paddocksSummary = document.getElementById('paddocksSummary');
      const healthSummary = document.getElementById('healthSummary');
      
      if (animalsSummary) animalsSummary.textContent = animalsCount;
      if (paddocksSummary) paddocksSummary.textContent = paddocksCount;
      if (healthSummary) healthSummary.textContent = healthCount;
    }
    
    // Gráfico de distribución por sexo
    function renderGenderChart() {
      const container = document.getElementById('genderChart');
      if (!container) return;
      
      const genderData = {};
      store.animals.forEach(animal => {
        const gender = animal.sex || 'No especificado';
        genderData[gender] = (genderData[gender] || 0) + 1;
      });
      
      const chart = echarts.init(container);
      const option = {
        title: { text: 'Distribución por Sexo', left: 'center', textStyle: { fontSize: 14 } },
        tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c} ({d}%)' },
        legend: { orient: 'vertical', left: 'left' },
        series: [{
          name: 'Animales',
          type: 'pie',
          radius: '50%',
          data: Object.entries(genderData).map(([gender, count]) => ({
            name: gender,
            value: count
          })),
          emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
        }]
      };
      chart.setOption(option);
    }
    
    // Gráfico de edad de los animales
    function renderAgeChart() {
      const container = document.getElementById('ageChart');
      if (!container) return;
      
      const ageRanges = {
        '0-1 año': 0,
        '1-2 años': 0,
        '2-5 años': 0,
        '5-10 años': 0,
        '10+ años': 0
      };
      
      store.animals.forEach(animal => {
        if (animal.dob) {
          const age = (new Date() - new Date(animal.dob)) / (1000 * 60 * 60 * 24 * 365);
          if (age <= 1) ageRanges['0-1 año']++;
          else if (age <= 2) ageRanges['1-2 años']++;
          else if (age <= 5) ageRanges['2-5 años']++;
          else if (age <= 10) ageRanges['5-10 años']++;
          else ageRanges['10+ años']++;
        }
      });
      
      const chart = echarts.init(container);
      const option = {
        title: { text: 'Distribución por Edad', left: 'center', textStyle: { fontSize: 14 } },
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: Object.keys(ageRanges) },
        yAxis: { type: 'value', name: 'Cantidad' },
        series: [{
          data: Object.values(ageRanges),
          type: 'bar',
          itemStyle: { color: '#16a34a' }
        }]
      };
      chart.setOption(option);
    }
    
    // Gráfico de rango de pesos
    function renderWeightRangeChart() {
      const container = document.getElementById('weightRangeChart');
      if (!container) return;
      
      const weightRanges = {
        '0-200 kg': 0,
        '200-400 kg': 0,
        '400-600 kg': 0,
        '600-800 kg': 0,
        '800+ kg': 0
      };
      
      store.animals.forEach(animal => {
        const currentWeight = animal.weights && animal.weights.length > 0 ? 
          animal.weights[animal.weights.length - 1].kg : 0;
        
        if (currentWeight <= 200) weightRanges['0-200 kg']++;
        else if (currentWeight <= 400) weightRanges['200-400 kg']++;
        else if (currentWeight <= 600) weightRanges['400-600 kg']++;
        else if (currentWeight <= 800) weightRanges['600-800 kg']++;
        else weightRanges['800+ kg']++;
      });
      
      const chart = echarts.init(container);
      const option = {
        title: { text: 'Distribución por Peso', left: 'center', textStyle: { fontSize: 14 } },
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: Object.keys(weightRanges) },
        yAxis: { type: 'value', name: 'Cantidad' },
        series: [{
          data: Object.values(weightRanges),
          type: 'bar',
          itemStyle: { color: '#f59e0b' }
        }]
      };
      chart.setOption(option);
    }
    
    // Gráfico de distribución geográfica
    function renderLocationChart() {
      const container = document.getElementById('locationChart');
      if (!container) return;
      
      const locationData = {};
      store.paddocks.forEach(paddock => {
        const region = paddock.name ? paddock.name.split(' ')[0] : 'Sin nombre';
        locationData[region] = (locationData[region] || 0) + 1;
      });
      
      const chart = echarts.init(container);
      const option = {
        title: { text: 'Distribución Geográfica', left: 'center', textStyle: { fontSize: 14 } },
        tooltip: { trigger: 'item' },
        series: [{
          name: 'Potreros',
          type: 'pie',
          radius: '50%',
          data: Object.entries(locationData).map(([region, count]) => ({
            name: region,
            value: count
          })),
          emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
        }]
      };
      chart.setOption(option);
    }
    
    // Gráfico de productividad por potrero
    function renderProductivityChart() {
      const container = document.getElementById('productivityChart');
      if (!container) return;
      
      const productivityData = {};
      store.paddocks.forEach(paddock => {
        const animalsInPaddock = store.animals.filter(animal => animal.paddockId === paddock.id).length;
        const productivity = animalsInPaddock / (paddock.area || 1);
        productivityData[paddock.name || 'Sin nombre'] = productivity;
      });
      
      const chart = echarts.init(container);
      const option = {
        title: { text: 'Productividad por Potrero', left: 'center', textStyle: { fontSize: 14 } },
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: Object.keys(productivityData) },
        yAxis: { type: 'value', name: 'Animales/ha' },
        series: [{
          data: Object.values(productivityData),
          type: 'bar',
          itemStyle: { color: '#2563eb' }
        }]
      };
      chart.setOption(option);
    }
    
    // Gráfico de tipos de eventos de salud
    function renderHealthTypeChart() {
      const container = document.getElementById('healthTypeChart');
      if (!container) return;
      
      const healthTypeData = {};
      store.health.forEach(event => {
        const type = event.type || 'Sin especificar';
        healthTypeData[type] = (healthTypeData[type] || 0) + 1;
      });
      
      const chart = echarts.init(container);
      const option = {
        title: { text: 'Tipos de Eventos de Salud', left: 'center', textStyle: { fontSize: 14 } },
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: Object.keys(healthTypeData) },
        yAxis: { type: 'value', name: 'Cantidad' },
        series: [{
          data: Object.values(healthTypeData),
          type: 'bar',
          itemStyle: { color: '#dc2626' }
        }]
      };
      chart.setOption(option);
    }
    
    // Gráfico completo de análisis de datos
    function renderComprehensiveChart() {
      const container = document.getElementById('comprehensiveChart');
      if (!container) return;
      
      const chart = echarts.init(container);
      const option = {
        title: { text: 'Análisis Completo de Datos', left: 'center', textStyle: { fontSize: 16 } },
        tooltip: { trigger: 'axis' },
        legend: { data: ['Animales', 'Potreros', 'Eventos de Salud'], top: 30 },
        xAxis: { type: 'category', data: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'] },
        yAxis: { type: 'value', name: 'Cantidad' },
        series: [
          {
            name: 'Animales',
            type: 'line',
            data: [store.animals.length, store.animals.length, store.animals.length, store.animals.length, store.animals.length, store.animals.length],
            itemStyle: { color: '#16a34a' }
          },
          {
            name: 'Potreros',
            type: 'line',
            data: [store.paddocks.length, store.paddocks.length, store.paddocks.length, store.paddocks.length, store.paddocks.length, store.paddocks.length],
            itemStyle: { color: '#f59e0b' }
          },
          {
            name: 'Eventos de Salud',
            type: 'line',
            data: [store.health.length, store.health.length, store.health.length, store.health.length, store.health.length, store.health.length],
            itemStyle: { color: '#dc2626' }
          }
        ]
      };
      chart.setOption(option);
    }
    
    // Actualizar tabla de resumen de venta
    function updateSalesTable() {
      const tbody = document.getElementById('salesTableBody');
      if (!tbody) return;
      
      const now = new Date().toLocaleString('es-ES');
      
      // Calcular estadísticas
      const totalWeight = store.animals.reduce((sum, animal) => {
        const currentWeight = animal.weights && animal.weights.length > 0 ? 
          animal.weights[animal.weights.length - 1].kg : 0;
        return sum + currentWeight;
      }, 0);
      
      const avgWeight = store.animals.length > 0 ? totalWeight / store.animals.length : 0;
      const minWeight = Math.min(...store.animals.map(animal => {
        const currentWeight = animal.weights && animal.weights.length > 0 ? 
          animal.weights[animal.weights.length - 1].kg : 0;
        return currentWeight;
      }).filter(w => w > 0));
      const maxWeight = Math.max(...store.animals.map(animal => {
        const currentWeight = animal.weights && animal.weights.length > 0 ? 
          animal.weights[animal.weights.length - 1].kg : 0;
        return currentWeight;
      }).filter(w => w > 0));
      
      const tableData = [
        {
          categoria: 'Animales',
          total: store.animals.length,
          promedio: store.animals.length,
          minimo: store.animals.length,
          maximo: store.animals.length,
          actualizacion: now
        },
        {
          categoria: 'Peso Promedio (kg)',
          total: totalWeight.toFixed(1),
          promedio: avgWeight.toFixed(1),
          minimo: minWeight.toFixed(1),
          maximo: maxWeight.toFixed(1),
          actualizacion: now
        },
        {
          categoria: 'Potreros',
          total: store.paddocks.length,
          promedio: store.paddocks.length,
          minimo: store.paddocks.length,
          maximo: store.paddocks.length,
          actualizacion: now
        },
        {
          categoria: 'Eventos de Salud',
          total: store.health.length,
          promedio: store.health.length,
          minimo: store.health.length,
          maximo: store.health.length,
          actualizacion: now
        }
      ];
      
      tbody.innerHTML = tableData.map(row => `
        <tr>
          <td>${row.categoria}</td>
          <td>${row.total}</td>
          <td>${row.promedio}</td>
          <td>${row.minimo}</td>
          <td>${row.maximo}</td>
          <td>${row.actualizacion}</td>
        </tr>
      `).join('');
    }
    
    // Función para exportar reporte de venta
    function exportSalesReport() {
      const reportData = {
        fecha: new Date().toLocaleDateString('es-ES'),
        totalAnimales: store.animals.length,
        totalPotreros: store.paddocks.length,
        totalEventosSalud: store.health.length,
        pesoPromedio: store.animals.reduce((sum, animal) => {
          const currentWeight = animal.weights && animal.weights.length > 0 ? 
            animal.weights[animal.weights.length - 1].kg : 0;
          return sum + currentWeight;
        }, 0) / Math.max(store.animals.length, 1)
      };

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.text('Reporte de Venta de Gráficos', 20, 20);
      
      doc.setFontSize(12);
      doc.text(`Fecha: ${reportData.fecha}`, 20, 40);
      doc.text(`Total Animales: ${reportData.totalAnimales}`, 20, 50);
      doc.text(`Total Potreros: ${reportData.totalPotreros}`, 20, 60);
      doc.text(`Total Eventos de Salud: ${reportData.totalEventosSalud}`, 20, 70);
      doc.text(`Peso Promedio: ${reportData.pesoPromedio.toFixed(1)} kg`, 20, 80);
      
      doc.save('reporte-venta-graficos.pdf');
      showNotification('success', 'Reporte de Venta Exportado', 'El reporte de venta se ha descargado como PDF');
    }
    
    // Función para generar resumen de venta
    function generateSalesSummary() {
      const summary = {
        animales: store.animals.length,
        potreros: store.paddocks.length,
        eventosSalud: store.health.length,
        pesoTotal: store.animals.reduce((sum, animal) => {
          const currentWeight = animal.weights && animal.weights.length > 0 ? 
            animal.weights[animal.weights.length - 1].kg : 0;
          return sum + currentWeight;
        }, 0),
        fecha: new Date().toLocaleString('es-ES')
      };
      
      const summaryText = `
📊 RESUMEN DE VENTA DE GRÁFICOS

🐄 Animales registrados: ${summary.animales}
🌿 Potreros activos: ${summary.potreros}
🩺 Eventos de salud: ${summary.eventosSalud}
⚖️ Peso total: ${summary.pesoTotal.toFixed(1)} kg
📅 Fecha: ${summary.fecha}

Este resumen muestra todos los parámetros registrados en el sistema GeneGan Plus.
      `;
      
      alert(summaryText);
      showNotification('info', 'Resumen Generado', 'Se ha generado el resumen de venta de gráficos');
    }
    
    // Función para mostrar dashboard completo
    function showSalesDashboard() {
      // Activar la pestaña de gráficos si no está activa
      const graficosTab = document.getElementById('tab-graficos');
      if (graficosTab && !graficosTab.classList.contains('active')) {
        showTab('tab-graficos', document.querySelector('.nav-button[onclick*="tab-graficos"]'));
      }
      
      // Renderizar todos los gráficos
      setTimeout(() => {
        renderSalesCharts();
        showNotification('success', 'Dashboard Completo', 'Se ha cargado el dashboard completo de venta de gráficos');
      }, 100);
    }

    /* =====================================
       Geolocalización y Mapas
       ===================================== */
    
    function getCurrentLocation() {
      if (navigator.geolocation) {
        // Mostrar indicador de carga
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obteniendo ubicación...';
        button.disabled = true;
        
        navigator.geolocation.getCurrentPosition(
          function(position) {
            $('#p-lat').value = position.coords.latitude;
            $('#p-lng').value = position.coords.longitude;
            showPaddockMap(position.coords.latitude, position.coords.longitude, 'Ubicación actual');
            
            // Restaurar botón
            button.innerHTML = originalText;
            button.disabled = false;
            
            showNotification('success', 'Ubicación obtenida', 'Se ha obtenido tu ubicación actual correctamente');
          },
          function(error) {
            // Restaurar botón
            button.innerHTML = originalText;
            button.disabled = false;
            
            let errorMessage = 'Error al obtener ubicación';
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = 'Permiso denegado. Por favor, permite el acceso a la ubicación en tu navegador.';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = 'La información de ubicación no está disponible.';
                break;
              case error.TIMEOUT:
                errorMessage = 'Tiempo de espera agotado al obtener la ubicación.';
                break;
              default:
                errorMessage = 'Error desconocido: ' + error.message;
            }
            
            showNotification('error', 'Error de geolocalización', errorMessage);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      } else {
        showNotification('error', 'Navegador no compatible', 'La geolocalización no está soportada en este navegador');
      }
    }

    // Función de prueba para geolocalización
    function testGeolocation() {
      console.log('=== TESTING GEOLOCATION ===');
      console.log('navigator.geolocation disponible:', !!navigator.geolocation);
      
      if (navigator.geolocation) {
        console.log('Probando permisos de geolocalización...');
        
        // Verificar permisos (solo funciona en algunos navegadores)
        if (navigator.permissions) {
          navigator.permissions.query({name: 'geolocation'}).then(function(result) {
            console.log('Estado de permisos:', result.state);
            showNotification('info', 'Estado de permisos', `Permisos de geolocalización: ${result.state}`);
          });
        }
        
        // Probar obtención de ubicación con timeout corto
        navigator.geolocation.getCurrentPosition(
          function(position) {
            console.log('Ubicación obtenida:', position);
            showNotification('success', 'Test exitoso', `Lat: ${position.coords.latitude}, Lng: ${position.coords.longitude}`);
          },
          function(error) {
            console.log('Error en test:', error);
            showNotification('error', 'Test fallido', `Error: ${error.message} (Código: ${error.code})`);
          },
          {
            enableHighAccuracy: false,
            timeout: 5000,
            maximumAge: 300000
          }
        );
      } else {
        showNotification('error', 'No compatible', 'La geolocalización no está disponible en este navegador');
      }
    }
    
    function showPaddockMap(lat, lng, title) {
      console.log('Mostrando mapa:', lat, lng, title);
      const mapContainer = $('#paddock-map');
      mapContainer.style.display = 'block';
      
      // Limpiar contenedor
      mapContainer.innerHTML = '';
      
      try {
        // Crear mapa con Leaflet (gratuito)
        const map = L.map(mapContainer).setView([parseFloat(lat), parseFloat(lng)], 15);
        
        // Agregar capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Agregar marcador personalizado
        const customIcon = L.divIcon({
          className: 'custom-marker',
          html: '<div style="background: #16a34a; border: 2px solid white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">🐄</div>',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });
        
        L.marker([parseFloat(lat), parseFloat(lng)], { icon: customIcon })
          .addTo(map)
          .bindPopup(`<b>${title}</b><br>Lat: ${lat}<br>Lng: ${lng}`);
          
        console.log('Mapa creado exitosamente');
      } catch (error) {
        console.error('Error al crear mapa:', error);
        mapContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">Error al cargar el mapa: ' + error.message + '</div>';
      }
    }
    
    // Actualizar mapa cuando cambien las coordenadas
    $('#p-lat').addEventListener('input', updateMapFromInputs);
    $('#p-lng').addEventListener('input', updateMapFromInputs);
    
    function updateMapFromInputs() {
      const lat = $('#p-lat').value;
      const lng = $('#p-lng').value;
      if (lat && lng) {
        showPaddockMap(lat, lng, 'Potrero');
      }
    }
    
    function showAllPaddocksMap() {
      console.log('Mostrando mapa de todos los potreros');
      const paddocksWithLocation = store.paddocks.filter(p => p.lat && p.lng);
      console.log('Potreros con ubicación:', paddocksWithLocation);
      
      if (paddocksWithLocation.length === 0) {
        alert('No hay potreros con ubicación registrada');
        return;
      }
      
      $('#mapModal').classList.add('active');
      const mapContainer = $('#mapModal-container');
      mapContainer.innerHTML = '';
      
      try {
        // Calcular centro del mapa
        const avgLat = paddocksWithLocation.reduce((sum, p) => sum + p.lat, 0) / paddocksWithLocation.length;
        const avgLng = paddocksWithLocation.reduce((sum, p) => sum + p.lng, 0) / paddocksWithLocation.length;
        
        // Crear mapa con Leaflet
        const map = L.map(mapContainer).setView([avgLat, avgLng], 12);
        
        // Agregar capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Agregar marcadores para cada potrero
        paddocksWithLocation.forEach(paddock => {
          const customIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: #16a34a; border: 2px solid white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">🌿</div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });
          
          const marker = L.marker([paddock.lat, paddock.lng], { icon: customIcon }).addTo(map);
          
          // Agregar marcadores para animales en este potrero
          const animalsInPaddock = store.animals.filter(a => a.paddockId === paddock.id);
          
          if (animalsInPaddock.length > 0) {
            // Crear un grupo de marcadores para los animales
            const animalGroup = L.featureGroup();
            
            animalsInPaddock.forEach((animal, index) => {
              // Calcular offset en forma de círculo para mejor distribución
              const angle = (index / animalsInPaddock.length) * 2 * Math.PI;
              const radius = 0.0002; // Aproximadamente 20 metros
              const animalLat = paddock.lat + (radius * Math.cos(angle));
              const animalLng = paddock.lng + (radius * Math.sin(angle));
              
              // Icono mejorado para el animal
              const animalIcon = L.divIcon({
                className: 'animal-marker',
                html: `
                  <div style="
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    border: 3px solid white;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 12px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    position: relative;
                  ">
                    🐄
                    <div style="
                      position: absolute;
                      top: -5px;
                      right: -5px;
                      background: #dc2626;
                      color: white;
                      border-radius: 50%;
                      width: 12px;
                      height: 12px;
                      font-size: 8px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-weight: bold;
                    ">${index + 1}</div>
                  </div>
                `,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
              });
              
              const animalMarker = L.marker([animalLat, animalLng], { icon: animalIcon }).addTo(map);
              
              // Popup mejorado para el animal
              const animalPopupContent = `
                <div style="padding: 12px; min-width: 250px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 8px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div style="font-size: 24px;">🐄</div>
                    <div>
                      <h4 style="margin: 0; color: #92400e; font-size: 16px;">${animal.id}</h4>
                      <p style="margin: 2px 0; color: #92400e; font-weight: bold;">${animal.name || 'Sin nombre'}</p>
                    </div>
                  </div>
                  <div style="background: white; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
                    <p style="margin: 2px 0; font-size: 12px;"><strong>Raza:</strong> ${animal.breed || 'Sin raza'}</p>
                    <p style="margin: 2px 0; font-size: 12px;"><strong>Sexo:</strong> ${animal.sex || 'N/A'}</p>
                    <p style="margin: 2px 0; font-size: 12px;"><strong>Peso actual:</strong> ${animal.weights?.length ? animal.weights[animal.weights.length-1].kg + ' kg' : 'Sin peso'}</p>
                    <p style="margin: 2px 0; font-size: 12px;"><strong>Fecha nacimiento:</strong> ${animal.dob || 'N/A'}</p>
                  </div>
                  <div style="background: #dcfce7; padding: 6px; border-radius: 4px; text-align: center;">
                    <small style="color: #166534; font-weight: bold;">📍 Potrero: ${paddock.name}</small>
                  </div>
                </div>
              `;
              
              animalMarker.bindPopup(animalPopupContent);
              animalGroup.addLayer(animalMarker);
            });
            
            // Agregar el grupo al mapa
            map.addLayer(animalGroup);
          }
          
          // Usar la variable ya declarada arriba
          
          // Popup con información
          const popupContent = `
            <div style="padding: 10px; min-width: 250px;">
              <h3 style="margin: 0 0 5px 0; color: #166534;">${paddock.name}</h3>
              <p style="margin: 2px 0;"><strong>Extensión:</strong> ${paddock.area || 'N/A'} ha</p>
              <p style="margin: 2px 0;"><strong>Pasto:</strong> ${paddock.grass || 'N/A'}</p>
              <p style="margin: 2px 0;"><strong>Animales:</strong> ${animalsInPaddock.length}</p>
              <p style="margin: 2px 0;"><strong>Coordenadas:</strong> ${paddock.lat.toFixed(4)}, ${paddock.lng.toFixed(4)}</p>
              ${animalsInPaddock.length > 0 ? `
                <hr style="margin: 8px 0; border: none; border-top: 1px solid #e5e7eb;">
                <p style="margin: 2px 0; font-weight: bold; color: #166534;">Animales en este potrero:</p>
                <div style="max-height: 150px; overflow-y: auto;">
                  ${animalsInPaddock.map(animal => `
                    <div style="padding: 4px 0; border-bottom: 1px solid #f3f4f6;">
                      <div style="font-weight: bold; color: #374151;">${animal.id} - ${animal.name || 'Sin nombre'}</div>
                      <div style="font-size: 12px; color: #6b7280;">
                        ${animal.breed || 'Sin raza'} • ${animal.sex || 'N/A'} • ${animal.weights?.length ? animal.weights[animal.weights.length-1].kg + ' kg' : 'Sin peso'}
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `;
          
          marker.bindPopup(popupContent);
        });
        
        // Agregar leyenda al mapa
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function(map) {
          const div = L.DomUtil.create('div', 'info legend');
          div.style.backgroundColor = 'white';
          div.style.padding = '10px';
          div.style.borderRadius = '8px';
          div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
          div.style.fontSize = '12px';
          div.innerHTML = `
            <h4 style="margin: 0 0 8px 0; color: #166534;">Leyenda</h4>
            <div style="display: flex; align-items: center; margin: 4px 0;">
              <div style="background: #16a34a; border: 2px solid white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; margin-right: 8px;">🌿</div>
              <span>Potrero</span>
            </div>
            <div style="display: flex; align-items: center; margin: 4px 0;">
              <div style="background: #f59e0b; border: 2px solid white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; margin-right: 8px;">🐄</div>
              <span>Animal</span>
            </div>
          `;
          return div;
        };
        legend.addTo(map);
        
        console.log('Mapa de potreros creado exitosamente');
      } catch (error) {
        console.error('Error al crear mapa de potreros:', error);
        mapContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">Error al cargar el mapa: ' + error.message + '</div>';
      }
    }

    // Función para precargar tiles de mapa para uso offline
    function preloadMapTiles() {
      const paddocksWithLocation = store.paddocks.filter(p => p.lat && p.lng);
      
      if (paddocksWithLocation.length === 0) {
        alert('No hay potreros con ubicación registrada para precargar mapas');
        return;
      }

      // Crear un mapa temporal para precargar tiles
      const tempMapContainer = document.createElement('div');
      tempMapContainer.style.position = 'absolute';
      tempMapContainer.style.left = '-9999px';
      tempMapContainer.style.width = '100px';
      tempMapContainer.style.height = '100px';
      document.body.appendChild(tempMapContainer);

      try {
        // Calcular centro del mapa
        const avgLat = paddocksWithLocation.reduce((sum, p) => sum + p.lat, 0) / paddocksWithLocation.length;
        const avgLng = paddocksWithLocation.reduce((sum, p) => sum + p.lng, 0) / paddocksWithLocation.length;
        
        // Crear mapa temporal
        const tempMap = L.map(tempMapContainer).setView([avgLat, avgLng], 12);
        
        // Agregar capa de OpenStreetMap para precargar tiles
        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(tempMap);
        
        // Precargar tiles en diferentes niveles de zoom
        const zoomLevels = [10, 11, 12, 13, 14];
        let tilesLoaded = 0;
        const totalTiles = zoomLevels.length * 9; // 3x3 tiles por nivel de zoom
        
        zoomLevels.forEach(zoom => {
          tempMap.setZoom(zoom);
          // Forzar carga de tiles
          setTimeout(() => {
            tilesLoaded += 9;
            const progress = Math.round((tilesLoaded / totalTiles) * 100);
            console.log(`Precargando mapas: ${progress}%`);
            
            if (tilesLoaded >= totalTiles) {
              tempMap.remove();
              document.body.removeChild(tempMapContainer);
              alert('Mapas precargados exitosamente para uso offline');
            }
          }, 1000);
        });
        
      } catch (error) {
        console.error('Error al precargar mapas:', error);
        alert('Error al precargar mapas: ' + error.message);
        if (tempMapContainer.parentNode) {
          document.body.removeChild(tempMapContainer);
        }
      }
    }

    /* =====================================
       Importar / Exportar / Reset
       ===================================== */
    function exportJSON(){
      const blob = new Blob([JSON.stringify(store,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `genegan-plus-backup-${today()}.json`; a.click();
      URL.revokeObjectURL(url);
    }
    
    function exportToExcel() {
      const workbook = XLSX.utils.book_new();
      
      // Hoja de animales
      const animalsData = store.animals.map(a => ({
        'ID': a.id,
        'Nombre': a.name || '',
        'Raza': a.breed || '',
        'Sexo': a.sex || '',
        'Fecha Nacimiento': a.dob || '',
        'Peso Actual (kg)': a.weights?.length ? a.weights[a.weights.length-1].kg : '',
        'Potrero': store.paddocks.find(p => p.id === a.paddockId)?.name || '',
        'Notas': a.notes || ''
      }));
      const animalsSheet = XLSX.utils.json_to_sheet(animalsData);
      XLSX.utils.book_append_sheet(workbook, animalsSheet, 'Animales');
      
      // Hoja de potreros
      const paddocksData = store.paddocks.map(p => ({
        'Nombre': p.name,
        'Extensión (ha)': p.area || '',
        'Altura (msnm)': p.altitude || '',
        'Tipo de Pasto': p.grass || '',
        'Latitud': p.lat || '',
        'Longitud': p.lng || ''
      }));
      const paddocksSheet = XLSX.utils.json_to_sheet(paddocksData);
      XLSX.utils.book_append_sheet(workbook, paddocksSheet, 'Potreros');
      
      // Hoja de servicios
      const servicesData = store.services.map(s => {
        const female = store.animals.find(a => a.id === s.femaleId);
        const male = store.animals.find(a => a.id === s.maleId);
        const fpp = new Date(s.date);
        fpp.setDate(fpp.getDate() + GESTATION_DAYS);
        return {
          'Hembra': female ? `${female.id} ${female.name || ''}` : s.femaleId,
          'Macho': male ? `${male.id} ${male.name || ''}` : s.maleId,
          'Fecha Servicio': s.date,
          'Fecha Probable Parto': fpp.toISOString().slice(0,10),
          'Notas': s.notes || ''
        };
      });
      const servicesSheet = XLSX.utils.json_to_sheet(servicesData);
      XLSX.utils.book_append_sheet(workbook, servicesSheet, 'Servicios');
      
      // Hoja de salud
      const healthData = store.health.map(h => {
        const animal = store.animals.find(a => a.id === h.animalId);
        const eventTypeText = h.eventType === 'procedimiento' ? 'Procedimiento' : 
                             h.eventType === 'enfermedad' ? 'Enfermedad' : 
                             h.eventType === 'otro' ? 'Otro' : h.eventType || '';
        return {
          'Animal': animal ? `${animal.id} ${animal.name || ''}` : h.animalId,
          'Fecha': h.date,
          'Tipo de Evento': eventTypeText,
          'Procedimiento/Enfermedad': h.type,
          'Descripción': h.notes || ''
        };
      });
      const healthSheet = XLSX.utils.json_to_sheet(healthData);
      XLSX.utils.book_append_sheet(workbook, healthSheet, 'Salud');
      
      // Descargar archivo
      XLSX.writeFile(workbook, `genegan-plus-reporte-${today()}.xlsx`);
    }
    
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Título
      doc.setFontSize(20);
      doc.text('GeneGan Plus - Reporte Ganadero', 20, 20);
      doc.setFontSize(12);
      doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 20, 30);
      
      let yPosition = 50;
      
      // Resumen
      doc.setFontSize(16);
      doc.text('Resumen General', 20, yPosition);
      yPosition += 10;
      doc.setFontSize(12);
      doc.text(`Total Animales: ${store.animals.length}`, 20, yPosition);
      yPosition += 7;
      doc.text(`Total Potreros: ${store.paddocks.length}`, 20, yPosition);
      yPosition += 7;
      doc.text(`Servicios Activos: ${store.services.filter(s => {
        const birthDone = store.animals.some(a => a.motherId === s.femaleId && new Date(a.dob) > new Date(s.date));
        return !birthDone;
      }).length}`, 20, yPosition);
      yPosition += 15;
      
      // Animales
      if (store.animals.length > 0) {
        doc.setFontSize(14);
        doc.text('Animales Registrados', 20, yPosition);
        yPosition += 10;
        doc.setFontSize(10);
        
        store.animals.forEach((animal, index) => {
          if (yPosition > 250) {
            doc.addPage();
            yPosition = 20;
          }
          
          doc.text(`${animal.id} - ${animal.name || 'Sin nombre'} (${animal.breed || 'Sin raza'})`, 20, yPosition);
          yPosition += 5;
          doc.text(`Sexo: ${animal.sex} | Peso: ${animal.weights?.length ? animal.weights[animal.weights.length-1].kg + ' kg' : 'N/A'}`, 20, yPosition);
          yPosition += 7;
        });
        yPosition += 10;
      }
      
      // Potreros
      if (store.paddocks.length > 0) {
        if (yPosition > 250) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.setFontSize(14);
        doc.text('Potreros', 20, yPosition);
        yPosition += 10;
        doc.setFontSize(10);
        
        store.paddocks.forEach(paddock => {
          if (yPosition > 250) {
            doc.addPage();
            yPosition = 20;
          }
          
          doc.text(`${paddock.name} - ${paddock.area || 'N/A'} ha`, 20, yPosition);
          yPosition += 5;
          doc.text(`Pasto: ${paddock.grass || 'N/A'}`, 20, yPosition);
          yPosition += 7;
        });
      }
      
      // Descargar PDF
      doc.save(`genegan-plus-reporte-${today()}.pdf`);
    }
    function importJSON(ev){
      const file = ev.target.files?.[0]; if(!file) return;
      const fr = new FileReader();
      fr.onload = () => {
        try{ const data = JSON.parse(fr.result); if(!data.animals||!data.paddocks) throw 0; store = data; saveStore(); alert('Datos importados'); }
        catch(e){ alert('Archivo inválido'); }
        finally{ ev.target.value=''; }
      };
      fr.readAsText(file);
    }
    function resetAll(){ if(!confirm('¿Borrar todos los datos?')) return; localStorage.removeItem(KEY); loadStore(); saveStore(); }

    // Función para forzar el ocultamiento de dropdowns
    function forceHideDropdowns() {
      console.log('=== FORZANDO OCULTAMIENTO DE DROPDOWNS ===');
      
      // Método 1: Usar DropdownManager
      if (typeof dropdownManager !== 'undefined') {
        dropdownManager.hideAll();
      }
      
      // Método 2: Ocultar directamente
      const dropdowns = document.querySelectorAll('.dropdown-list');
      dropdowns.forEach(dropdown => {
        dropdown.classList.remove('active');
        dropdown.style.display = 'none';
        dropdown.style.visibility = 'hidden';
        dropdown.style.opacity = '0';
        dropdown.style.zIndex = '-1';
      });
      
      // Método 3: Usar función legacy
      hideAllDropdowns();
      
      showNotification('success', 'Dropdowns Ocultados', 'Se han ocultado todos los dropdowns usando múltiples métodos');
    }

    // Función para probar los gráficos
    function testCharts() {
      console.log('=== PRUEBA COMPLETA DE GRÁFICOS ===');
      
      // 1. Verificar ECharts
      console.log('1. Verificando ECharts...');
      if (typeof echarts !== 'undefined') {
        console.log('✅ ECharts disponible');
        console.log('  - Versión:', echarts.version);
        console.log('  - Tipo:', typeof echarts);
      } else {
        console.error('❌ ECharts NO está disponible');
        showNotification('error', 'ECharts No Disponible', 'La librería ECharts no se ha cargado');
        return;
      }
      
      // 2. Verificar contenedores
      console.log('2. Verificando contenedores...');
      const chartElements = ['weightChart', 'breedChart', 'healthChart', 'paddockChart', 'weaningChart'];
      chartElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          console.log(`✅ ${id} encontrado`);
          console.log(`  - Dimensiones: ${element.offsetWidth}x${element.offsetHeight}`);
          console.log(`  - Visible: ${element.offsetParent !== null}`);
          console.log(`  - Display: ${getComputedStyle(element).display}`);
          console.log(`  - Visibility: ${getComputedStyle(element).visibility}`);
        } else {
          console.error(`❌ ${id} NO ENCONTRADO`);
        }
      });
      
      // 3. Verificar pestaña de gráficos
      console.log('3. Verificando pestaña de gráficos...');
      const graficosTab = document.getElementById('tab-graficos');
      console.log('Pestaña gráficos:', graficosTab ? '✅ Encontrada' : '❌ NO ENCONTRADA');
      if (graficosTab) {
        console.log('  - Activa:', graficosTab.classList.contains('active'));
        console.log('  - Display:', getComputedStyle(graficosTab).display);
        console.log('  - Visibility:', getComputedStyle(graficosTab).visibility);
      }
      
      // 4. Verificar datos y crear datos de prueba si es necesario
      console.log('4. Verificando datos...');
      console.log('Animales en store:', store.animals.length);
      console.log('Potreros en store:', store.paddocks.length);
      console.log('Eventos de salud en store:', store.health.length);
      
      // Crear datos de prueba si no hay datos
      if (store.animals.length === 0) {
        console.log('📝 Creando datos de prueba para animales...');
        createTestData();
      }
      
      // 5. Intentar renderizar gráfico de prueba
      console.log('5. Intentando renderizar gráfico de prueba...');
      try {
        const testContainer = document.getElementById('weightChart');
        if (testContainer) {
          // Forzar visibilidad del contenedor
          testContainer.style.display = 'block';
          testContainer.style.visibility = 'visible';
          testContainer.style.height = '300px';
          testContainer.style.width = '100%';
          testContainer.style.border = '2px solid #16a34a';
          testContainer.style.backgroundColor = '#f0fdf4';
          testContainer.style.padding = '10px';
          
          console.log('✅ Contenedor de prueba preparado');
          
          // Crear gráfico de prueba
          const testChart = echarts.init(testContainer);
          const testOption = {
            title: { 
              text: 'Gráfico de Prueba - ECharts Funcionando', 
              left: 'center',
              textStyle: { fontSize: 16, fontWeight: 'bold', color: '#16a34a' }
            },
            tooltip: { trigger: 'axis' },
            xAxis: { 
              type: 'category', 
              data: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo'],
              axisLabel: { color: '#374151' }
            },
            yAxis: { 
              type: 'value',
              name: 'Valor',
              axisLabel: { color: '#374151' }
            },
            series: [{ 
              data: [120, 200, 150, 80, 70], 
              type: 'bar',
              itemStyle: { color: '#16a34a' },
              name: 'Datos de Prueba'
            }]
          };
          
          testChart.setOption(testOption);
          console.log('✅ Gráfico de prueba renderizado correctamente');
          showNotification('success', 'Gráfico de Prueba', 'Se renderizó un gráfico de prueba correctamente. ECharts está funcionando.');
          
          // Intentar renderizar todos los gráficos después del éxito
          setTimeout(() => {
            console.log('🔄 Intentando renderizar todos los gráficos después del éxito...');
            renderAllCharts();
          }, 1000);
          
        } else {
          console.error('❌ No se pudo encontrar el contenedor de prueba');
          showNotification('error', 'Error de Contenedor', 'No se encontró el contenedor weightChart');
        }
      } catch (error) {
        console.error('❌ Error al renderizar gráfico de prueba:', error);
        showNotification('error', 'Error de Prueba', 'Error al renderizar gráfico de prueba: ' + error.message);
      }
      
      showNotification('info', 'Prueba de Gráficos', 'Revisa la consola para ver el diagnóstico completo');
    }
    
    // Función para crear datos de prueba
    function createTestData() {
      console.log('📝 Creando datos de prueba completos...');
      
      // Crear potreros de prueba con ubicaciones
      const testPaddocks = [
        { id: 'p1', name: 'Potrero Norte', area: 15, altitude: 1200, grass: 'Brachiaria', lat: 4.5709, lng: -74.2973 },
        { id: 'p2', name: 'Potrero Sur', area: 12, altitude: 1180, grass: 'Pasto Estrella', lat: 4.5689, lng: -74.2953 },
        { id: 'p3', name: 'Potrero Este', area: 18, altitude: 1220, grass: 'Kikuyo', lat: 4.5729, lng: -74.2993 },
        { id: 'p4', name: 'Potrero Oeste', area: 10, altitude: 1160, grass: 'Brachiaria', lat: 4.5669, lng: -74.2933 },
        { id: 'p5', name: 'Potrero Central', area: 20, altitude: 1200, grass: 'Pasto Estrella', lat: 4.5709, lng: -74.2973 },
        { id: 'p6', name: 'Potrero Alto', area: 8, altitude: 1250, grass: 'Kikuyo', lat: 4.5749, lng: -74.3013 }
      ];
      
      // Crear animales de prueba incluyendo hembras próximas a parir
      const testAnimals = [
        { id: 'a1', name: 'Luna', breed: 'Brahman', sex: 'Hembra', dob: '2020-03-15', paddleId: 'p1', notes: 'Vaca reproductora principal - Próxima a parir', weights: [{ date: '2024-01-15', kg: 450 }, { date: '2024-02-15', kg: 460 }], motherId: 'a5', fatherId: 'a6' },
        { id: 'a2', name: 'Sol', breed: 'Angus', sex: 'Macho', dob: '2019-08-20', paddleId: 'p2', notes: 'Toro reproductor', weights: [{ date: '2024-01-15', kg: 750 }, { date: '2024-02-15', kg: 760 }], motherId: 'a7', fatherId: 'a8' },
        { id: 'a3', name: 'Estrella', breed: 'Gyr', sex: 'Hembra', dob: '2021-05-10', paddleId: 'p3', notes: 'Vaca joven - Próxima a parir', weights: [{ date: '2024-01-15', kg: 380 }, { date: '2024-02-15', kg: 390 }], motherId: 'a9', fatherId: 'a10' },
        { id: 'a4', name: 'Rayo', breed: 'Simental', sex: 'Macho', dob: '2020-12-03', paddleId: 'p4', notes: 'Toro joven', weights: [{ date: '2024-01-15', kg: 650 }, { date: '2024-02-15', kg: 660 }], motherId: 'a11', fatherId: 'a12' },
        { id: 'a5', name: 'Rosa', breed: 'Brahman', sex: 'Hembra', dob: '2018-06-20', paddleId: 'p5', notes: 'Vaca adulta - Próxima a parir', weights: [{ date: '2024-01-15', kg: 480 }, { date: '2024-02-15', kg: 490 }], motherId: 'a13', fatherId: 'a14' },
        { id: 'a6', name: 'Toro Bravo', breed: 'Brahman', sex: 'Macho', dob: '2017-04-12', paddleId: 'p2', notes: 'Toro reproductor principal', weights: [{ date: '2024-01-15', kg: 800 }, { date: '2024-02-15', kg: 810 }] },
        { id: 'a7', name: 'Dulce', breed: 'Angus', sex: 'Hembra', dob: '2019-02-28', paddleId: 'p1', notes: 'Vaca Angus', weights: [{ date: '2024-01-15', kg: 420 }, { date: '2024-02-15', kg: 430 }] },
        { id: 'a8', name: 'Negro', breed: 'Angus', sex: 'Macho', dob: '2018-11-15', paddleId: 'p3', notes: 'Toro Angus', weights: [{ date: '2024-01-15', kg: 780 }, { date: '2024-02-15', kg: 790 }] },
        { id: 'a9', name: 'Blanca', breed: 'Gyr', sex: 'Hembra', dob: '2020-09-05', paddleId: 'p4', notes: 'Vaca Gyr', weights: [{ date: '2024-01-15', kg: 350 }, { date: '2024-02-15', kg: 360 }] },
        { id: 'a10', name: 'Gris', breed: 'Gyr', sex: 'Macho', dob: '2019-07-18', paddleId: 'p5', notes: 'Toro Gyr', weights: [{ date: '2024-01-15', kg: 760 }, { date: '2024-02-15', kg: 770 }] },
        { id: 'a11', name: 'Mancha', breed: 'Simental', sex: 'Hembra', dob: '2021-01-25', paddleId: 'p6', notes: 'Vaca Simental', weights: [{ date: '2024-01-15', kg: 400 }, { date: '2024-02-15', kg: 410 }] },
        { id: 'a12', name: 'Dorado', breed: 'Simental', sex: 'Macho', dob: '2020-05-30', paddleId: 'p1', notes: 'Toro Simental', weights: [{ date: '2024-01-15', kg: 760 }, { date: '2024-02-15', kg: 770 }] },
        { id: 'a13', name: 'Vieja', breed: 'Brahman', sex: 'Hembra', dob: '2016-12-10', paddleId: 'p2', notes: 'Vaca veterana', weights: [{ date: '2024-01-15', kg: 500 }, { date: '2024-02-15', kg: 510 }] },
        { id: 'a14', name: 'Veterano', breed: 'Brahman', sex: 'Macho', dob: '2015-03-22', paddleId: 'p3', notes: 'Toro veterano', weights: [{ date: '2024-01-15', kg: 850 }, { date: '2024-02-15', kg: 860 }] },
        { id: 'a15', name: 'Mamá', breed: 'Brahman', sex: 'Hembra', dob: '2019-01-15', paddleId: 'p1', notes: 'Vaca que va a parir en 5 días - ¡ALERTA!', weights: [{ date: '2024-01-15', kg: 520 }, { date: '2024-02-15', kg: 530 }] }
      ];
      
      // Crear servicios de prueba (cruces) con fechas que generen alertas reales
      const today = new Date();
      const daysAgo270 = new Date(today.getTime() - (270 * 24 * 60 * 60 * 1000)); // 270 días atrás
      const daysAgo275 = new Date(today.getTime() - (275 * 24 * 60 * 60 * 1000)); // 275 días atrás
      const daysAgo280 = new Date(today.getTime() - (280 * 24 * 60 * 60 * 1000)); // 280 días atrás
      const daysAgo285 = new Date(today.getTime() - (285 * 24 * 60 * 60 * 1000)); // 285 días atrás
      
      const testServices = [
        { id: 's1', femaleId: 'a1', maleId: 'a6', date: daysAgo270.toISOString().split('T')[0], notes: 'Servicio exitoso - Parto INMINENTE (10 días)' },
        { id: 's2', femaleId: 'a3', maleId: 'a10', date: daysAgo275.toISOString().split('T')[0], notes: 'Servicio exitoso - Parto MUY PRÓXIMO (5 días)' },
        { id: 's3', femaleId: 'a5', maleId: 'a6', date: daysAgo280.toISOString().split('T')[0], notes: 'Servicio exitoso - Parto PRÓXIMO (0 días)' },
        { id: 's4', femaleId: 'a7', maleId: 'a8', date: daysAgo285.toISOString().split('T')[0], notes: 'Servicio exitoso - Parto PRÓXIMO (5 días)' },
        { id: 's5', femaleId: 'a9', maleId: 'a10', date: '2024-02-20', notes: 'Servicio programado' },
        { id: 's6', femaleId: 'a11', maleId: 'a12', date: '2024-02-25', notes: 'Servicio reciente' },
        { id: 's7', femaleId: 'a15', maleId: 'a6', date: daysAgo270.toISOString().split('T')[0], notes: 'Servicio exitoso - ¡PARTO INMINENTE EN 10 DÍAS!' }
      ];
      
      // Crear registros de salud de prueba
      const testHealth = [
        { id: 'h1', animalId: 'a1', date: '2024-01-10', type: 'Vacunación Triple', notes: 'Vacuna aplicada correctamente' },
        { id: 'h2', animalId: 'a2', date: '2024-01-15', type: 'Desparasitación Interna', notes: 'Desparasitante aplicado' },
        { id: 'h3', animalId: 'a3', date: '2024-02-01', type: 'Control de Peso', notes: 'Peso normal' },
        { id: 'h4', animalId: 'a4', date: '2024-02-05', type: 'Vacunación Antirrábica', notes: 'Vacuna antirrábica aplicada' },
        { id: 'h5', animalId: 'a5', date: '2024-01-20', type: 'Control Reproductivo', notes: 'Control de gestación' },
        { id: 'h6', animalId: 'a6', date: '2024-01-25', type: 'Palpación Rectal', notes: 'Toro en buen estado' },
        { id: 'h7', animalId: 'a7', date: '2024-02-10', type: 'Ecografía', notes: 'Ecografía reproductiva' },
        { id: 'h8', animalId: 'a8', date: '2024-02-15', type: 'Análisis de Sangre', notes: 'Análisis rutinario' }
      ];
      
      // Crear transacciones de prueba (ventas/compras)
      const testTransactions = [
        { id: 't1', type: 'venta', animalId: 'a4', date: '2024-01-15', pricePerKg: 8500, weight: 650, totalPrice: 5525000, buyerSeller: 'Juan Pérez', document: 'CC 12345678', phone: '+57 300 123 4567', notes: 'Venta de toro joven' },
        { id: 't2', type: 'compra', animalId: 'a9', date: '2024-01-20', pricePerKg: 7500, weight: 350, totalPrice: 2625000, buyerSeller: 'María González', document: 'CC 87654321', phone: '+57 300 987 6543', notes: 'Compra de vaquilla' },
        { id: 't3', type: 'venta', animalId: 'a11', date: '2024-02-01', pricePerKg: 9000, weight: 400, totalPrice: 3600000, buyerSeller: 'Carlos Rodríguez', document: 'CC 11223344', phone: '+57 300 555 6666', notes: 'Venta de vaca Simental' },
        { id: 't4', type: 'compra', animalId: 'a6', date: '2024-02-10', pricePerKg: 12000, weight: 800, totalPrice: 9600000, buyerSeller: 'Ana López', document: 'CC 55667788', phone: '+57 300 777 8888', notes: 'Compra de toro reproductor' },
        { id: 't5', type: 'venta', animalId: 'a8', date: '2024-02-15', pricePerKg: 11000, weight: 780, totalPrice: 8580000, buyerSeller: 'Roberto Silva', document: 'CC 99887766', phone: '+57 300 999 0000', notes: 'Venta de toro Angus' },
        { id: 't6', type: 'compra', animalId: 'a12', date: '2024-02-20', pricePerKg: 9500, weight: 760, totalPrice: 7220000, buyerSeller: 'Patricia Morales', document: 'CC 44332211', phone: '+57 300 111 2222', notes: 'Compra de toro Simental' }
      ];
      
      // Reemplazar todos los datos con los de prueba
      store.paddocks = testPaddocks;
      store.animals = testAnimals;
      store.services = testServices;
      store.health = testHealth;
      store.transactions = testTransactions;
      
      console.log('✅ Datos de prueba completos creados:');
      console.log(`  - ${testAnimals.length} animales (incluyendo hembras próximas a parir)`);
      console.log(`  - ${testPaddocks.length} potreros con ubicaciones`);
      console.log(`  - ${testServices.length} cruces registrados`);
      console.log(`  - ${testHealth.length} eventos de salud`);
      console.log(`  - ${testTransactions.length} transacciones de venta/compra`);
      
      saveStore();
      showNotification('success', 'Datos de Prueba Completos', 'Se han creado datos de prueba completos incluyendo animales próximos a parir, cruces, potreros y transacciones');
    }

    // Función para forzar la visualización de gráficos
    function forceShowCharts() {
      console.log('=== FORZANDO VISUALIZACIÓN DE GRÁFICOS ===');
      
      // 1. Forzar activación de la pestaña de gráficos
      const graficosTab = document.getElementById('tab-graficos');
      if (graficosTab) {
        graficosTab.style.display = 'block';
        graficosTab.style.visibility = 'visible';
        graficosTab.classList.add('active');
        graficosTab.style.position = 'relative';
        graficosTab.style.zIndex = '9999';
        console.log('✅ Pestaña de gráficos activada y forzada');
      } else {
        console.error('❌ No se encontró la pestaña de gráficos');
        showNotification('error', 'Error', 'No se encontró la pestaña de gráficos');
        return;
      }
      
      // 2. Forzar visibilidad de todos los contenedores con estilos más agresivos
      const chartContainers = ['weightChart', 'breedChart', 'healthChart', 'paddockChart', 'weaningChart'];
      chartContainers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
          container.style.display = 'block';
          container.style.visibility = 'visible';
          container.style.height = '300px';
          container.style.width = '100%';
          container.style.minHeight = '300px';
          container.style.border = '2px solid #16a34a';
          container.style.backgroundColor = '#f0fdf4';
          container.style.padding = '10px';
          container.style.margin = '10px 0';
          container.style.position = 'relative';
          container.style.zIndex = '1000';
          console.log(`✅ Contenedor ${id} forzado a ser visible con estilos`);
        } else {
          console.error(`❌ No se encontró el contenedor ${id}`);
        }
      });
      
      // 3. Verificar que ECharts esté disponible
      if (typeof echarts === 'undefined') {
        console.error('❌ ECharts no está disponible');
        showNotification('error', 'Error de Gráficos', 'La librería ECharts no se ha cargado');
        return;
      }
      
      console.log('✅ ECharts disponible, versión:', echarts.version);
      
      // 4. Renderizar gráficos con múltiples intentos
      setTimeout(() => {
        console.log('🔄 Primer intento de renderizado forzado...');
        renderAllCharts();
      }, 100);
      
      setTimeout(() => {
        console.log('🔄 Segundo intento de renderizado forzado...');
        renderAllCharts();
      }, 500);
      
      setTimeout(() => {
        console.log('🔄 Tercer intento de renderizado forzado...');
        renderAllCharts();
      }, 1000);
      
      setTimeout(() => {
        console.log('🔄 Cuarto intento de renderizado forzado...');
        renderAllCharts();
      }, 2000);
      
      showNotification('success', 'Gráficos Forzados', 'Se ha forzado la visualización de los gráficos con múltiples intentos');
    }

    // Función para probar el comportamiento de los dropdowns
    function testDropdownBehavior() {
      console.log('=== TEST DE COMPORTAMIENTO DE DROPDOWNS ===');
      
      // 1. Verificar que el DropdownManager esté funcionando
      console.log('1. Verificando DropdownManager...');
      if (typeof dropdownManager !== 'undefined') {
        console.log('✅ DropdownManager disponible');
        console.log('  - Inicializado:', dropdownManager.isInitialized);
        console.log('  - Dropdown activo:', dropdownManager.activeDropdown);
      } else {
        console.error('❌ DropdownManager NO disponible');
      }
      
      // 2. Verificar elementos de dropdown
      console.log('2. Verificando elementos de dropdown...');
      const breedInput = document.getElementById('a-breed');
      const breedDropdown = document.getElementById('breed-dropdown');
      const healthDropdown = document.getElementById('health-dropdown');
      
      console.log('Input de raza:', breedInput ? '✅ Encontrado' : '❌ NO ENCONTRADO');
      console.log('Dropdown de raza:', breedDropdown ? '✅ Encontrado' : '❌ NO ENCONTRADO');
      console.log('Dropdown de salud:', healthDropdown ? '✅ Encontrado' : '❌ NO ENCONTRADO');
      
      // 3. Simular comportamiento de usuario
      console.log('3. Simulando comportamiento de usuario...');
      
      if (breedInput && breedDropdown) {
        // Simular focus en el input
        console.log('Simulando focus en input de raza...');
        breedInput.focus();
        
        // Mostrar dropdown
        setTimeout(() => {
          console.log('Mostrando dropdown de raza...');
          dropdownManager.show(breedDropdown);
          
          // Simular click fuera después de 2 segundos
          setTimeout(() => {
            console.log('Simulando click fuera del dropdown...');
            document.body.click();
            
            // Verificar si se ocultó
            setTimeout(() => {
              const isVisible = breedDropdown.classList.contains('active') || 
                               getComputedStyle(breedDropdown).display !== 'none';
              console.log('Dropdown visible después de click fuera:', isVisible ? '❌ NO SE OCULTÓ' : '✅ SE OCULTÓ CORRECTAMENTE');
              
              if (isVisible) {
                console.log('⚠️ PROBLEMA: El dropdown no se ocultó correctamente');
                showNotification('warning', 'Problema Detectado', 'El dropdown no se ocultó correctamente. Revisa la consola.');
              } else {
                console.log('✅ Comportamiento correcto');
                showNotification('success', 'Comportamiento Correcto', 'El dropdown se ocultó correctamente');
              }
            }, 100);
          }, 2000);
        }, 500);
      }
      
      showNotification('info', 'Test de Comportamiento', 'Se está ejecutando el test de comportamiento. Revisa la consola.');
    }
    
    // Función para activar directamente la pestaña de gráficos
    function activateChartsTab() {
      console.log('=== ACTIVANDO PESTAÑA DE GRÁFICOS DIRECTAMENTE ===');
      
      // Ocultar todas las pestañas
      const allTabs = document.querySelectorAll('.tab');
      allTabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
      });
      
      // Desactivar todos los botones de navegación
      const allNavButtons = document.querySelectorAll('.nav-button');
      allNavButtons.forEach(btn => btn.classList.remove('active'));
      
      // Activar la pestaña de gráficos
      const graficosTab = document.getElementById('tab-graficos');
      const graficosButton = document.querySelector('.nav-button[onclick*="tab-graficos"]');
      
      if (graficosTab && graficosButton) {
        graficosTab.classList.add('active');
        graficosTab.style.display = 'block';
        graficosTab.style.visibility = 'visible';
        graficosButton.classList.add('active');
        
        console.log('✅ Pestaña de gráficos activada directamente');
        showNotification('success', 'Pestaña Activada', 'Se ha activado la pestaña de gráficos');
        
        // Forzar renderizado de gráficos
        setTimeout(() => {
          console.log('🔄 Renderizando gráficos después de activación...');
          forceShowCharts();
        }, 100);
        
      } else {
        console.error('❌ No se pudo activar la pestaña de gráficos');
        showNotification('error', 'Error', 'No se pudo activar la pestaña de gráficos');
      }
    }

    // Función de diagnóstico completo para gráficos
    function diagnosticCharts() {
      console.log('=== DIAGNÓSTICO COMPLETO DE GRÁFICOS ===');
      
      // 1. Verificar ECharts
      console.log('1️⃣ Verificando ECharts...');
      if (typeof echarts === 'undefined') {
        console.error('❌ ECharts NO está disponible');
        alert('❌ ERROR: ECharts no está disponible. Verifica tu conexión a internet.');
        return;
      }
      console.log('✅ ECharts disponible - Versión:', echarts.version);
      
      // 2. Verificar pestaña de gráficos
      console.log('2️⃣ Verificando pestaña de gráficos...');
      const graficosTab = document.getElementById('tab-graficos');
      if (!graficosTab) {
        console.error('❌ Pestaña de gráficos NO encontrada');
        alert('❌ ERROR: Pestaña de gráficos no encontrada');
        return;
      }
      console.log('✅ Pestaña de gráficos encontrada');
      console.log('   - Display:', getComputedStyle(graficosTab).display);
      console.log('   - Visibility:', getComputedStyle(graficosTab).visibility);
      console.log('   - Active:', graficosTab.classList.contains('active'));
      
      // 3. Verificar contenedores de gráficos
      console.log('3️⃣ Verificando contenedores de gráficos...');
      const chartContainers = ['weightChart', 'breedChart', 'healthChart', 'paddockChart', 'weaningChart'];
      chartContainers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
          const style = getComputedStyle(container);
          console.log(`✅ ${id}: ${container.offsetWidth}x${container.offsetHeight} - Display: ${style.display} - Visibility: ${style.visibility}`);
        } else {
          console.error(`❌ ${id}: NO ENCONTRADO`);
        }
      });
      
      // 4. Verificar datos
      console.log('4️⃣ Verificando datos...');
      console.log('   - Animales:', store.animals.length);
      console.log('   - Potreros:', store.paddocks.length);
      console.log('   - Salud:', store.health.length);
      
      // 5. Intentar renderizar un gráfico de prueba
      console.log('5️⃣ Intentando renderizar gráfico de prueba...');
      try {
        const testContainer = document.getElementById('weightChart');
        if (testContainer) {
          // Forzar visibilidad
          testContainer.style.display = 'block';
          testContainer.style.visibility = 'visible';
          testContainer.style.height = '300px';
          testContainer.style.width = '100%';
          
          // Crear gráfico de prueba
          const testChart = echarts.init(testContainer);
          const testOption = {
            title: { text: 'Test - ECharts Funciona', left: 'center' },
            xAxis: { type: 'category', data: ['Test1', 'Test2', 'Test3'] },
            yAxis: { type: 'value' },
            series: [{ type: 'bar', data: [10, 20, 30] }]
          };
          testChart.setOption(testOption);
          console.log('✅ Gráfico de prueba renderizado exitosamente');
          
          // Verificar canvas
          setTimeout(() => {
            const canvas = testContainer.querySelector('canvas');
            if (canvas) {
              console.log('✅ Canvas encontrado - ECharts funciona correctamente');
              alert('✅ DIAGNÓSTICO EXITOSO: ECharts funciona correctamente. Los gráficos deberían aparecer.');
            } else {
              console.error('❌ Canvas no encontrado');
              alert('❌ ERROR: Canvas no encontrado. ECharts no se está renderizando correctamente.');
            }
          }, 1000);
        } else {
          console.error('❌ Contenedor de prueba no encontrado');
          alert('❌ ERROR: Contenedor de prueba no encontrado');
        }
      } catch (error) {
        console.error('❌ Error en gráfico de prueba:', error);
        alert(`❌ ERROR: ${error.message}`);
      }
    }
  </script>
</body>
</html>
